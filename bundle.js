(()=>{"use strict";var __webpack_modules__={680:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{eval("// ESM COMPAT FLAG\n__webpack_require__.r(__webpack_exports__);\n\n;// CONCATENATED MODULE: ./src/const.ts\nconst constants = {\n    scale: 8,\n    paces: {\n        \"4\": 4,\n        \"2\": 2,\n        \"1\": 1,\n        \"0.5\": 0.5,\n        \"0.25\": 0.25\n    },\n    plant_template_ids: [\n        \"basic_plant\",\n        \"yellow_dip\",\n        \"blue_haze\",\n        \"red_quartz\"\n    ]\n};\n/* harmony default export */ const src_const = (constants);\n\n;// CONCATENATED MODULE: ./src/Vector.ts\nclass Vector {\n    constructor(x, y) {\n        this.x = x;\n        this.y = y;\n    }\n    add(v) {\n        return new Vector(this.x + v.x, this.y + v.y);\n    }\n    divide(n) {\n        return new Vector(this.x / n, this.y / n);\n    }\n}\n\n;// CONCATENATED MODULE: ./src/util.ts\n\n\nfunction rangeOverlap(x1, x2, y1, y2) {\n    return Math.max(0, Math.min(x2, y2) - Math.max(x1, y1) + 1);\n}\nfunction secondsToTime(secs) {\n    var hours = Math.floor(secs / (60 * 60));\n    var divisor_for_minutes = secs % (60 * 60);\n    var minutes = Math.floor(divisor_for_minutes / 60);\n    var divisor_for_seconds = divisor_for_minutes % 60;\n    var seconds = Math.ceil(divisor_for_seconds);\n    var obj = {\n        \"h\": hours,\n        \"m\": minutes,\n        \"s\": seconds\n    };\n    return obj;\n}\nfunction humanReadableTime(time) {\n    const hours_str = time.h > 0 ? `${time.h} ${time.h == 1 ? 'hour' : 'hours'}` : null;\n    const mins_str = time.m > 0 ? `${time.m} ${time.m == 1 ? 'minute' : 'minutes'}` : null;\n    const seconds_str = time.s > 0 ? `${time.s} ${time.s == 1 ? 'second' : 'seconds'}` : null;\n    const arr = [hours_str, mins_str, seconds_str].filter(str => str != null);\n    return arr.join(', ');\n}\nfunction humanReadableTimeFromSeconds(seconds) {\n    const time = secondsToTime(seconds);\n    return humanReadableTime(time);\n}\nfunction getViewportCenter() {\n    return new Vector(window.innerWidth / 2 / src_const.scale, window.innerHeight / 2 / src_const.scale);\n}\nfunction getTemplateMaxStageIndex(template) {\n    return template.stages.length - 1;\n}\nfunction getPlantImageID(plant_id, stage) {\n    return 'images/' + plant_id + '/' + stage;\n}\nfunction getPlantImageBloblID(plant_id, stage) {\n    return 'image_blobs/' + plant_id + '/' + stage;\n}\nfunction getTemplateResourceID(template_id) {\n    return 'templates/' + template_id;\n}\nfunction getPlantTemplateFullyGrownImageURL(plant_template) {\n    const max_stage = plant_template.stages.length - 1;\n    return plant_template.stages[max_stage].image_url;\n}\nfunction getTemplateUnlock(template_id, all_templates) {\n    const unlock_id = all_templates[template_id].unlocks;\n    return all_templates[unlock_id];\n}\n/**\n * Get the maximum units of growth a plant can grow to\n */\nfunction getTemplateMaxGrowth(plant_template) {\n    const max_stage_index = getTemplateMaxStageIndex(plant_template);\n    return plant_template.stages[max_stage_index].at_growth * plant_template.multiplier;\n}\n/**\n * Get the plants max water index\n * @param plant_template\n */\nfunction getTemplateMaxWaterIndex(plant_template) {\n    return plant_template.water_level.stages.length - 1;\n}\n/**\n * Get plant's max water level\n */\nfunction getTemplateMaxWaterStage(plant_template) {\n    const max_index = getTemplateMaxWaterIndex(plant_template);\n    return plant_template.water_level.stages[max_index];\n}\n/**\n * Get the growth rate of a plant at max water level\n */\nfunction getTemplateMaxGrowthRate(plant_template) {\n    const max_water_level = getTemplateMaxWaterStage(plant_template);\n    return max_water_level.growth_rate * plant_template.multiplier;\n}\n/**\n * Time it takes to grow a plant if its is at max water stage\n */\nfunction templateTimeToGrow(plant_template, seconds_per_tick) {\n    const max_growth = getTemplateMaxGrowth(plant_template);\n    const max_growth_rate = getTemplateMaxGrowthRate(plant_template);\n    return max_growth * plant_template.multiplier / max_growth_rate * seconds_per_tick;\n}\n/**\n * How often a plant's water level runs out, in seconds\n *\n */\nfunction templateWateringFrequency(plant_template, seconds_per_tick) {\n    const water_decrease_rate = plant_template.water_level.decrease_rate * plant_template.multiplier;\n    return 100 / water_decrease_rate * seconds_per_tick;\n}\n\n;// CONCATENATED MODULE: ./src/ImageLoader.ts\nvar __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\n\nclass ImageLoader {\n    constructor(cache) {\n        this.cache = cache;\n    }\n    loadTemplateImageIfNull(plant_id, stage) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const res_id = getPlantImageID(plant_id, stage);\n            if (!this.cache.has(res_id)) {\n                try {\n                    const img_url = './images/' + plant_id + '/' + plant_id + '_' + stage + '.png';\n                    const img_res = yield fetch(img_url);\n                    const img_data = yield img_res.blob();\n                    const image = yield createImageBitmap(img_data);\n                    const blob_id = getPlantImageBloblID(plant_id, stage);\n                    this.cache.set(res_id, image);\n                    this.cache.set(blob_id, img_data);\n                }\n                catch (e) {\n                    throw new Error('Could not load image: ' + e.message);\n                }\n            }\n        });\n    }\n}\n\n;// CONCATENATED MODULE: ./src/MyCache.ts\nclass MyCache {\n    constructor() {\n        this.items = {};\n    }\n    set(id, value) {\n        if (id in this.items) {\n            throw new Error('Cache: Could not store item by id ' + id + ': id already taken');\n        }\n        this.items[id] = value;\n    }\n    get(id) {\n        if (!(id in this.items)) {\n            throw new Error('Cache: Could not find item by id ' + id);\n        }\n        return this.items[id];\n    }\n    has(id) {\n        return (id in this.items);\n    }\n}\n\n;// CONCATENATED MODULE: ./src/MyStorage.ts\nclass MyStorage {\n    constructor() {\n        this.prefix = 'pixel-plant:';\n    }\n    get(key) {\n        return JSON.parse(localStorage.getItem(this.prefix + key));\n    }\n    set(key, value) {\n        localStorage.setItem(this.prefix + key, JSON.stringify(value));\n    }\n    has(key) {\n        return !!localStorage.getItem(this.prefix + key);\n    }\n    remove(key) {\n        localStorage.removeItem(key);\n    }\n}\n\n;// CONCATENATED MODULE: ./src/GameObject.ts\n\nclass GameObject {\n    constructor(position = new Vector(0, 0)) {\n        this.position = position;\n    }\n}\n\n;// CONCATENATED MODULE: ./src/Rect.ts\n\nclass Rect {\n    constructor(position = new Vector(0, 0), size = new Vector(0, 0)) {\n        this.size = size;\n        this.position = position;\n    }\n    calculateBounds() {\n        this.left = this.position.x - this.size.x / 2;\n        this.right = this.position.x + this.size.x / 2;\n        this.top = this.position.y - this.size.y / 2;\n        this.bottom = this.position.y - this.size.y / 2;\n    }\n    setPosition(v) {\n        this.position = v;\n        this.calculateBounds();\n    }\n}\n\n;// CONCATENATED MODULE: ./src/ProgressBar.ts\n\nclass ProgressBar extends Rect {\n    constructor(rect, options) {\n        super(rect.position, rect.size);\n        Object.assign(this, options);\n    }\n}\n//export default ProgressBar\n\n;// CONCATENATED MODULE: ./src/Sprite.ts\n\n\nclass Sprite extends GameObject {\n    constructor(image, position) {\n        super(position);\n        this.image = image;\n        this.width = image.width;\n        this.height = image.height;\n    }\n    getCenter(scale = 1) {\n        return this.position.divide(scale).add(new Vector(-this.width / 2, -this.height / 2));\n    }\n}\n\n;// CONCATENATED MODULE: ./src/WaterLevel.ts\nclass WaterLevel {\n    constructor(decrease_rate = 0.5, stages = []) {\n        this.stages = stages;\n        this.current = 100;\n        this.decrease_rate = decrease_rate;\n        this.validateStages();\n        this.calcCurrentStage();\n    }\n    validateStages() {\n        for (let a = 0; a < this.stages.length; a++) {\n            const stage_a = this.stages[a - 1];\n            const stage_b = this.stages[a];\n            const stage_c = this.stages[a + 1];\n            let valid;\n            if (this.stages.length == 1) {\n                valid = stage_b.from == 0 && stage_b.to == 100;\n            }\n            else if (a == 0) {\n                valid = stage_b.from == 0 && stage_b.to == stage_c.from;\n            }\n            else if (a != this.stages.length - 1) {\n                valid = stage_a.to == stage_b.from && stage_b.to == stage_c.from;\n            }\n            else {\n                valid = stage_b.from == stage_a.to && stage_b.to == 100;\n            }\n            if (!valid) {\n                throw new Error('Invalid water level');\n            }\n        }\n    }\n    calcCurrentStage() {\n        for (let i = 0; i < this.stages.length; i++) {\n            const stage = this.stages[i];\n            if (this.current <= stage.to && this.current >= stage.from) {\n                this.current_stage = i;\n                return;\n            }\n        }\n        throw new Error('Error calculating water current stage');\n    }\n    getCurrentStage() {\n        return this.stages[this.current_stage];\n    }\n    decreaseByTicks(ticks) {\n        this.current = Math.max(0, this.current - this.decrease_rate * ticks);\n        this.calcCurrentStage();\n    }\n    decrease() {\n        this.decreaseByTicks(1);\n    }\n    set(current) {\n        this.current = current;\n        this.calcCurrentStage();\n    }\n    top() {\n        this.set(100);\n    }\n    static fromTemplate(template) {\n        const stages = [];\n        const multiplier = template.multiplier;\n        template.water_level.stages.forEach((stage) => {\n            stages.push(Object.assign(Object.assign({}, stage), { growth_rate: stage.growth_rate * multiplier }));\n        });\n        return new WaterLevel(template.water_level.decrease_rate * multiplier, stages);\n    }\n}\n\n;// CONCATENATED MODULE: ./src/Plant.ts\nvar Plant_awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\n\n\n\n\n\n\n\nclass Plant extends GameObject {\n    constructor(id, options) {\n        super();\n        this.water_level = new WaterLevel(0.5, [\n            {\n                from: 0,\n                to: 100,\n                growth_rate: 4\n            },\n        ]);\n        this.current_stage = 0;\n        this.growth = 0;\n        this.position = new Vector(0, 0);\n        this.size = new Vector(16, 32);\n        this.id = id;\n        Object.assign(this, options);\n        this.initWaterLevelBar();\n        this.setPosition(getViewportCenter());\n    }\n    initWaterLevelBar() {\n        const dividers = this.water_level.stages.map(stage => stage.to);\n        dividers.pop();\n        this.water_level_bar = new ProgressBar(new Rect(new Vector(0, 0), new Vector(20, 2)), {\n            bg_color: '#0008FF42',\n            color: '#0008FFAD',\n            divider_color: 'darkblue',\n            direction: 'right',\n            current: 0,\n            dividers\n        });\n        this.water_level_bar.current = this.water_level.current;\n    }\n    maxGrowth() {\n        return this.stages[this.stages.length - 1].at_growth;\n    }\n    isFullyGrown() {\n        return this.growth > this.maxGrowth();\n    }\n    toJSON() {\n        return {\n            id: this.id,\n            plant_id: this.plant_id,\n            name: this.name,\n            water_level_current: this.water_level.current,\n            growth: this.growth,\n            fully_grown_called: this.fully_grown_called\n        };\n    }\n    onFullyGrown(callback) {\n        this.fully_grown_cb = callback;\n    }\n    static fromJSON(json, cache) {\n        return Plant_awaiter(this, void 0, void 0, function* () {\n            const plant = yield Plant.fromTemplate(json.id, json.plant_id, cache);\n            plant.name = json.name;\n            plant.water_level.set(json.water_level_current);\n            plant.setGrowth(json.growth);\n            plant.fully_grown_called = json.fully_grown_called;\n            return plant;\n        });\n    }\n    static stagesFromTemplate(template, cache) {\n        return Plant_awaiter(this, void 0, void 0, function* () {\n            const plant_stages = [];\n            const multiplier = template.multiplier;\n            for (let i = 0; i < template.stages.length; i++) {\n                const res_id = getPlantImageID(template.plant_id, i);\n                const image = cache.get(res_id);\n                //Plant data\n                const sprite = new Sprite(image);\n                const at_growth = template.stages[i].at_growth * multiplier;\n                plant_stages.push({\n                    sprite,\n                    at_growth\n                });\n            }\n            return plant_stages;\n        });\n    }\n    static fromTemplate(id, template_id, cache) {\n        return Plant_awaiter(this, void 0, void 0, function* () {\n            const res_id = getTemplateResourceID(template_id);\n            if (!cache.has(res_id)) {\n                const template_res = yield fetch('./plant_templates/' + template_id + '.json');\n                const template = yield template_res.json();\n                cache.set(res_id, template);\n            }\n            const template = cache.get(res_id);\n            const stages = yield Plant.stagesFromTemplate(template, cache);\n            const water_level = WaterLevel.fromTemplate(template);\n            const options = {\n                plant_id: template.plant_id,\n                water_level,\n                name: 'My Plant',\n                stages,\n                unlocks: template.unlocks\n            };\n            return new Plant(id, options);\n        });\n    }\n    calculateCurrentStage() {\n        const stage_indexes = this.stages.map((stage, index) => index);\n        var curr_stage_index = stage_indexes.reduce((a, i) => {\n            const prev_stage = this.stages[a];\n            const curr_stage = this.stages[i];\n            let is_growth_in_curr_stage = curr_stage.at_growth > prev_stage.at_growth && this.growth > curr_stage.at_growth;\n            if (is_growth_in_curr_stage) {\n                return i;\n            }\n            else {\n                return a;\n            }\n        });\n        this.current_stage = curr_stage_index;\n    }\n    growBy(added_growth) {\n        this.growth += added_growth;\n        this.calculateCurrentStage();\n        if (this.isFullyGrown() && this.fully_grown_cb && !this.fully_grown_called) {\n            this.fully_grown_cb(this);\n            this.fully_grown_called = true;\n        }\n    }\n    /**\n     * Grows plant by 1 tick\n     */\n    grow() {\n        let growth_rate = 0;\n        if (this.water_level.current > 0) {\n            growth_rate = this.water_level.getCurrentStage().growth_rate;\n        }\n        this.growBy(growth_rate);\n    }\n    setGrowth(growth) {\n        this.growth = growth;\n        this.calculateCurrentStage();\n    }\n    getCurrentStage() {\n        return this.stages[this.current_stage];\n    }\n    fastForward(ticks) {\n        const water_end = this.water_level.current;\n        this.water_level.decreaseByTicks(ticks);\n        const water_start = this.water_level.current;\n        let added_growth = 0;\n        for (let i = 0; i < this.water_level.stages.length; i++) {\n            const water_stage = this.water_level.stages[i];\n            const growt_rate = water_stage.growth_rate;\n            const overlap = rangeOverlap(water_start, water_end, water_stage.from, water_stage.to);\n            added_growth += (overlap / this.water_level.decrease_rate) * growt_rate;\n        }\n        this.growBy(added_growth);\n    }\n    tick() {\n        this.grow();\n        //this.water_level.decrease();\n        this.decreaseWaterLevel();\n    }\n    decreaseWaterLevelByTicks(ticks) {\n        this.water_level.decreaseByTicks(ticks);\n        this.updateWaterLevelBar();\n    }\n    decreaseWaterLevel() {\n        this.decreaseWaterLevelByTicks(1);\n    }\n    updateWaterLevelBar() {\n        this.water_level_bar.current = this.water_level.current;\n    }\n    setPosition(p) {\n        this.position = p;\n        for (let i = 0; i < this.stages.length; i++) {\n            this.stages[i].sprite.position = this.position;\n        }\n        this.water_level_bar.setPosition(new Vector(this.position.x, this.getRect().bottom + 2));\n    }\n    getRect() {\n        return {\n            top: this.position.y - this.size.y / 2,\n            bottom: this.position.y + this.size.y / 2,\n            left: this.position.x - this.size.x / 2,\n            right: this.position.x + this.size.x / 2\n        };\n    }\n}\n\n;// CONCATENATED MODULE: ./src/Renderer.ts\n\n\nclass Renderer {\n    constructor(canvas_id, ui_id, menu_id) {\n        this.scale = src_const.scale;\n        this.menus = {};\n        this.menu = null;\n        this.canvas = document.getElementById(canvas_id);\n        this.ui = document.getElementById(ui_id);\n        this.menu_element = document.getElementById(menu_id);\n        if (!this.canvas) {\n            throw new Error('Could not find canvas element by id ' + canvas_id);\n        }\n        window.addEventListener('resize', (e) => {\n            this.calculateCanvasSize();\n        });\n        this.ctx = this.canvas.getContext('2d');\n        this.calculateCanvasSize();\n    }\n    calculateCanvasSize() {\n        this.canvas.width = window.innerWidth;\n        this.canvas.height = window.innerHeight;\n        this.ctx.scale(this.scale, this.scale);\n        this.ctx.imageSmoothingEnabled = false;\n    }\n    clear() {\n        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\n    }\n    scaledPosition(pos) {\n        return pos.divide(this.scale);\n    }\n    drawSprite(sprite) {\n        const pos = sprite.position.add(new Vector(-sprite.width / 2, -sprite.height / 2)); //sprite.getCenter(this.scale)\n        this.ctx.drawImage(sprite.image, pos.x, pos.y);\n    }\n    drawRect(rect, color) {\n        this.ctx.fillStyle = color;\n        this.ctx.fillRect(rect.left, rect.top, rect.size.x, rect.size.y);\n    }\n    drawLine(from, to, color) {\n        this.ctx.strokeStyle = color;\n        this.ctx.beginPath();\n        this.ctx.moveTo(from.x, from.y);\n        this.ctx.lineTo(to.x, to.y);\n        this.ctx.stroke();\n    }\n    currentMenu() {\n        return document.getElementById(this.menu);\n    }\n    drawProgressBar(progress_bar) {\n        const { position, size } = progress_bar;\n        const { x, y } = position;\n        const { x: width, y: height } = size;\n        const left = x - width / 2;\n        const top = y - height / 2;\n        this.drawRect(progress_bar, progress_bar.bg_color);\n        this.ctx.fillStyle = progress_bar.color;\n        const new_rect = structuredClone(progress_bar);\n        if (progress_bar.direction == 'right') {\n            new_rect.size.x = progress_bar.current / 100 * progress_bar.size.x;\n            this.drawRect(new_rect, progress_bar.color);\n            const bar_length = new_rect.right - new_rect.left;\n            const y = new_rect.position.y - 1;\n            const end_y = new_rect.bottom + 2;\n            for (const divider of progress_bar.dividers) {\n                const x = new_rect.position.x - (bar_length / 2) + bar_length / 100 * divider;\n                const pos1 = new Vector(x, y);\n                const pos2 = new Vector(x, end_y);\n                this.drawLine(pos1, pos2, progress_bar.divider_color);\n            }\n        }\n        else {\n            throw new Error('Progress bar rendering only implemented for right direction');\n        }\n    }\n    drawPlant(plant) {\n        this.drawSprite(plant.getCurrentStage().sprite);\n        this.drawProgressBar(plant.water_level_bar);\n        //this.drawSprite\n    }\n    addMenu(menu, menu_id) {\n        if (menu_id) {\n            menu.id = menu_id + '-menu';\n        }\n        menu.classList.add('menu');\n        document.getElementById('menus').appendChild(menu);\n        this.menus[menu_id] = menu;\n    }\n    showMenu(menu_id) {\n        this.ui.style.display = 'none';\n        this.menu_element.style.display = 'flex';\n        this.hideMenu();\n        const menu = document.getElementById(menu_id + '-menu');\n        if (!menu) {\n            throw new Error('Could not find menu with ID ' + menu_id);\n        }\n        menu.style.display = 'flex';\n        this.menu_element.style.display = 'flex';\n        this.hideUI();\n        //this.menu_element.replaceWith(this.menu)\n    }\n    hideUI() {\n        this.ui.style.display = 'none';\n        this.canvas.style.display = 'none';\n    }\n    showUI() {\n        this.ui.style.display = 'block';\n        this.canvas.style.display = 'flex';\n    }\n    hideMenu() {\n        Object.keys(this.menus).forEach(menu_id => {\n            document.getElementById(menu_id + '-menu').style.display = 'none';\n        });\n        this.menu_element.style.display = 'none';\n        this.showUI();\n    }\n}\n\n;// CONCATENATED MODULE: ./src/MyEvent.ts\nclass MyEvent {\n    constructor() {\n        this.max_id = 0;\n        this.callbacks = {};\n    }\n    on(cb) {\n        this.callbacks[this.max_id++] = cb;\n        return this.max_id;\n    }\n    off(id) {\n        delete this.callbacks[id];\n    }\n    emit(...args) {\n        for (const key in this.callbacks) {\n            this.callbacks[key](...args);\n        }\n    }\n}\n\n;// CONCATENATED MODULE: ./src/main_events.ts\n\nconst main_events = {\n    on_request_plant_new_plant: new MyEvent(),\n    on_request_water_plant: new MyEvent(),\n    on_request_fast_forward: new MyEvent(),\n    on_request_show_menu: new MyEvent(),\n    on_request_set_view: new MyEvent(),\n    on_request_data_reset: new MyEvent(),\n    on_request_data_save: new MyEvent(),\n    after_data_reset: new MyEvent(),\n    on_fast_forward: new MyEvent()\n};\n/* harmony default export */ const src_main_events = (main_events);\n\n;// CONCATENATED MODULE: ./src/globals.ts\nconst globals = {\n    seconds_per_tick: 1,\n    recently_unlocked: 'basic_plant'\n};\n/* harmony default export */ const src_globals = (globals);\n\n;// CONCATENATED MODULE: ./src/UIManager.ts\nvar UIManager_awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\n\n\n\n\nclass UIManager {\n    constructor(renderer) {\n        //game: Game;\n        this.button = document.createElement('button');\n        this.menu = document.createElement('div');\n        this.plant_buttons = [];\n        this.plant_image = document.createElement('img');\n        this.plant_name = document.createElement('h2');\n        this.plant_description = document.createElement('p');\n        this.plant_stages = document.createElement('li');\n        this.plant_time_to_grow = document.createElement('li');\n        this.plant_water_frequency = document.createElement('li');\n        this.tabbable_elements = [];\n        this.current_tab_index = 0;\n        this.collection_images = {};\n        this.renderer = renderer;\n        this.button.classList.add('button');\n        this.menu.classList.add('menu');\n        const NAV_UP = 'ArrowUp';\n        const NAV_DOWN = 'ArrowDown';\n        document.addEventListener('keydown', (e) => {\n            // Keyboard navigation\n            if (e.code == NAV_UP) {\n                e.preventDefault();\n                this.navigateUp();\n            }\n            else if (e.code == NAV_DOWN) {\n                e.preventDefault();\n                this.navigateDown();\n            }\n        });\n    }\n    /**\n     * Keyboard navigation\n     */\n    navigateUp() {\n        let reference_index = this.current_tab_index;\n        const indices_above = this.getIndexes('above', reference_index);\n        if (indices_above.length == 0) {\n            reference_index = this.getMaxIndex() + 1;\n        }\n        const closest_index = this.getClosetIndex(reference_index, this.getIndexes('above', reference_index));\n        this.navigateToIndex(closest_index);\n    }\n    navigateDown() {\n        let reference_index = this.current_tab_index;\n        const indices_below = this.getIndexes('below', reference_index);\n        if (indices_below.length == 0) {\n            reference_index = 0;\n        }\n        const closest_index = this.getClosetIndex(reference_index, this.getIndexes('below', reference_index));\n        this.navigateToIndex(closest_index);\n    }\n    getMaxIndex() {\n        return Math.max(...this.getIndexes('all'));\n    }\n    /**\n     * Returns array of indices for visible tabbable elements\n     * @param direction\n     * @param reference_index\n     * @returns\n     */\n    getIndexes(direction = 'all', reference_index = null) {\n        let indices_all = null;\n        const visible_elements = this.getVisibleElements();\n        if (direction == 'all') {\n            indices_all = visible_elements.map((element) => element.tabIndex);\n        }\n        else if (typeof reference_index == 'number') {\n            indices_all = visible_elements.filter(element => {\n                return direction == 'below' ? element.tabIndex > reference_index : element.tabIndex < reference_index;\n            }).map((element) => element.tabIndex);\n        }\n        else {\n            throw new Error(`If direction isn't 'all', reference_index must be specified`);\n        }\n        return indices_all;\n    }\n    isElementVisible(element) {\n        return element.offsetParent != null;\n    }\n    getVisibleElements() {\n        return this.tabbable_elements.filter((elem) => this.isElementVisible(elem));\n    }\n    getElementByIndex(index) {\n        return this.getVisibleElements().find(elem => elem.tabIndex == index);\n    }\n    getClosetIndex(reference_index, from) {\n        if (from.length == 1) {\n            return from[0];\n        }\n        return from.reduce((a, b) => {\n            //const a = parseInt(a_str);\n            //const b = parseInt(b_str);\n            return Math.abs(b - reference_index) < Math.abs(a - reference_index) ? b : a;\n        });\n    }\n    navigateToIndex(index) {\n        const target_elem = this.getElementByIndex(index);\n        this.current_tab_index = index;\n        target_elem.focus();\n    }\n    initGameUI() {\n        // Game UI\n        // water_button.innerHTML = 'Water Plant'\n        // water_button.style.position = 'absolute'\n        // water_button.style.top = '140px'\n        // water_button.style.left = '50%';\n        // water_button.style.transform = 'translateX(-50%)'\n        // water_button.tabIndex = 4;\n        //Back button\n        const back_button = this.createLinkButton('Back', 'main', 'button-tl', 1);\n        this.water_button = this.createButton('Water Plant', 'water-button', 2);\n        const water_button = this.water_button;\n        //Progress message\n        const progress_message_container = document.createElement('div');\n        this.progress_message_container = progress_message_container;\n        progress_message_container.classList.add('progress-message');\n        // progress_message_container.tabIndex = 0;\n        const progress_message_bottom = document.createElement('div');\n        progress_message_bottom.classList.add('progress-message-bottom');\n        this.progress_message = document.createElement('p');\n        const progress_message = this.progress_message;\n        progress_message.innerHTML = 'You were away for n hours n minutes and your plant has grown by x %';\n        const dismiss_button = this.createButton('Dismiss', 'menu-button', 3, () => {\n            progress_message_container.style.display = 'none';\n        });\n        this.progress_message_plant = this.createButton('Plant', 'menu-button', 4);\n        this.progress_message_plant.classList.add('small-button');\n        this.progress_message_plant.innerHTML = 'Plant';\n        progress_message_container.appendChild(progress_message);\n        progress_message_container.appendChild(progress_message_bottom);\n        progress_message_bottom.appendChild(dismiss_button);\n        progress_message_bottom.appendChild(this.progress_message_plant);\n        /**\n         * Have to use mousedown instead of click here because otherwise the progress\n         * message container loses focus before the click event is fired\n         */\n        this.progress_message_plant.addEventListener('mousedown', () => {\n            progress_message_container.style.display = 'none';\n            src_main_events.on_request_plant_new_plant.emit(src_globals.recently_unlocked);\n        });\n        // progress_message_container.addEventListener('focusout', () => {\n        //     progress_message_container.style.display = 'none'\n        // })\n        water_button.addEventListener('click', () => {\n            src_main_events.on_request_water_plant.emit();\n            //this.game.waterCurrentPlant()\n        });\n        this.renderer.ui.appendChild(water_button);\n        this.renderer.ui.appendChild(back_button);\n        this.renderer.ui.appendChild(progress_message_container);\n    }\n    initMainMenu(is_new_game) {\n        //Main menu\n        //Play button\n        this.play_button = this.createViewButton(is_new_game ? 'New Game' : 'My Plant', 'plant', 'menu-button', 1, () => {\n            src_main_events.on_request_fast_forward.emit();\n            //this.game.fastForwardBySeconds(this.game.getTimeAway())\n        });\n        //Collection button\n        const collection_button = this.createLinkButton('Collection', 'collection', 'menu-button', 2);\n        //Help button\n        const help_button = this.createLinkButton('Help', 'help', 'menu-button', 3);\n        //Options button\n        const options_button = this.createLinkButton('Options', 'options', 'menu-button', 4);\n        this.main_menu = this.createMenu();\n        this.main_menu.appendChild(this.play_button);\n        this.main_menu.appendChild(collection_button);\n        this.main_menu.appendChild(help_button);\n        this.main_menu.appendChild(options_button);\n        this.renderer.addMenu(this.main_menu, 'main');\n    }\n    initOptionsMenu() {\n        //Options menu\n        const options_menu = this.createMenu();\n        const pace_selector = document.createElement('div');\n        const pace_selector_label = document.createElement('p');\n        const pace_selector_dropdown = document.createElement('select');\n        // Make dropdown navigatable by arrow keys\n        this.addTabbableElement(pace_selector_dropdown, 1);\n        pace_selector.classList.add('pace-selector');\n        pace_selector_label.innerHTML = 'Pace: ';\n        for (const pace_key in src_const.paces) {\n            const option = document.createElement('option');\n            option.value = pace_key;\n            option.innerHTML = pace_key;\n            let should_be_selected = parseFloat(pace_key) == 1 / src_globals.seconds_per_tick;\n            if (should_be_selected) {\n                option.selected = true;\n            }\n            pace_selector_dropdown.appendChild(option);\n        }\n        src_main_events.after_data_reset.on(() => {\n            pace_selector_dropdown.value = \"1\";\n        });\n        pace_selector.appendChild(pace_selector_label);\n        pace_selector.appendChild(pace_selector_dropdown);\n        const options_back = this.createLinkButton('Back', 'main', 'menu-button', 2);\n        const reset_button = this.createButton('Reset Game', 'menu-button', 3);\n        options_menu.appendChild(pace_selector);\n        options_menu.appendChild(options_back);\n        options_menu.appendChild(reset_button);\n        //Options menu\n        pace_selector_dropdown.addEventListener('change', (e) => {\n            src_globals.seconds_per_tick = 1 / parseFloat(e.target.value);\n            src_main_events.on_request_data_save.emit();\n        });\n        reset_button.addEventListener('click', () => {\n            src_main_events.on_request_data_reset.emit();\n        });\n        this.renderer.addMenu(options_menu, 'options');\n    }\n    initCollectionMenu(plant_templates, unlocked_plants, grown_plants) {\n        // Collection menu\n        const collection_menu = this.createMenu('menu-non-centered');\n        const collection_back = this.createLinkButton('Back', 'main', 'menu-button', 1);\n        collection_menu.appendChild(collection_back);\n        let button_index = 1;\n        for (const template_id in plant_templates) {\n            button_index++;\n            const plant_button = this.createButton('', 'menu-button', button_index);\n            plant_button.classList.add('plant-button');\n            // const plant = await Plant.fromTemplate(template_id, template_id, this.cache)\n            const plant_template = plant_templates[template_id];\n            const img_element = document.createElement('img');\n            img_element.classList.add('collection-image');\n            this.collection_images[template_id] = img_element;\n            plant_button.appendChild(img_element);\n            const is_plant_unlocked = unlocked_plants.includes(plant_template.plant_id);\n            const is_plant_grown = grown_plants.includes(plant_template.plant_id);\n            this.updateCollectionImage(plant_template, is_plant_unlocked, is_plant_grown);\n            collection_menu.appendChild(plant_button);\n        }\n        src_main_events.after_data_reset.on(() => {\n            this.resetCollectionImages(plant_templates);\n        });\n        this.renderer.addMenu(collection_menu, 'collection');\n    }\n    initPlantEntryMenu() {\n        //Plant Entry\n        const plant_menu = this.createMenu();\n        const plant_back = this.createLinkButton('Back', 'collection', 'menu-button', 1);\n        this.plant_image.classList.add('plant-entry-image');\n        const plant_button = this.createButton('Plant', 'menu-button', 2);\n        const stats = document.createElement('ul');\n        stats.appendChild(this.plant_stages);\n        stats.appendChild(this.plant_time_to_grow);\n        stats.appendChild(this.plant_water_frequency);\n        const info = document.createElement('div');\n        info.classList.add('plant-entry-info');\n        info.appendChild(this.plant_description);\n        info.appendChild(stats);\n        plant_menu.appendChild(plant_back);\n        plant_menu.appendChild(this.plant_image);\n        plant_menu.appendChild(this.plant_name);\n        plant_menu.appendChild(info);\n        plant_menu.appendChild(plant_button);\n        plant_button.addEventListener('click', () => {\n            src_main_events.on_request_plant_new_plant.emit(this.current_plant_in_menu.plant_id);\n            //this.game.plantNewPlant(this.current_plant_in_menu.plant_id);\n        });\n        this.renderer.addMenu(plant_menu, 'plant');\n    }\n    initHelpMenu() {\n        const help_menu = this.createMenu('menu-non-centered');\n        const back_button = this.createLinkButton('Back', 'main', null, 1);\n        const text_element = document.createElement('p');\n        text_element.innerHTML = `Welcome to My Pixel Plant. This is a small relaxing game where the sole\n        purpose is to just water your plant and watch it grow.<br><br>\n        \n        Each plant has several stages of growth, each of varying lengths. <br><br>\n        \n        A plant has a water level - which indicates how much water the plant has. The water\n        levels are split into water level stages, and the less water a plant has, the slower it will grow. The water level\n        stages are divided by dark vertical lines that you can see on your water level bar. <br><br>\n        \n        Whenever you grow a plant, a new plant gets unlocked. Each newly unlocked plant takes longer and longer to grow. <br><br>\n        \n        The Collection is a place where you can view all of your unlocked plant types and some information about them, such as how long they take to grow, how many stages\n        they have, and how frequently they have to be watered. Currently there are 4 plant types in the game. <br><br>\n        \n        Good luck with your plants and I hope you'll have fun playing this little game!\n        `;\n        help_menu.appendChild(back_button);\n        help_menu.appendChild(text_element);\n        this.renderer.addMenu(help_menu, 'help');\n    }\n    initUi(plant_templates, unlocked_plants, grown_plants, is_new_game) {\n        return UIManager_awaiter(this, void 0, void 0, function* () {\n            this.initGameUI();\n            this.initMainMenu(is_new_game);\n            this.initOptionsMenu();\n            this.initPlantEntryMenu();\n            this.initCollectionMenu(plant_templates, unlocked_plants, grown_plants);\n            this.initHelpMenu();\n        });\n    }\n    setPlayButtonText(str) {\n        this.play_button.innerHTML = str;\n    }\n    addTabbableElement(element, index) {\n        element.tabIndex = index;\n        this.tabbable_elements.push(element);\n    }\n    createButton(text, class_name = null, index = null, on_click = null) {\n        const btn = this.button.cloneNode();\n        btn.classList.add(class_name);\n        btn.innerHTML = text;\n        if (index) {\n            this.addTabbableElement(btn, index);\n        }\n        btn.addEventListener('click', () => {\n            if (on_click) {\n                on_click();\n            }\n        });\n        return btn;\n    }\n    createLinkButton(text = \"\", link_to = \"\", class_name = null, index = null, on_click = null) {\n        const btn = this.createButton(text, class_name, index);\n        btn.addEventListener('click', () => {\n            src_main_events.on_request_show_menu.emit(link_to);\n            if (on_click) {\n                on_click();\n            }\n        });\n        return btn;\n    }\n    createViewButton(text = \"\", link_to, class_name = \"\", index = null, on_click = null) {\n        const btn = this.createButton(text, class_name, index);\n        btn.addEventListener('click', () => {\n            src_main_events.on_request_set_view.emit(link_to);\n            if (on_click) {\n                on_click();\n            }\n        });\n        return btn;\n    }\n    createMenu(class_name = null) {\n        const menu = this.menu.cloneNode();\n        menu.classList.add(class_name);\n        return menu;\n    }\n    showPlantMenu(plant_template, is_plant_grown) {\n        this.plant_image.src = is_plant_grown ? getPlantTemplateFullyGrownImageURL(plant_template) : plant_template.stages[0].image_url;\n        this.plant_name.innerHTML = plant_template.name;\n        this.plant_description.innerHTML = plant_template.description;\n        this.plant_stages.innerHTML = \"<b>Stages: </b>\" + plant_template.stages.length;\n        const time_to_grow_seconds = templateTimeToGrow(plant_template, src_globals.seconds_per_tick);\n        const time_to_grow_str = humanReadableTimeFromSeconds(time_to_grow_seconds);\n        this.plant_time_to_grow.innerHTML = \"<b>Time to grow at max water level: </b>\" + time_to_grow_str;\n        const water_frequency_seconds = templateWateringFrequency(plant_template, src_globals.seconds_per_tick);\n        const water_frequency_str = humanReadableTimeFromSeconds(water_frequency_seconds);\n        this.plant_water_frequency.innerHTML = \"<b>Must be watered at least every: </b>\" + water_frequency_str;\n        this.current_plant_in_menu = plant_template;\n        this.renderer.showMenu('plant');\n    }\n    displayProgressMessage(plant, plant_templates, ff = true, growth_before = null, growth_after = null, seconds_elapsed = null) {\n        let show_plant_button = false;\n        let message = \"\";\n        const time = secondsToTime(seconds_elapsed);\n        let has_time = time.m > 0;\n        if (has_time && ff) {\n            const growth_difference = growth_after - growth_before;\n            let growth_percent = growth_difference / plant.maxGrowth() * 100;\n            if (plant.isFullyGrown()) {\n                growth_percent = true;\n            }\n            message = this.progressMessageText(time, growth_percent);\n        }\n        else if (!ff) {\n            message = this.progressMessageText({ h: 0, m: 0 }, true);\n        }\n        else {\n            return;\n        }\n        const unlock = getTemplateUnlock(plant.plant_id, plant_templates);\n        if (plant.isFullyGrown() && unlock) {\n            message += '<br><b>You have unlocked a new plant - ' + unlock.name + '. Would you like to plant it?';\n            src_globals.recently_unlocked = unlock.plant_id;\n            show_plant_button = true;\n        }\n        if (show_plant_button) {\n            this.progress_message_plant.style.display = 'flex';\n        }\n        else {\n            this.progress_message_plant.style.display = 'none';\n        }\n        this.progress_message.innerHTML = message;\n        this.progress_message_container.style.display = 'flex';\n        this.progress_message_container.focus();\n    }\n    /**\n     * If you want to indicate that the plant has fully grown, pass 'true' for `growth_percentage`\n     */\n    progressMessageText(time, growth_percentage) {\n        const away_str = time.h > 0 || time.m > 0 ? 'You were away for' : '';\n        const hrs_str = time.h == 1 ? '1 hour' : time.h > 0 ? time.h + ' hours' : '';\n        const mins_str = time.m == 1 ? '1 minute' : time.m > 0 ? time.m + ' minutes' : '';\n        const and_str = time.h > 0 && time.m > 0 ? 'and' : '';\n        const growth_str = typeof growth_percentage === 'boolean' ? 'fully grown' : 'grown by ' + growth_percentage.toFixed(2) + ' %';\n        return `${away_str} ${hrs_str} ${and_str} ${mins_str} ${and_str} your plant has ${growth_str}`;\n    }\n    calculatePositions(plant) {\n        this.water_button.style.top = plant.position.y * src_const.scale + 200 + 'px';\n        this.water_button.style.left = window.innerWidth / 2 + 'px';\n    }\n    updateCollectionImage(plant_template, is_plant_unlocked, is_plant_grown) {\n        const img_element = this.collection_images[plant_template.plant_id];\n        const plant_button = img_element.closest('button');\n        if (is_plant_unlocked) {\n            let stage = 0;\n            if (is_plant_grown) {\n                stage = getTemplateMaxStageIndex(plant_template);\n            }\n            //const image = this.cache.get('image_blobs/' + plant_template.plant_id + '/' + max_stage)\n            const image_url = plant_template.stages[stage].image_url; //URL.createObjectURL(image);\n            img_element.src = image_url;\n            //Check if text has already been added to the button\n            if (!plant_button.querySelector('p')) {\n                const text = document.createElement('p');\n                text.innerHTML = plant_template.name;\n                plant_button.appendChild(text);\n                //Additionally we can add the event lisetener, because this above if statement\n                //will only be true once, when the plant isn't unlocked and there is no text\n                plant_button.addEventListener('click', () => {\n                    this.showPlantMenu(plant_template, is_plant_grown);\n                });\n            }\n        }\n        else {\n            img_element.src = 'images/question-mark.jpeg';\n        }\n    }\n    resetCollectionImages(plant_templates) {\n        for (const template_id in plant_templates) {\n            if (template_id != 'basic_plant') {\n                this.updateCollectionImage(plant_templates[template_id], false, false);\n            }\n        }\n    }\n}\n\n;// CONCATENATED MODULE: ./src/SaveManager.ts\nvar SaveManager_awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\n\n\nclass SaveManager {\n    constructor(storage, cache) {\n        this.storage = storage;\n        this.cache = cache;\n    }\n    saveData(data) {\n        //If custom data object was passed, save that\n        // if(data) {\n        //     this.storage.set('data', data)\n        //     return;\n        // }\n        //Otherwise get current plants and save them\n        this.updateCachedData(data);\n        this.setData(this.data);\n    }\n    updateCachedData(data) {\n        if (data.seconds_per_tick != undefined) {\n            this.data.pace = 1 / data.seconds_per_tick;\n        }\n        if (data.plant != undefined) {\n            this.data.plant = data.plant.toJSON();\n        }\n        if (data.new_game !== undefined) {\n            this.data.new_game = data.new_game;\n        }\n        if (data.unlocked_plants !== undefined) {\n            this.data.unlocked_plants = data.unlocked_plants;\n        }\n        if (data.grown_plants !== undefined) {\n            this.data.grown_plants = data.grown_plants;\n        }\n        this.data.leave_time = new Date().getTime();\n    }\n    setCachedData(data) {\n        this.data = data;\n    }\n    getDefaultData() {\n        return SaveManager_awaiter(this, void 0, void 0, function* () {\n            const basic_plant = yield Plant.fromTemplate(0, 'basic_plant', this.cache);\n            return {\n                pace: 1,\n                max_id: 1,\n                leave_time: null,\n                unlocked_plants: [\"basic_plant\"],\n                grown_plants: [],\n                plant: basic_plant.toJSON(),\n                new_game: true,\n            };\n        });\n    }\n    setDataToDefaults() {\n        return SaveManager_awaiter(this, void 0, void 0, function* () {\n            const data = yield this.getDefaultData();\n            this.setData(data);\n            src_main_events.after_data_reset.emit();\n        });\n    }\n    setData(data) {\n        this.setCachedData(data);\n        this.storage.set('data', data);\n    }\n    resetData() {\n        return SaveManager_awaiter(this, void 0, void 0, function* () {\n            yield this.setDataToDefaults();\n        });\n    }\n    getData() {\n        if (!this.storage.has('data')) {\n            throw new Error('Could not retrieve save data: no data is set');\n        }\n        return this.storage.get('data');\n    }\n    setDataIfNull() {\n        return SaveManager_awaiter(this, void 0, void 0, function* () {\n            if (!this.storage.has('data')) {\n                yield this.setDataToDefaults();\n            }\n            else {\n                const default_data = yield this.getDefaultData();\n                this.data = Object.assign(Object.assign({}, default_data), this.getData());\n            }\n        });\n    }\n    /**\n     * Returns how long the user was away (not in-game or window not focused)\n     * @returns\n     */\n    getTimeAway() {\n        let current_time_ms = new Date().getTime();\n        let time_difference_ms = current_time_ms - this.data.leave_time;\n        return this.data.leave_time ? (time_difference_ms) / 1000 : null;\n    }\n}\n\n;// CONCATENATED MODULE: ./src/Game.ts\nvar Game_awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\n\n\n\n\n\n\n\n\n\n\n\nclass Game {\n    constructor() {\n        this.renderer = new Renderer('canvas', 'ui', 'menus');\n        this.cache = new MyCache();\n        this.storage = new MyStorage();\n        this.data = new SaveManager(this.storage, this.cache);\n        this.ui = new UIManager(this.renderer);\n        this.image_loader = new ImageLoader(this.cache);\n        this.first_init = false; //Whether this the game has been initialized at least once\n        this.last_frame_time = 0;\n        this.delta = 0;\n        this.delta_sum = 0;\n        this.plant_templates = {};\n        this.plants = {};\n        this.loading = true;\n        this.current_view = null;\n        src_main_events.on_request_data_reset.on(this.onRequestDataReset.bind(this));\n        src_main_events.on_request_data_save.on(this.onRequestDataSave.bind(this));\n        src_main_events.on_request_show_menu.on(this.onRequestShowMenu.bind(this));\n        src_main_events.on_request_set_view.on(this.onRequestSetView.bind(this));\n        src_main_events.on_request_fast_forward.on(this.onRequestFastForward.bind(this));\n        src_main_events.on_request_plant_new_plant.on(this.onRequestPlantNewPlant.bind(this));\n        src_main_events.on_request_water_plant.on(this.onRequestWaterPlant.bind(this));\n        src_main_events.after_data_reset.on(this.afterDataReset.bind(this));\n        window.addEventListener('focus', () => {\n            if (this.current_view == 'plant' && !this.data.data.new_game) {\n                this.fastForwardBySeconds(this.data.getTimeAway());\n            }\n        });\n        this.renderer.hideUI();\n    }\n    onRequestDataReset() {\n        return Game_awaiter(this, void 0, void 0, function* () {\n            const confirm_reset = confirm('Are you sure you want to reset all data? Plant data and collection will be lost');\n            if (!confirm_reset)\n                return;\n            yield this.data.resetData();\n            yield this.init();\n        });\n    }\n    afterDataReset() {\n        if (this.ui.play_button) {\n            this.ui.setPlayButtonText('New Game');\n        }\n    }\n    onRequestDataSave() {\n        this.data.saveData({\n            seconds_per_tick: src_globals.seconds_per_tick,\n            plant: this.plant\n        });\n    }\n    onRequestShowMenu(menu_id) {\n        this.setView(null);\n        this.renderer.showMenu(menu_id);\n    }\n    onRequestSetView(view_id) {\n        this.setView(view_id);\n    }\n    onRequestFastForward() {\n        this.fastForwardBySeconds(this.data.getTimeAway());\n    }\n    onRequestWaterPlant() {\n        this.waterCurrentPlant();\n    }\n    onRequestPlantNewPlant(template_id) {\n        this.plantNewPlant(template_id);\n    }\n    init() {\n        return Game_awaiter(this, void 0, void 0, function* () {\n            this.setLoading(true);\n            yield this.initTemplates();\n            yield this.initImages();\n            yield this.data.setDataIfNull();\n            this.initTemplateImageURLs();\n            src_globals.seconds_per_tick = 1 / this.data.data.pace;\n            window.addEventListener('resize', () => {\n                this.calculatePositions();\n            });\n            console.log(this.data.data);\n            if (!this.first_init) {\n                yield this.ui.initUi(this.plant_templates, this.data.data.unlocked_plants, this.data.data.grown_plants, this.data.data.new_game);\n                this.first_init = true;\n            }\n            yield this.initPlants();\n            this.calculatePositions();\n            this.setLoading(false);\n            this.renderer.showMenu('main');\n        });\n    }\n    initImages() {\n        return Game_awaiter(this, void 0, void 0, function* () {\n            for (const template_id in this.plant_templates) {\n                const template = this.plant_templates[template_id];\n                for (let i = 0; i < template.stages.length; i++) {\n                    yield this.image_loader.loadTemplateImageIfNull(template.plant_id, i);\n                }\n            }\n        });\n    }\n    initPlants() {\n        return Game_awaiter(this, void 0, void 0, function* () {\n            const plant = yield Plant.fromJSON(this.data.data.plant, this.cache);\n            this.setPlant(plant);\n        });\n    }\n    initTemplates() {\n        return Game_awaiter(this, void 0, void 0, function* () {\n            for (const template_id of src_const.plant_template_ids) {\n                const res = yield fetch('plant_templates/' + template_id + '.json');\n                const json = yield res.json();\n                this.plant_templates[template_id] = json;\n            }\n        });\n    }\n    initTemplateImageURLs() {\n        for (const template_id in this.plant_templates) {\n            const template = this.plant_templates[template_id];\n            for (const i in template.stages) {\n                const image = this.cache.get('image_blobs/' + template.plant_id + '/' + i);\n                template.stages[i].image_url = URL.createObjectURL(image);\n            }\n        }\n    }\n    onPlantFullyGrown(plant) {\n        this.ui.displayProgressMessage(this.plant, this.plant_templates, false);\n        this.data.saveData({\n            plant: this.plant,\n            unlocked_plants: [...this.data.data.unlocked_plants, plant.unlocks],\n            grown_plants: [...this.data.data.grown_plants, plant.plant_id]\n        });\n        if (plant.unlocks) {\n            const unlocked_template = this.plant_templates[plant.unlocks];\n            this.ui.updateCollectionImage(unlocked_template, true, false);\n        }\n        this.ui.updateCollectionImage(this.plant_templates[plant.plant_id], true, true);\n    }\n    fastForwardBySeconds(seconds) {\n        if (this.data.data.new_game) {\n            return;\n        }\n        if (!seconds) {\n            return;\n        }\n        const growth_before = this.plant.growth;\n        const ticks = this.getTicksBySeconds(seconds);\n        this.plant.fastForward(ticks);\n        const growth_after = this.plant.growth;\n        this.ui.displayProgressMessage(this.plant, this.plant_templates, true, growth_before, growth_after, seconds);\n    }\n    getTicksBySeconds(seconds) {\n        return seconds / src_globals.seconds_per_tick;\n    }\n    setView(view_name) {\n        this.current_view = view_name;\n        if (view_name) {\n            this.renderer.hideMenu();\n        }\n        if (view_name == 'plant') {\n            if (this.data.data.new_game == true) {\n                this.data.saveData({\n                    new_game: false\n                });\n                this.ui.setPlayButtonText('My Plant');\n            }\n        }\n    }\n    calculatePositions() {\n        this.plant.setPosition(getViewportCenter());\n        this.ui.calculatePositions(this.plant);\n    }\n    setLoading(loading) {\n        this.loading = loading;\n        if (this.loading) {\n            this.renderer.ui.style.display = 'none';\n            if (this.renderer.menu) {\n                this.renderer.currentMenu().style.display = 'none';\n            }\n        }\n        else {\n            if (this.renderer.menu) {\n                this.renderer.currentMenu().style.display = 'block';\n            }\n            else {\n                this.renderer.ui.style.display = 'block';\n            }\n        }\n    }\n    start() {\n        window.requestAnimationFrame(this.gameLoop.bind(this));\n    }\n    tick() {\n        this.data.saveData({\n            plant: this.plant\n        });\n        this.plant.tick();\n    }\n    draw() {\n        this.renderer.clear();\n        if (!this.loading && !this.renderer.menu && this.current_view == 'plant') {\n            this.renderer.drawPlant(this.plant);\n        }\n    }\n    waterCurrentPlant() {\n        this.plant.water_level.top();\n        this.plant.updateWaterLevelBar();\n    }\n    gameLoop() {\n        this.calculateDeltaSum();\n        if (this.delta_sum > src_globals.seconds_per_tick && !this.loading && this.current_view == 'plant') {\n            this.tick();\n            this.delta_sum = 0;\n        }\n        this.draw();\n        window.requestAnimationFrame(this.gameLoop.bind(this));\n    }\n    calculateDeltaSum() {\n        const current_time = new Date().getTime();\n        this.delta = (current_time - this.last_frame_time) / 1000;\n        this.last_frame_time = new Date().getTime();\n        this.delta_sum += this.delta;\n    }\n    // createPlant(plant: Plant) {\n    //     this.plants[plant.id] = plant;\n    // }\n    plantNewPlant(template_id) {\n        return Game_awaiter(this, void 0, void 0, function* () {\n            const plant = yield Plant.fromTemplate('my_plant', template_id, this.cache);\n            this.setPlant(plant);\n            this.setView('plant');\n        });\n    }\n    setPlant(plant) {\n        this.plant = plant;\n        this.plant.onFullyGrown(this.onPlantFullyGrown.bind(this));\n    }\n    unlockAll() {\n        this.data.saveData({\n            unlocked_plants: [...src_const.plant_template_ids]\n        });\n        alert('All plants have been unlocked, please refresh the page');\n    }\n}\n\n;// CONCATENATED MODULE: ./src/index.ts\n\nconst game = new Game();\ngame.init().then(() => {\n    game.start();\n});\nwindow.game = game;\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiNjgwLmpzIiwibWFwcGluZ3MiOiI7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUNoQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUNYQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQy9GQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FDakNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQ25CQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUNoQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUNMQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUNoQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FDUEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQ1pBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUNsRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FDdk1BO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FDcEhBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FDakJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUNaQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUNKQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQ3ZjQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUN2R0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQ3JRQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vLi9zcmMvY29uc3QudHM/MTRkYSIsIndlYnBhY2s6Ly8vLi9zcmMvVmVjdG9yLnRzPzY5ZjUiLCJ3ZWJwYWNrOi8vLy4vc3JjL3V0aWwudHM/OTg4NyIsIndlYnBhY2s6Ly8vLi9zcmMvSW1hZ2VMb2FkZXIudHM/NGU0NSIsIndlYnBhY2s6Ly8vLi9zcmMvTXlDYWNoZS50cz85NDNlIiwid2VicGFjazovLy8uL3NyYy9NeVN0b3JhZ2UudHM/NDFiMCIsIndlYnBhY2s6Ly8vLi9zcmMvR2FtZU9iamVjdC50cz9jMjY3Iiwid2VicGFjazovLy8uL3NyYy9SZWN0LnRzP2MyMTciLCJ3ZWJwYWNrOi8vLy4vc3JjL1Byb2dyZXNzQmFyLnRzP2E3MTEiLCJ3ZWJwYWNrOi8vLy4vc3JjL1Nwcml0ZS50cz8xNzMxIiwid2VicGFjazovLy8uL3NyYy9XYXRlckxldmVsLnRzPzkyZDgiLCJ3ZWJwYWNrOi8vLy4vc3JjL1BsYW50LnRzPzIxZWUiLCJ3ZWJwYWNrOi8vLy4vc3JjL1JlbmRlcmVyLnRzP2JmZmQiLCJ3ZWJwYWNrOi8vLy4vc3JjL015RXZlbnQudHM/YWYwYSIsIndlYnBhY2s6Ly8vLi9zcmMvbWFpbl9ldmVudHMudHM/YjNhMCIsIndlYnBhY2s6Ly8vLi9zcmMvZ2xvYmFscy50cz84YzIyIiwid2VicGFjazovLy8uL3NyYy9VSU1hbmFnZXIudHM/ZGU5MiIsIndlYnBhY2s6Ly8vLi9zcmMvU2F2ZU1hbmFnZXIudHM/Y2Y4OCIsIndlYnBhY2s6Ly8vLi9zcmMvR2FtZS50cz9mMGVmIiwid2VicGFjazovLy8uL3NyYy9pbmRleC50cz9lOTRlIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IGNvbnN0YW50cyA9IHtcbiAgICBzY2FsZTogOCxcbiAgICBwYWNlczoge1xuICAgICAgICBcIjRcIjogNCxcbiAgICAgICAgXCIyXCI6IDIsXG4gICAgICAgIFwiMVwiOiAxLFxuICAgICAgICBcIjAuNVwiOiAwLjUsXG4gICAgICAgIFwiMC4yNVwiOiAwLjI1XG4gICAgfSxcbiAgICBwbGFudF90ZW1wbGF0ZV9pZHM6IFtcbiAgICAgICAgXCJiYXNpY19wbGFudFwiLFxuICAgICAgICBcInllbGxvd19kaXBcIixcbiAgICAgICAgXCJibHVlX2hhemVcIixcbiAgICAgICAgXCJyZWRfcXVhcnR6XCJcbiAgICBdXG59O1xuZXhwb3J0IGRlZmF1bHQgY29uc3RhbnRzO1xuIiwiZXhwb3J0IGRlZmF1bHQgY2xhc3MgVmVjdG9yIHtcbiAgICBjb25zdHJ1Y3Rvcih4LCB5KSB7XG4gICAgICAgIHRoaXMueCA9IHg7XG4gICAgICAgIHRoaXMueSA9IHk7XG4gICAgfVxuICAgIGFkZCh2KSB7XG4gICAgICAgIHJldHVybiBuZXcgVmVjdG9yKHRoaXMueCArIHYueCwgdGhpcy55ICsgdi55KTtcbiAgICB9XG4gICAgZGl2aWRlKG4pIHtcbiAgICAgICAgcmV0dXJuIG5ldyBWZWN0b3IodGhpcy54IC8gbiwgdGhpcy55IC8gbik7XG4gICAgfVxufVxuIiwiaW1wb3J0IGNvbnN0YW50cyBmcm9tICcuL2NvbnN0JztcbmltcG9ydCBWZWN0b3IgZnJvbSAnLi9WZWN0b3InO1xuZXhwb3J0IGZ1bmN0aW9uIHJhbmdlT3ZlcmxhcCh4MSwgeDIsIHkxLCB5Mikge1xuICAgIHJldHVybiBNYXRoLm1heCgwLCBNYXRoLm1pbih4MiwgeTIpIC0gTWF0aC5tYXgoeDEsIHkxKSArIDEpO1xufVxuZXhwb3J0IGZ1bmN0aW9uIHNlY29uZHNUb1RpbWUoc2Vjcykge1xuICAgIHZhciBob3VycyA9IE1hdGguZmxvb3Ioc2VjcyAvICg2MCAqIDYwKSk7XG4gICAgdmFyIGRpdmlzb3JfZm9yX21pbnV0ZXMgPSBzZWNzICUgKDYwICogNjApO1xuICAgIHZhciBtaW51dGVzID0gTWF0aC5mbG9vcihkaXZpc29yX2Zvcl9taW51dGVzIC8gNjApO1xuICAgIHZhciBkaXZpc29yX2Zvcl9zZWNvbmRzID0gZGl2aXNvcl9mb3JfbWludXRlcyAlIDYwO1xuICAgIHZhciBzZWNvbmRzID0gTWF0aC5jZWlsKGRpdmlzb3JfZm9yX3NlY29uZHMpO1xuICAgIHZhciBvYmogPSB7XG4gICAgICAgIFwiaFwiOiBob3VycyxcbiAgICAgICAgXCJtXCI6IG1pbnV0ZXMsXG4gICAgICAgIFwic1wiOiBzZWNvbmRzXG4gICAgfTtcbiAgICByZXR1cm4gb2JqO1xufVxuZXhwb3J0IGZ1bmN0aW9uIGh1bWFuUmVhZGFibGVUaW1lKHRpbWUpIHtcbiAgICBjb25zdCBob3Vyc19zdHIgPSB0aW1lLmggPiAwID8gYCR7dGltZS5ofSAke3RpbWUuaCA9PSAxID8gJ2hvdXInIDogJ2hvdXJzJ31gIDogbnVsbDtcbiAgICBjb25zdCBtaW5zX3N0ciA9IHRpbWUubSA+IDAgPyBgJHt0aW1lLm19ICR7dGltZS5tID09IDEgPyAnbWludXRlJyA6ICdtaW51dGVzJ31gIDogbnVsbDtcbiAgICBjb25zdCBzZWNvbmRzX3N0ciA9IHRpbWUucyA+IDAgPyBgJHt0aW1lLnN9ICR7dGltZS5zID09IDEgPyAnc2Vjb25kJyA6ICdzZWNvbmRzJ31gIDogbnVsbDtcbiAgICBjb25zdCBhcnIgPSBbaG91cnNfc3RyLCBtaW5zX3N0ciwgc2Vjb25kc19zdHJdLmZpbHRlcihzdHIgPT4gc3RyICE9IG51bGwpO1xuICAgIHJldHVybiBhcnIuam9pbignLCAnKTtcbn1cbmV4cG9ydCBmdW5jdGlvbiBodW1hblJlYWRhYmxlVGltZUZyb21TZWNvbmRzKHNlY29uZHMpIHtcbiAgICBjb25zdCB0aW1lID0gc2Vjb25kc1RvVGltZShzZWNvbmRzKTtcbiAgICByZXR1cm4gaHVtYW5SZWFkYWJsZVRpbWUodGltZSk7XG59XG5leHBvcnQgZnVuY3Rpb24gZ2V0Vmlld3BvcnRDZW50ZXIoKSB7XG4gICAgcmV0dXJuIG5ldyBWZWN0b3Iod2luZG93LmlubmVyV2lkdGggLyAyIC8gY29uc3RhbnRzLnNjYWxlLCB3aW5kb3cuaW5uZXJIZWlnaHQgLyAyIC8gY29uc3RhbnRzLnNjYWxlKTtcbn1cbmV4cG9ydCBmdW5jdGlvbiBnZXRUZW1wbGF0ZU1heFN0YWdlSW5kZXgodGVtcGxhdGUpIHtcbiAgICByZXR1cm4gdGVtcGxhdGUuc3RhZ2VzLmxlbmd0aCAtIDE7XG59XG5leHBvcnQgZnVuY3Rpb24gZ2V0UGxhbnRJbWFnZUlEKHBsYW50X2lkLCBzdGFnZSkge1xuICAgIHJldHVybiAnaW1hZ2VzLycgKyBwbGFudF9pZCArICcvJyArIHN0YWdlO1xufVxuZXhwb3J0IGZ1bmN0aW9uIGdldFBsYW50SW1hZ2VCbG9ibElEKHBsYW50X2lkLCBzdGFnZSkge1xuICAgIHJldHVybiAnaW1hZ2VfYmxvYnMvJyArIHBsYW50X2lkICsgJy8nICsgc3RhZ2U7XG59XG5leHBvcnQgZnVuY3Rpb24gZ2V0VGVtcGxhdGVSZXNvdXJjZUlEKHRlbXBsYXRlX2lkKSB7XG4gICAgcmV0dXJuICd0ZW1wbGF0ZXMvJyArIHRlbXBsYXRlX2lkO1xufVxuZXhwb3J0IGZ1bmN0aW9uIGdldFBsYW50VGVtcGxhdGVGdWxseUdyb3duSW1hZ2VVUkwocGxhbnRfdGVtcGxhdGUpIHtcbiAgICBjb25zdCBtYXhfc3RhZ2UgPSBwbGFudF90ZW1wbGF0ZS5zdGFnZXMubGVuZ3RoIC0gMTtcbiAgICByZXR1cm4gcGxhbnRfdGVtcGxhdGUuc3RhZ2VzW21heF9zdGFnZV0uaW1hZ2VfdXJsO1xufVxuZXhwb3J0IGZ1bmN0aW9uIGdldFRlbXBsYXRlVW5sb2NrKHRlbXBsYXRlX2lkLCBhbGxfdGVtcGxhdGVzKSB7XG4gICAgY29uc3QgdW5sb2NrX2lkID0gYWxsX3RlbXBsYXRlc1t0ZW1wbGF0ZV9pZF0udW5sb2NrcztcbiAgICByZXR1cm4gYWxsX3RlbXBsYXRlc1t1bmxvY2tfaWRdO1xufVxuLyoqXG4gKiBHZXQgdGhlIG1heGltdW0gdW5pdHMgb2YgZ3Jvd3RoIGEgcGxhbnQgY2FuIGdyb3cgdG9cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFRlbXBsYXRlTWF4R3Jvd3RoKHBsYW50X3RlbXBsYXRlKSB7XG4gICAgY29uc3QgbWF4X3N0YWdlX2luZGV4ID0gZ2V0VGVtcGxhdGVNYXhTdGFnZUluZGV4KHBsYW50X3RlbXBsYXRlKTtcbiAgICByZXR1cm4gcGxhbnRfdGVtcGxhdGUuc3RhZ2VzW21heF9zdGFnZV9pbmRleF0uYXRfZ3Jvd3RoICogcGxhbnRfdGVtcGxhdGUubXVsdGlwbGllcjtcbn1cbi8qKlxuICogR2V0IHRoZSBwbGFudHMgbWF4IHdhdGVyIGluZGV4XG4gKiBAcGFyYW0gcGxhbnRfdGVtcGxhdGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFRlbXBsYXRlTWF4V2F0ZXJJbmRleChwbGFudF90ZW1wbGF0ZSkge1xuICAgIHJldHVybiBwbGFudF90ZW1wbGF0ZS53YXRlcl9sZXZlbC5zdGFnZXMubGVuZ3RoIC0gMTtcbn1cbi8qKlxuICogR2V0IHBsYW50J3MgbWF4IHdhdGVyIGxldmVsXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRUZW1wbGF0ZU1heFdhdGVyU3RhZ2UocGxhbnRfdGVtcGxhdGUpIHtcbiAgICBjb25zdCBtYXhfaW5kZXggPSBnZXRUZW1wbGF0ZU1heFdhdGVySW5kZXgocGxhbnRfdGVtcGxhdGUpO1xuICAgIHJldHVybiBwbGFudF90ZW1wbGF0ZS53YXRlcl9sZXZlbC5zdGFnZXNbbWF4X2luZGV4XTtcbn1cbi8qKlxuICogR2V0IHRoZSBncm93dGggcmF0ZSBvZiBhIHBsYW50IGF0IG1heCB3YXRlciBsZXZlbFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0VGVtcGxhdGVNYXhHcm93dGhSYXRlKHBsYW50X3RlbXBsYXRlKSB7XG4gICAgY29uc3QgbWF4X3dhdGVyX2xldmVsID0gZ2V0VGVtcGxhdGVNYXhXYXRlclN0YWdlKHBsYW50X3RlbXBsYXRlKTtcbiAgICByZXR1cm4gbWF4X3dhdGVyX2xldmVsLmdyb3d0aF9yYXRlICogcGxhbnRfdGVtcGxhdGUubXVsdGlwbGllcjtcbn1cbi8qKlxuICogVGltZSBpdCB0YWtlcyB0byBncm93IGEgcGxhbnQgaWYgaXRzIGlzIGF0IG1heCB3YXRlciBzdGFnZVxuICovXG5leHBvcnQgZnVuY3Rpb24gdGVtcGxhdGVUaW1lVG9Hcm93KHBsYW50X3RlbXBsYXRlLCBzZWNvbmRzX3Blcl90aWNrKSB7XG4gICAgY29uc3QgbWF4X2dyb3d0aCA9IGdldFRlbXBsYXRlTWF4R3Jvd3RoKHBsYW50X3RlbXBsYXRlKTtcbiAgICBjb25zdCBtYXhfZ3Jvd3RoX3JhdGUgPSBnZXRUZW1wbGF0ZU1heEdyb3d0aFJhdGUocGxhbnRfdGVtcGxhdGUpO1xuICAgIHJldHVybiBtYXhfZ3Jvd3RoICogcGxhbnRfdGVtcGxhdGUubXVsdGlwbGllciAvIG1heF9ncm93dGhfcmF0ZSAqIHNlY29uZHNfcGVyX3RpY2s7XG59XG4vKipcbiAqIEhvdyBvZnRlbiBhIHBsYW50J3Mgd2F0ZXIgbGV2ZWwgcnVucyBvdXQsIGluIHNlY29uZHNcbiAqXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB0ZW1wbGF0ZVdhdGVyaW5nRnJlcXVlbmN5KHBsYW50X3RlbXBsYXRlLCBzZWNvbmRzX3Blcl90aWNrKSB7XG4gICAgY29uc3Qgd2F0ZXJfZGVjcmVhc2VfcmF0ZSA9IHBsYW50X3RlbXBsYXRlLndhdGVyX2xldmVsLmRlY3JlYXNlX3JhdGUgKiBwbGFudF90ZW1wbGF0ZS5tdWx0aXBsaWVyO1xuICAgIHJldHVybiAxMDAgLyB3YXRlcl9kZWNyZWFzZV9yYXRlICogc2Vjb25kc19wZXJfdGljaztcbn1cbiIsInZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIGZ1bmN0aW9uIGFkb3B0KHZhbHVlKSB7IHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIFAgPyB2YWx1ZSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUodmFsdWUpOyB9KTsgfVxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IGFkb3B0KHJlc3VsdC52YWx1ZSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuaW1wb3J0IHsgZ2V0UGxhbnRJbWFnZUJsb2JsSUQsIGdldFBsYW50SW1hZ2VJRCB9IGZyb20gJy4vdXRpbCc7XG5leHBvcnQgZGVmYXVsdCBjbGFzcyBJbWFnZUxvYWRlciB7XG4gICAgY29uc3RydWN0b3IoY2FjaGUpIHtcbiAgICAgICAgdGhpcy5jYWNoZSA9IGNhY2hlO1xuICAgIH1cbiAgICBsb2FkVGVtcGxhdGVJbWFnZUlmTnVsbChwbGFudF9pZCwgc3RhZ2UpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc19pZCA9IGdldFBsYW50SW1hZ2VJRChwbGFudF9pZCwgc3RhZ2UpO1xuICAgICAgICAgICAgaWYgKCF0aGlzLmNhY2hlLmhhcyhyZXNfaWQpKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1nX3VybCA9ICcuL2ltYWdlcy8nICsgcGxhbnRfaWQgKyAnLycgKyBwbGFudF9pZCArICdfJyArIHN0YWdlICsgJy5wbmcnO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbWdfcmVzID0geWllbGQgZmV0Y2goaW1nX3VybCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGltZ19kYXRhID0geWllbGQgaW1nX3Jlcy5ibG9iKCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGltYWdlID0geWllbGQgY3JlYXRlSW1hZ2VCaXRtYXAoaW1nX2RhdGEpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBibG9iX2lkID0gZ2V0UGxhbnRJbWFnZUJsb2JsSUQocGxhbnRfaWQsIHN0YWdlKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jYWNoZS5zZXQocmVzX2lkLCBpbWFnZSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2FjaGUuc2V0KGJsb2JfaWQsIGltZ19kYXRhKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgbG9hZCBpbWFnZTogJyArIGUubWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59XG4iLCJleHBvcnQgZGVmYXVsdCBjbGFzcyBNeUNhY2hlIHtcbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5pdGVtcyA9IHt9O1xuICAgIH1cbiAgICBzZXQoaWQsIHZhbHVlKSB7XG4gICAgICAgIGlmIChpZCBpbiB0aGlzLml0ZW1zKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NhY2hlOiBDb3VsZCBub3Qgc3RvcmUgaXRlbSBieSBpZCAnICsgaWQgKyAnOiBpZCBhbHJlYWR5IHRha2VuJyk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5pdGVtc1tpZF0gPSB2YWx1ZTtcbiAgICB9XG4gICAgZ2V0KGlkKSB7XG4gICAgICAgIGlmICghKGlkIGluIHRoaXMuaXRlbXMpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NhY2hlOiBDb3VsZCBub3QgZmluZCBpdGVtIGJ5IGlkICcgKyBpZCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuaXRlbXNbaWRdO1xuICAgIH1cbiAgICBoYXMoaWQpIHtcbiAgICAgICAgcmV0dXJuIChpZCBpbiB0aGlzLml0ZW1zKTtcbiAgICB9XG59XG4iLCJleHBvcnQgZGVmYXVsdCBjbGFzcyBNeVN0b3JhZ2Uge1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLnByZWZpeCA9ICdwaXhlbC1wbGFudDonO1xuICAgIH1cbiAgICBnZXQoa2V5KSB7XG4gICAgICAgIHJldHVybiBKU09OLnBhcnNlKGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMucHJlZml4ICsga2V5KSk7XG4gICAgfVxuICAgIHNldChrZXksIHZhbHVlKSB7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMucHJlZml4ICsga2V5LCBKU09OLnN0cmluZ2lmeSh2YWx1ZSkpO1xuICAgIH1cbiAgICBoYXMoa2V5KSB7XG4gICAgICAgIHJldHVybiAhIWxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMucHJlZml4ICsga2V5KTtcbiAgICB9XG4gICAgcmVtb3ZlKGtleSkge1xuICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpO1xuICAgIH1cbn1cbiIsImltcG9ydCBWZWN0b3IgZnJvbSAnLi9WZWN0b3InO1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgR2FtZU9iamVjdCB7XG4gICAgY29uc3RydWN0b3IocG9zaXRpb24gPSBuZXcgVmVjdG9yKDAsIDApKSB7XG4gICAgICAgIHRoaXMucG9zaXRpb24gPSBwb3NpdGlvbjtcbiAgICB9XG59XG4iLCJpbXBvcnQgVmVjdG9yIGZyb20gJy4vVmVjdG9yJztcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJlY3Qge1xuICAgIGNvbnN0cnVjdG9yKHBvc2l0aW9uID0gbmV3IFZlY3RvcigwLCAwKSwgc2l6ZSA9IG5ldyBWZWN0b3IoMCwgMCkpIHtcbiAgICAgICAgdGhpcy5zaXplID0gc2l6ZTtcbiAgICAgICAgdGhpcy5wb3NpdGlvbiA9IHBvc2l0aW9uO1xuICAgIH1cbiAgICBjYWxjdWxhdGVCb3VuZHMoKSB7XG4gICAgICAgIHRoaXMubGVmdCA9IHRoaXMucG9zaXRpb24ueCAtIHRoaXMuc2l6ZS54IC8gMjtcbiAgICAgICAgdGhpcy5yaWdodCA9IHRoaXMucG9zaXRpb24ueCArIHRoaXMuc2l6ZS54IC8gMjtcbiAgICAgICAgdGhpcy50b3AgPSB0aGlzLnBvc2l0aW9uLnkgLSB0aGlzLnNpemUueSAvIDI7XG4gICAgICAgIHRoaXMuYm90dG9tID0gdGhpcy5wb3NpdGlvbi55IC0gdGhpcy5zaXplLnkgLyAyO1xuICAgIH1cbiAgICBzZXRQb3NpdGlvbih2KSB7XG4gICAgICAgIHRoaXMucG9zaXRpb24gPSB2O1xuICAgICAgICB0aGlzLmNhbGN1bGF0ZUJvdW5kcygpO1xuICAgIH1cbn1cbiIsImltcG9ydCBSZWN0IGZyb20gJy4vUmVjdCc7XG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQcm9ncmVzc0JhciBleHRlbmRzIFJlY3Qge1xuICAgIGNvbnN0cnVjdG9yKHJlY3QsIG9wdGlvbnMpIHtcbiAgICAgICAgc3VwZXIocmVjdC5wb3NpdGlvbiwgcmVjdC5zaXplKTtcbiAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLCBvcHRpb25zKTtcbiAgICB9XG59XG4vL2V4cG9ydCBkZWZhdWx0IFByb2dyZXNzQmFyXG4iLCJpbXBvcnQgR2FtZU9iamVjdCBmcm9tICcuL0dhbWVPYmplY3QnO1xuaW1wb3J0IFZlY3RvciBmcm9tICcuL1ZlY3Rvcic7XG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTcHJpdGUgZXh0ZW5kcyBHYW1lT2JqZWN0IHtcbiAgICBjb25zdHJ1Y3RvcihpbWFnZSwgcG9zaXRpb24pIHtcbiAgICAgICAgc3VwZXIocG9zaXRpb24pO1xuICAgICAgICB0aGlzLmltYWdlID0gaW1hZ2U7XG4gICAgICAgIHRoaXMud2lkdGggPSBpbWFnZS53aWR0aDtcbiAgICAgICAgdGhpcy5oZWlnaHQgPSBpbWFnZS5oZWlnaHQ7XG4gICAgfVxuICAgIGdldENlbnRlcihzY2FsZSA9IDEpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucG9zaXRpb24uZGl2aWRlKHNjYWxlKS5hZGQobmV3IFZlY3RvcigtdGhpcy53aWR0aCAvIDIsIC10aGlzLmhlaWdodCAvIDIpKTtcbiAgICB9XG59XG4iLCJleHBvcnQgZGVmYXVsdCBjbGFzcyBXYXRlckxldmVsIHtcbiAgICBjb25zdHJ1Y3RvcihkZWNyZWFzZV9yYXRlID0gMC41LCBzdGFnZXMgPSBbXSkge1xuICAgICAgICB0aGlzLnN0YWdlcyA9IHN0YWdlcztcbiAgICAgICAgdGhpcy5jdXJyZW50ID0gMTAwO1xuICAgICAgICB0aGlzLmRlY3JlYXNlX3JhdGUgPSBkZWNyZWFzZV9yYXRlO1xuICAgICAgICB0aGlzLnZhbGlkYXRlU3RhZ2VzKCk7XG4gICAgICAgIHRoaXMuY2FsY0N1cnJlbnRTdGFnZSgpO1xuICAgIH1cbiAgICB2YWxpZGF0ZVN0YWdlcygpIHtcbiAgICAgICAgZm9yIChsZXQgYSA9IDA7IGEgPCB0aGlzLnN0YWdlcy5sZW5ndGg7IGErKykge1xuICAgICAgICAgICAgY29uc3Qgc3RhZ2VfYSA9IHRoaXMuc3RhZ2VzW2EgLSAxXTtcbiAgICAgICAgICAgIGNvbnN0IHN0YWdlX2IgPSB0aGlzLnN0YWdlc1thXTtcbiAgICAgICAgICAgIGNvbnN0IHN0YWdlX2MgPSB0aGlzLnN0YWdlc1thICsgMV07XG4gICAgICAgICAgICBsZXQgdmFsaWQ7XG4gICAgICAgICAgICBpZiAodGhpcy5zdGFnZXMubGVuZ3RoID09IDEpIHtcbiAgICAgICAgICAgICAgICB2YWxpZCA9IHN0YWdlX2IuZnJvbSA9PSAwICYmIHN0YWdlX2IudG8gPT0gMTAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoYSA9PSAwKSB7XG4gICAgICAgICAgICAgICAgdmFsaWQgPSBzdGFnZV9iLmZyb20gPT0gMCAmJiBzdGFnZV9iLnRvID09IHN0YWdlX2MuZnJvbTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKGEgIT0gdGhpcy5zdGFnZXMubGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgICAgIHZhbGlkID0gc3RhZ2VfYS50byA9PSBzdGFnZV9iLmZyb20gJiYgc3RhZ2VfYi50byA9PSBzdGFnZV9jLmZyb207XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YWxpZCA9IHN0YWdlX2IuZnJvbSA9PSBzdGFnZV9hLnRvICYmIHN0YWdlX2IudG8gPT0gMTAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCF2YWxpZCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCB3YXRlciBsZXZlbCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGNhbGNDdXJyZW50U3RhZ2UoKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zdGFnZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IHN0YWdlID0gdGhpcy5zdGFnZXNbaV07XG4gICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50IDw9IHN0YWdlLnRvICYmIHRoaXMuY3VycmVudCA+PSBzdGFnZS5mcm9tKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50X3N0YWdlID0gaTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFcnJvciBjYWxjdWxhdGluZyB3YXRlciBjdXJyZW50IHN0YWdlJyk7XG4gICAgfVxuICAgIGdldEN1cnJlbnRTdGFnZSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhZ2VzW3RoaXMuY3VycmVudF9zdGFnZV07XG4gICAgfVxuICAgIGRlY3JlYXNlQnlUaWNrcyh0aWNrcykge1xuICAgICAgICB0aGlzLmN1cnJlbnQgPSBNYXRoLm1heCgwLCB0aGlzLmN1cnJlbnQgLSB0aGlzLmRlY3JlYXNlX3JhdGUgKiB0aWNrcyk7XG4gICAgICAgIHRoaXMuY2FsY0N1cnJlbnRTdGFnZSgpO1xuICAgIH1cbiAgICBkZWNyZWFzZSgpIHtcbiAgICAgICAgdGhpcy5kZWNyZWFzZUJ5VGlja3MoMSk7XG4gICAgfVxuICAgIHNldChjdXJyZW50KSB7XG4gICAgICAgIHRoaXMuY3VycmVudCA9IGN1cnJlbnQ7XG4gICAgICAgIHRoaXMuY2FsY0N1cnJlbnRTdGFnZSgpO1xuICAgIH1cbiAgICB0b3AoKSB7XG4gICAgICAgIHRoaXMuc2V0KDEwMCk7XG4gICAgfVxuICAgIHN0YXRpYyBmcm9tVGVtcGxhdGUodGVtcGxhdGUpIHtcbiAgICAgICAgY29uc3Qgc3RhZ2VzID0gW107XG4gICAgICAgIGNvbnN0IG11bHRpcGxpZXIgPSB0ZW1wbGF0ZS5tdWx0aXBsaWVyO1xuICAgICAgICB0ZW1wbGF0ZS53YXRlcl9sZXZlbC5zdGFnZXMuZm9yRWFjaCgoc3RhZ2UpID0+IHtcbiAgICAgICAgICAgIHN0YWdlcy5wdXNoKE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgc3RhZ2UpLCB7IGdyb3d0aF9yYXRlOiBzdGFnZS5ncm93dGhfcmF0ZSAqIG11bHRpcGxpZXIgfSkpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG5ldyBXYXRlckxldmVsKHRlbXBsYXRlLndhdGVyX2xldmVsLmRlY3JlYXNlX3JhdGUgKiBtdWx0aXBsaWVyLCBzdGFnZXMpO1xuICAgIH1cbn1cbiIsInZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIGZ1bmN0aW9uIGFkb3B0KHZhbHVlKSB7IHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIFAgPyB2YWx1ZSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUodmFsdWUpOyB9KTsgfVxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IGFkb3B0KHJlc3VsdC52YWx1ZSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuaW1wb3J0IFZlY3RvciBmcm9tICcuL1ZlY3Rvcic7XG5pbXBvcnQgR2FtZU9iamVjdCBmcm9tICcuL0dhbWVPYmplY3QnO1xuaW1wb3J0IFByb2dyZXNzQmFyIGZyb20gJy4vUHJvZ3Jlc3NCYXInO1xuaW1wb3J0IFNwcml0ZSBmcm9tICcuL1Nwcml0ZSc7XG5pbXBvcnQgV2F0ZXJMZXZlbCBmcm9tICcuL1dhdGVyTGV2ZWwnO1xuaW1wb3J0IFJlY3QgZnJvbSAnLi9SZWN0JztcbmltcG9ydCB7IGdldFBsYW50SW1hZ2VJRCwgZ2V0VGVtcGxhdGVSZXNvdXJjZUlELCBnZXRWaWV3cG9ydENlbnRlciwgcmFuZ2VPdmVybGFwIH0gZnJvbSAnLi91dGlsJztcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFBsYW50IGV4dGVuZHMgR2FtZU9iamVjdCB7XG4gICAgY29uc3RydWN0b3IoaWQsIG9wdGlvbnMpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy53YXRlcl9sZXZlbCA9IG5ldyBXYXRlckxldmVsKDAuNSwgW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIGZyb206IDAsXG4gICAgICAgICAgICAgICAgdG86IDEwMCxcbiAgICAgICAgICAgICAgICBncm93dGhfcmF0ZTogNFxuICAgICAgICAgICAgfSxcbiAgICAgICAgXSk7XG4gICAgICAgIHRoaXMuY3VycmVudF9zdGFnZSA9IDA7XG4gICAgICAgIHRoaXMuZ3Jvd3RoID0gMDtcbiAgICAgICAgdGhpcy5wb3NpdGlvbiA9IG5ldyBWZWN0b3IoMCwgMCk7XG4gICAgICAgIHRoaXMuc2l6ZSA9IG5ldyBWZWN0b3IoMTYsIDMyKTtcbiAgICAgICAgdGhpcy5pZCA9IGlkO1xuICAgICAgICBPYmplY3QuYXNzaWduKHRoaXMsIG9wdGlvbnMpO1xuICAgICAgICB0aGlzLmluaXRXYXRlckxldmVsQmFyKCk7XG4gICAgICAgIHRoaXMuc2V0UG9zaXRpb24oZ2V0Vmlld3BvcnRDZW50ZXIoKSk7XG4gICAgfVxuICAgIGluaXRXYXRlckxldmVsQmFyKCkge1xuICAgICAgICBjb25zdCBkaXZpZGVycyA9IHRoaXMud2F0ZXJfbGV2ZWwuc3RhZ2VzLm1hcChzdGFnZSA9PiBzdGFnZS50byk7XG4gICAgICAgIGRpdmlkZXJzLnBvcCgpO1xuICAgICAgICB0aGlzLndhdGVyX2xldmVsX2JhciA9IG5ldyBQcm9ncmVzc0JhcihuZXcgUmVjdChuZXcgVmVjdG9yKDAsIDApLCBuZXcgVmVjdG9yKDIwLCAyKSksIHtcbiAgICAgICAgICAgIGJnX2NvbG9yOiAnIzAwMDhGRjQyJyxcbiAgICAgICAgICAgIGNvbG9yOiAnIzAwMDhGRkFEJyxcbiAgICAgICAgICAgIGRpdmlkZXJfY29sb3I6ICdkYXJrYmx1ZScsXG4gICAgICAgICAgICBkaXJlY3Rpb246ICdyaWdodCcsXG4gICAgICAgICAgICBjdXJyZW50OiAwLFxuICAgICAgICAgICAgZGl2aWRlcnNcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMud2F0ZXJfbGV2ZWxfYmFyLmN1cnJlbnQgPSB0aGlzLndhdGVyX2xldmVsLmN1cnJlbnQ7XG4gICAgfVxuICAgIG1heEdyb3d0aCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhZ2VzW3RoaXMuc3RhZ2VzLmxlbmd0aCAtIDFdLmF0X2dyb3d0aDtcbiAgICB9XG4gICAgaXNGdWxseUdyb3duKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5ncm93dGggPiB0aGlzLm1heEdyb3d0aCgpO1xuICAgIH1cbiAgICB0b0pTT04oKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBpZDogdGhpcy5pZCxcbiAgICAgICAgICAgIHBsYW50X2lkOiB0aGlzLnBsYW50X2lkLFxuICAgICAgICAgICAgbmFtZTogdGhpcy5uYW1lLFxuICAgICAgICAgICAgd2F0ZXJfbGV2ZWxfY3VycmVudDogdGhpcy53YXRlcl9sZXZlbC5jdXJyZW50LFxuICAgICAgICAgICAgZ3Jvd3RoOiB0aGlzLmdyb3d0aCxcbiAgICAgICAgICAgIGZ1bGx5X2dyb3duX2NhbGxlZDogdGhpcy5mdWxseV9ncm93bl9jYWxsZWRcbiAgICAgICAgfTtcbiAgICB9XG4gICAgb25GdWxseUdyb3duKGNhbGxiYWNrKSB7XG4gICAgICAgIHRoaXMuZnVsbHlfZ3Jvd25fY2IgPSBjYWxsYmFjaztcbiAgICB9XG4gICAgc3RhdGljIGZyb21KU09OKGpzb24sIGNhY2hlKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBwbGFudCA9IHlpZWxkIFBsYW50LmZyb21UZW1wbGF0ZShqc29uLmlkLCBqc29uLnBsYW50X2lkLCBjYWNoZSk7XG4gICAgICAgICAgICBwbGFudC5uYW1lID0ganNvbi5uYW1lO1xuICAgICAgICAgICAgcGxhbnQud2F0ZXJfbGV2ZWwuc2V0KGpzb24ud2F0ZXJfbGV2ZWxfY3VycmVudCk7XG4gICAgICAgICAgICBwbGFudC5zZXRHcm93dGgoanNvbi5ncm93dGgpO1xuICAgICAgICAgICAgcGxhbnQuZnVsbHlfZ3Jvd25fY2FsbGVkID0ganNvbi5mdWxseV9ncm93bl9jYWxsZWQ7XG4gICAgICAgICAgICByZXR1cm4gcGxhbnQ7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBzdGF0aWMgc3RhZ2VzRnJvbVRlbXBsYXRlKHRlbXBsYXRlLCBjYWNoZSkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgcGxhbnRfc3RhZ2VzID0gW107XG4gICAgICAgICAgICBjb25zdCBtdWx0aXBsaWVyID0gdGVtcGxhdGUubXVsdGlwbGllcjtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGVtcGxhdGUuc3RhZ2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzX2lkID0gZ2V0UGxhbnRJbWFnZUlEKHRlbXBsYXRlLnBsYW50X2lkLCBpKTtcbiAgICAgICAgICAgICAgICBjb25zdCBpbWFnZSA9IGNhY2hlLmdldChyZXNfaWQpO1xuICAgICAgICAgICAgICAgIC8vUGxhbnQgZGF0YVxuICAgICAgICAgICAgICAgIGNvbnN0IHNwcml0ZSA9IG5ldyBTcHJpdGUoaW1hZ2UpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGF0X2dyb3d0aCA9IHRlbXBsYXRlLnN0YWdlc1tpXS5hdF9ncm93dGggKiBtdWx0aXBsaWVyO1xuICAgICAgICAgICAgICAgIHBsYW50X3N0YWdlcy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgc3ByaXRlLFxuICAgICAgICAgICAgICAgICAgICBhdF9ncm93dGhcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBwbGFudF9zdGFnZXM7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBzdGF0aWMgZnJvbVRlbXBsYXRlKGlkLCB0ZW1wbGF0ZV9pZCwgY2FjaGUpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc19pZCA9IGdldFRlbXBsYXRlUmVzb3VyY2VJRCh0ZW1wbGF0ZV9pZCk7XG4gICAgICAgICAgICBpZiAoIWNhY2hlLmhhcyhyZXNfaWQpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdGVtcGxhdGVfcmVzID0geWllbGQgZmV0Y2goJy4vcGxhbnRfdGVtcGxhdGVzLycgKyB0ZW1wbGF0ZV9pZCArICcuanNvbicpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHRlbXBsYXRlID0geWllbGQgdGVtcGxhdGVfcmVzLmpzb24oKTtcbiAgICAgICAgICAgICAgICBjYWNoZS5zZXQocmVzX2lkLCB0ZW1wbGF0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IGNhY2hlLmdldChyZXNfaWQpO1xuICAgICAgICAgICAgY29uc3Qgc3RhZ2VzID0geWllbGQgUGxhbnQuc3RhZ2VzRnJvbVRlbXBsYXRlKHRlbXBsYXRlLCBjYWNoZSk7XG4gICAgICAgICAgICBjb25zdCB3YXRlcl9sZXZlbCA9IFdhdGVyTGV2ZWwuZnJvbVRlbXBsYXRlKHRlbXBsYXRlKTtcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICAgICAgICAgICAgcGxhbnRfaWQ6IHRlbXBsYXRlLnBsYW50X2lkLFxuICAgICAgICAgICAgICAgIHdhdGVyX2xldmVsLFxuICAgICAgICAgICAgICAgIG5hbWU6ICdNeSBQbGFudCcsXG4gICAgICAgICAgICAgICAgc3RhZ2VzLFxuICAgICAgICAgICAgICAgIHVubG9ja3M6IHRlbXBsYXRlLnVubG9ja3NcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXR1cm4gbmV3IFBsYW50KGlkLCBvcHRpb25zKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGNhbGN1bGF0ZUN1cnJlbnRTdGFnZSgpIHtcbiAgICAgICAgY29uc3Qgc3RhZ2VfaW5kZXhlcyA9IHRoaXMuc3RhZ2VzLm1hcCgoc3RhZ2UsIGluZGV4KSA9PiBpbmRleCk7XG4gICAgICAgIHZhciBjdXJyX3N0YWdlX2luZGV4ID0gc3RhZ2VfaW5kZXhlcy5yZWR1Y2UoKGEsIGkpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHByZXZfc3RhZ2UgPSB0aGlzLnN0YWdlc1thXTtcbiAgICAgICAgICAgIGNvbnN0IGN1cnJfc3RhZ2UgPSB0aGlzLnN0YWdlc1tpXTtcbiAgICAgICAgICAgIGxldCBpc19ncm93dGhfaW5fY3Vycl9zdGFnZSA9IGN1cnJfc3RhZ2UuYXRfZ3Jvd3RoID4gcHJldl9zdGFnZS5hdF9ncm93dGggJiYgdGhpcy5ncm93dGggPiBjdXJyX3N0YWdlLmF0X2dyb3d0aDtcbiAgICAgICAgICAgIGlmIChpc19ncm93dGhfaW5fY3Vycl9zdGFnZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGE7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmN1cnJlbnRfc3RhZ2UgPSBjdXJyX3N0YWdlX2luZGV4O1xuICAgIH1cbiAgICBncm93QnkoYWRkZWRfZ3Jvd3RoKSB7XG4gICAgICAgIHRoaXMuZ3Jvd3RoICs9IGFkZGVkX2dyb3d0aDtcbiAgICAgICAgdGhpcy5jYWxjdWxhdGVDdXJyZW50U3RhZ2UoKTtcbiAgICAgICAgaWYgKHRoaXMuaXNGdWxseUdyb3duKCkgJiYgdGhpcy5mdWxseV9ncm93bl9jYiAmJiAhdGhpcy5mdWxseV9ncm93bl9jYWxsZWQpIHtcbiAgICAgICAgICAgIHRoaXMuZnVsbHlfZ3Jvd25fY2IodGhpcyk7XG4gICAgICAgICAgICB0aGlzLmZ1bGx5X2dyb3duX2NhbGxlZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLyoqXG4gICAgICogR3Jvd3MgcGxhbnQgYnkgMSB0aWNrXG4gICAgICovXG4gICAgZ3JvdygpIHtcbiAgICAgICAgbGV0IGdyb3d0aF9yYXRlID0gMDtcbiAgICAgICAgaWYgKHRoaXMud2F0ZXJfbGV2ZWwuY3VycmVudCA+IDApIHtcbiAgICAgICAgICAgIGdyb3d0aF9yYXRlID0gdGhpcy53YXRlcl9sZXZlbC5nZXRDdXJyZW50U3RhZ2UoKS5ncm93dGhfcmF0ZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmdyb3dCeShncm93dGhfcmF0ZSk7XG4gICAgfVxuICAgIHNldEdyb3d0aChncm93dGgpIHtcbiAgICAgICAgdGhpcy5ncm93dGggPSBncm93dGg7XG4gICAgICAgIHRoaXMuY2FsY3VsYXRlQ3VycmVudFN0YWdlKCk7XG4gICAgfVxuICAgIGdldEN1cnJlbnRTdGFnZSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhZ2VzW3RoaXMuY3VycmVudF9zdGFnZV07XG4gICAgfVxuICAgIGZhc3RGb3J3YXJkKHRpY2tzKSB7XG4gICAgICAgIGNvbnN0IHdhdGVyX2VuZCA9IHRoaXMud2F0ZXJfbGV2ZWwuY3VycmVudDtcbiAgICAgICAgdGhpcy53YXRlcl9sZXZlbC5kZWNyZWFzZUJ5VGlja3ModGlja3MpO1xuICAgICAgICBjb25zdCB3YXRlcl9zdGFydCA9IHRoaXMud2F0ZXJfbGV2ZWwuY3VycmVudDtcbiAgICAgICAgbGV0IGFkZGVkX2dyb3d0aCA9IDA7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy53YXRlcl9sZXZlbC5zdGFnZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IHdhdGVyX3N0YWdlID0gdGhpcy53YXRlcl9sZXZlbC5zdGFnZXNbaV07XG4gICAgICAgICAgICBjb25zdCBncm93dF9yYXRlID0gd2F0ZXJfc3RhZ2UuZ3Jvd3RoX3JhdGU7XG4gICAgICAgICAgICBjb25zdCBvdmVybGFwID0gcmFuZ2VPdmVybGFwKHdhdGVyX3N0YXJ0LCB3YXRlcl9lbmQsIHdhdGVyX3N0YWdlLmZyb20sIHdhdGVyX3N0YWdlLnRvKTtcbiAgICAgICAgICAgIGFkZGVkX2dyb3d0aCArPSAob3ZlcmxhcCAvIHRoaXMud2F0ZXJfbGV2ZWwuZGVjcmVhc2VfcmF0ZSkgKiBncm93dF9yYXRlO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZ3Jvd0J5KGFkZGVkX2dyb3d0aCk7XG4gICAgfVxuICAgIHRpY2soKSB7XG4gICAgICAgIHRoaXMuZ3JvdygpO1xuICAgICAgICAvL3RoaXMud2F0ZXJfbGV2ZWwuZGVjcmVhc2UoKTtcbiAgICAgICAgdGhpcy5kZWNyZWFzZVdhdGVyTGV2ZWwoKTtcbiAgICB9XG4gICAgZGVjcmVhc2VXYXRlckxldmVsQnlUaWNrcyh0aWNrcykge1xuICAgICAgICB0aGlzLndhdGVyX2xldmVsLmRlY3JlYXNlQnlUaWNrcyh0aWNrcyk7XG4gICAgICAgIHRoaXMudXBkYXRlV2F0ZXJMZXZlbEJhcigpO1xuICAgIH1cbiAgICBkZWNyZWFzZVdhdGVyTGV2ZWwoKSB7XG4gICAgICAgIHRoaXMuZGVjcmVhc2VXYXRlckxldmVsQnlUaWNrcygxKTtcbiAgICB9XG4gICAgdXBkYXRlV2F0ZXJMZXZlbEJhcigpIHtcbiAgICAgICAgdGhpcy53YXRlcl9sZXZlbF9iYXIuY3VycmVudCA9IHRoaXMud2F0ZXJfbGV2ZWwuY3VycmVudDtcbiAgICB9XG4gICAgc2V0UG9zaXRpb24ocCkge1xuICAgICAgICB0aGlzLnBvc2l0aW9uID0gcDtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0aGlzLnN0YWdlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgdGhpcy5zdGFnZXNbaV0uc3ByaXRlLnBvc2l0aW9uID0gdGhpcy5wb3NpdGlvbjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLndhdGVyX2xldmVsX2Jhci5zZXRQb3NpdGlvbihuZXcgVmVjdG9yKHRoaXMucG9zaXRpb24ueCwgdGhpcy5nZXRSZWN0KCkuYm90dG9tICsgMikpO1xuICAgIH1cbiAgICBnZXRSZWN0KCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdG9wOiB0aGlzLnBvc2l0aW9uLnkgLSB0aGlzLnNpemUueSAvIDIsXG4gICAgICAgICAgICBib3R0b206IHRoaXMucG9zaXRpb24ueSArIHRoaXMuc2l6ZS55IC8gMixcbiAgICAgICAgICAgIGxlZnQ6IHRoaXMucG9zaXRpb24ueCAtIHRoaXMuc2l6ZS54IC8gMixcbiAgICAgICAgICAgIHJpZ2h0OiB0aGlzLnBvc2l0aW9uLnggKyB0aGlzLnNpemUueCAvIDJcbiAgICAgICAgfTtcbiAgICB9XG59XG4iLCJpbXBvcnQgY29uc3RhbnRzIGZyb20gJy4vY29uc3QnO1xuaW1wb3J0IFZlY3RvciBmcm9tICcuL1ZlY3Rvcic7XG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSZW5kZXJlciB7XG4gICAgY29uc3RydWN0b3IoY2FudmFzX2lkLCB1aV9pZCwgbWVudV9pZCkge1xuICAgICAgICB0aGlzLnNjYWxlID0gY29uc3RhbnRzLnNjYWxlO1xuICAgICAgICB0aGlzLm1lbnVzID0ge307XG4gICAgICAgIHRoaXMubWVudSA9IG51bGw7XG4gICAgICAgIHRoaXMuY2FudmFzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY2FudmFzX2lkKTtcbiAgICAgICAgdGhpcy51aSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHVpX2lkKTtcbiAgICAgICAgdGhpcy5tZW51X2VsZW1lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChtZW51X2lkKTtcbiAgICAgICAgaWYgKCF0aGlzLmNhbnZhcykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgZmluZCBjYW52YXMgZWxlbWVudCBieSBpZCAnICsgY2FudmFzX2lkKTtcbiAgICAgICAgfVxuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgKGUpID0+IHtcbiAgICAgICAgICAgIHRoaXMuY2FsY3VsYXRlQ2FudmFzU2l6ZSgpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5jdHggPSB0aGlzLmNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xuICAgICAgICB0aGlzLmNhbGN1bGF0ZUNhbnZhc1NpemUoKTtcbiAgICB9XG4gICAgY2FsY3VsYXRlQ2FudmFzU2l6ZSgpIHtcbiAgICAgICAgdGhpcy5jYW52YXMud2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDtcbiAgICAgICAgdGhpcy5jYW52YXMuaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0O1xuICAgICAgICB0aGlzLmN0eC5zY2FsZSh0aGlzLnNjYWxlLCB0aGlzLnNjYWxlKTtcbiAgICAgICAgdGhpcy5jdHguaW1hZ2VTbW9vdGhpbmdFbmFibGVkID0gZmFsc2U7XG4gICAgfVxuICAgIGNsZWFyKCkge1xuICAgICAgICB0aGlzLmN0eC5jbGVhclJlY3QoMCwgMCwgdGhpcy5jYW52YXMud2lkdGgsIHRoaXMuY2FudmFzLmhlaWdodCk7XG4gICAgfVxuICAgIHNjYWxlZFBvc2l0aW9uKHBvcykge1xuICAgICAgICByZXR1cm4gcG9zLmRpdmlkZSh0aGlzLnNjYWxlKTtcbiAgICB9XG4gICAgZHJhd1Nwcml0ZShzcHJpdGUpIHtcbiAgICAgICAgY29uc3QgcG9zID0gc3ByaXRlLnBvc2l0aW9uLmFkZChuZXcgVmVjdG9yKC1zcHJpdGUud2lkdGggLyAyLCAtc3ByaXRlLmhlaWdodCAvIDIpKTsgLy9zcHJpdGUuZ2V0Q2VudGVyKHRoaXMuc2NhbGUpXG4gICAgICAgIHRoaXMuY3R4LmRyYXdJbWFnZShzcHJpdGUuaW1hZ2UsIHBvcy54LCBwb3MueSk7XG4gICAgfVxuICAgIGRyYXdSZWN0KHJlY3QsIGNvbG9yKSB7XG4gICAgICAgIHRoaXMuY3R4LmZpbGxTdHlsZSA9IGNvbG9yO1xuICAgICAgICB0aGlzLmN0eC5maWxsUmVjdChyZWN0LmxlZnQsIHJlY3QudG9wLCByZWN0LnNpemUueCwgcmVjdC5zaXplLnkpO1xuICAgIH1cbiAgICBkcmF3TGluZShmcm9tLCB0bywgY29sb3IpIHtcbiAgICAgICAgdGhpcy5jdHguc3Ryb2tlU3R5bGUgPSBjb2xvcjtcbiAgICAgICAgdGhpcy5jdHguYmVnaW5QYXRoKCk7XG4gICAgICAgIHRoaXMuY3R4Lm1vdmVUbyhmcm9tLngsIGZyb20ueSk7XG4gICAgICAgIHRoaXMuY3R4LmxpbmVUbyh0by54LCB0by55KTtcbiAgICAgICAgdGhpcy5jdHguc3Ryb2tlKCk7XG4gICAgfVxuICAgIGN1cnJlbnRNZW51KCkge1xuICAgICAgICByZXR1cm4gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQodGhpcy5tZW51KTtcbiAgICB9XG4gICAgZHJhd1Byb2dyZXNzQmFyKHByb2dyZXNzX2Jhcikge1xuICAgICAgICBjb25zdCB7IHBvc2l0aW9uLCBzaXplIH0gPSBwcm9ncmVzc19iYXI7XG4gICAgICAgIGNvbnN0IHsgeCwgeSB9ID0gcG9zaXRpb247XG4gICAgICAgIGNvbnN0IHsgeDogd2lkdGgsIHk6IGhlaWdodCB9ID0gc2l6ZTtcbiAgICAgICAgY29uc3QgbGVmdCA9IHggLSB3aWR0aCAvIDI7XG4gICAgICAgIGNvbnN0IHRvcCA9IHkgLSBoZWlnaHQgLyAyO1xuICAgICAgICB0aGlzLmRyYXdSZWN0KHByb2dyZXNzX2JhciwgcHJvZ3Jlc3NfYmFyLmJnX2NvbG9yKTtcbiAgICAgICAgdGhpcy5jdHguZmlsbFN0eWxlID0gcHJvZ3Jlc3NfYmFyLmNvbG9yO1xuICAgICAgICBjb25zdCBuZXdfcmVjdCA9IHN0cnVjdHVyZWRDbG9uZShwcm9ncmVzc19iYXIpO1xuICAgICAgICBpZiAocHJvZ3Jlc3NfYmFyLmRpcmVjdGlvbiA9PSAncmlnaHQnKSB7XG4gICAgICAgICAgICBuZXdfcmVjdC5zaXplLnggPSBwcm9ncmVzc19iYXIuY3VycmVudCAvIDEwMCAqIHByb2dyZXNzX2Jhci5zaXplLng7XG4gICAgICAgICAgICB0aGlzLmRyYXdSZWN0KG5ld19yZWN0LCBwcm9ncmVzc19iYXIuY29sb3IpO1xuICAgICAgICAgICAgY29uc3QgYmFyX2xlbmd0aCA9IG5ld19yZWN0LnJpZ2h0IC0gbmV3X3JlY3QubGVmdDtcbiAgICAgICAgICAgIGNvbnN0IHkgPSBuZXdfcmVjdC5wb3NpdGlvbi55IC0gMTtcbiAgICAgICAgICAgIGNvbnN0IGVuZF95ID0gbmV3X3JlY3QuYm90dG9tICsgMjtcbiAgICAgICAgICAgIGZvciAoY29uc3QgZGl2aWRlciBvZiBwcm9ncmVzc19iYXIuZGl2aWRlcnMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB4ID0gbmV3X3JlY3QucG9zaXRpb24ueCAtIChiYXJfbGVuZ3RoIC8gMikgKyBiYXJfbGVuZ3RoIC8gMTAwICogZGl2aWRlcjtcbiAgICAgICAgICAgICAgICBjb25zdCBwb3MxID0gbmV3IFZlY3Rvcih4LCB5KTtcbiAgICAgICAgICAgICAgICBjb25zdCBwb3MyID0gbmV3IFZlY3Rvcih4LCBlbmRfeSk7XG4gICAgICAgICAgICAgICAgdGhpcy5kcmF3TGluZShwb3MxLCBwb3MyLCBwcm9ncmVzc19iYXIuZGl2aWRlcl9jb2xvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Byb2dyZXNzIGJhciByZW5kZXJpbmcgb25seSBpbXBsZW1lbnRlZCBmb3IgcmlnaHQgZGlyZWN0aW9uJyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZHJhd1BsYW50KHBsYW50KSB7XG4gICAgICAgIHRoaXMuZHJhd1Nwcml0ZShwbGFudC5nZXRDdXJyZW50U3RhZ2UoKS5zcHJpdGUpO1xuICAgICAgICB0aGlzLmRyYXdQcm9ncmVzc0JhcihwbGFudC53YXRlcl9sZXZlbF9iYXIpO1xuICAgICAgICAvL3RoaXMuZHJhd1Nwcml0ZVxuICAgIH1cbiAgICBhZGRNZW51KG1lbnUsIG1lbnVfaWQpIHtcbiAgICAgICAgaWYgKG1lbnVfaWQpIHtcbiAgICAgICAgICAgIG1lbnUuaWQgPSBtZW51X2lkICsgJy1tZW51JztcbiAgICAgICAgfVxuICAgICAgICBtZW51LmNsYXNzTGlzdC5hZGQoJ21lbnUnKTtcbiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lbnVzJykuYXBwZW5kQ2hpbGQobWVudSk7XG4gICAgICAgIHRoaXMubWVudXNbbWVudV9pZF0gPSBtZW51O1xuICAgIH1cbiAgICBzaG93TWVudShtZW51X2lkKSB7XG4gICAgICAgIHRoaXMudWkuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgdGhpcy5tZW51X2VsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdmbGV4JztcbiAgICAgICAgdGhpcy5oaWRlTWVudSgpO1xuICAgICAgICBjb25zdCBtZW51ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobWVudV9pZCArICctbWVudScpO1xuICAgICAgICBpZiAoIW1lbnUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGZpbmQgbWVudSB3aXRoIElEICcgKyBtZW51X2lkKTtcbiAgICAgICAgfVxuICAgICAgICBtZW51LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7XG4gICAgICAgIHRoaXMubWVudV9lbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7XG4gICAgICAgIHRoaXMuaGlkZVVJKCk7XG4gICAgICAgIC8vdGhpcy5tZW51X2VsZW1lbnQucmVwbGFjZVdpdGgodGhpcy5tZW51KVxuICAgIH1cbiAgICBoaWRlVUkoKSB7XG4gICAgICAgIHRoaXMudWkuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgdGhpcy5jYW52YXMuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICB9XG4gICAgc2hvd1VJKCkge1xuICAgICAgICB0aGlzLnVpLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xuICAgICAgICB0aGlzLmNhbnZhcy5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnO1xuICAgIH1cbiAgICBoaWRlTWVudSgpIHtcbiAgICAgICAgT2JqZWN0LmtleXModGhpcy5tZW51cykuZm9yRWFjaChtZW51X2lkID0+IHtcbiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKG1lbnVfaWQgKyAnLW1lbnUnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5tZW51X2VsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgdGhpcy5zaG93VUkoKTtcbiAgICB9XG59XG4iLCJleHBvcnQgZGVmYXVsdCBjbGFzcyBNeUV2ZW50IHtcbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5tYXhfaWQgPSAwO1xuICAgICAgICB0aGlzLmNhbGxiYWNrcyA9IHt9O1xuICAgIH1cbiAgICBvbihjYikge1xuICAgICAgICB0aGlzLmNhbGxiYWNrc1t0aGlzLm1heF9pZCsrXSA9IGNiO1xuICAgICAgICByZXR1cm4gdGhpcy5tYXhfaWQ7XG4gICAgfVxuICAgIG9mZihpZCkge1xuICAgICAgICBkZWxldGUgdGhpcy5jYWxsYmFja3NbaWRdO1xuICAgIH1cbiAgICBlbWl0KC4uLmFyZ3MpIHtcbiAgICAgICAgZm9yIChjb25zdCBrZXkgaW4gdGhpcy5jYWxsYmFja3MpIHtcbiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2tzW2tleV0oLi4uYXJncyk7XG4gICAgICAgIH1cbiAgICB9XG59XG4iLCJpbXBvcnQgTXlFdmVudCBmcm9tICcuL015RXZlbnQnO1xuY29uc3QgbWFpbl9ldmVudHMgPSB7XG4gICAgb25fcmVxdWVzdF9wbGFudF9uZXdfcGxhbnQ6IG5ldyBNeUV2ZW50KCksXG4gICAgb25fcmVxdWVzdF93YXRlcl9wbGFudDogbmV3IE15RXZlbnQoKSxcbiAgICBvbl9yZXF1ZXN0X2Zhc3RfZm9yd2FyZDogbmV3IE15RXZlbnQoKSxcbiAgICBvbl9yZXF1ZXN0X3Nob3dfbWVudTogbmV3IE15RXZlbnQoKSxcbiAgICBvbl9yZXF1ZXN0X3NldF92aWV3OiBuZXcgTXlFdmVudCgpLFxuICAgIG9uX3JlcXVlc3RfZGF0YV9yZXNldDogbmV3IE15RXZlbnQoKSxcbiAgICBvbl9yZXF1ZXN0X2RhdGFfc2F2ZTogbmV3IE15RXZlbnQoKSxcbiAgICBhZnRlcl9kYXRhX3Jlc2V0OiBuZXcgTXlFdmVudCgpLFxuICAgIG9uX2Zhc3RfZm9yd2FyZDogbmV3IE15RXZlbnQoKVxufTtcbmV4cG9ydCBkZWZhdWx0IG1haW5fZXZlbnRzO1xuIiwiY29uc3QgZ2xvYmFscyA9IHtcbiAgICBzZWNvbmRzX3Blcl90aWNrOiAxLFxuICAgIHJlY2VudGx5X3VubG9ja2VkOiAnYmFzaWNfcGxhbnQnXG59O1xuZXhwb3J0IGRlZmF1bHQgZ2xvYmFscztcbiIsInZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIGZ1bmN0aW9uIGFkb3B0KHZhbHVlKSB7IHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIFAgPyB2YWx1ZSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUodmFsdWUpOyB9KTsgfVxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IGFkb3B0KHJlc3VsdC52YWx1ZSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuaW1wb3J0IGNvbnN0YW50cyBmcm9tICcuL2NvbnN0JztcbmltcG9ydCB7IGdldFBsYW50VGVtcGxhdGVGdWxseUdyb3duSW1hZ2VVUkwsIGdldFRlbXBsYXRlTWF4U3RhZ2VJbmRleCwgZ2V0VGVtcGxhdGVVbmxvY2ssIGh1bWFuUmVhZGFibGVUaW1lRnJvbVNlY29uZHMsIHNlY29uZHNUb1RpbWUsIHRlbXBsYXRlVGltZVRvR3JvdywgdGVtcGxhdGVXYXRlcmluZ0ZyZXF1ZW5jeSB9IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQgbWFpbl9ldmVudHMgZnJvbSAnLi9tYWluX2V2ZW50cyc7XG5pbXBvcnQgZ2xvYmFscyBmcm9tICcuL2dsb2JhbHMnO1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgVUlNYW5hZ2VyIHtcbiAgICBjb25zdHJ1Y3RvcihyZW5kZXJlcikge1xuICAgICAgICAvL2dhbWU6IEdhbWU7XG4gICAgICAgIHRoaXMuYnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7XG4gICAgICAgIHRoaXMubWVudSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICB0aGlzLnBsYW50X2J1dHRvbnMgPSBbXTtcbiAgICAgICAgdGhpcy5wbGFudF9pbWFnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpO1xuICAgICAgICB0aGlzLnBsYW50X25hbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdoMicpO1xuICAgICAgICB0aGlzLnBsYW50X2Rlc2NyaXB0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xuICAgICAgICB0aGlzLnBsYW50X3N0YWdlcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7XG4gICAgICAgIHRoaXMucGxhbnRfdGltZV90b19ncm93ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTtcbiAgICAgICAgdGhpcy5wbGFudF93YXRlcl9mcmVxdWVuY3kgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpO1xuICAgICAgICB0aGlzLnRhYmJhYmxlX2VsZW1lbnRzID0gW107XG4gICAgICAgIHRoaXMuY3VycmVudF90YWJfaW5kZXggPSAwO1xuICAgICAgICB0aGlzLmNvbGxlY3Rpb25faW1hZ2VzID0ge307XG4gICAgICAgIHRoaXMucmVuZGVyZXIgPSByZW5kZXJlcjtcbiAgICAgICAgdGhpcy5idXR0b24uY2xhc3NMaXN0LmFkZCgnYnV0dG9uJyk7XG4gICAgICAgIHRoaXMubWVudS5jbGFzc0xpc3QuYWRkKCdtZW51Jyk7XG4gICAgICAgIGNvbnN0IE5BVl9VUCA9ICdBcnJvd1VwJztcbiAgICAgICAgY29uc3QgTkFWX0RPV04gPSAnQXJyb3dEb3duJztcbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIChlKSA9PiB7XG4gICAgICAgICAgICAvLyBLZXlib2FyZCBuYXZpZ2F0aW9uXG4gICAgICAgICAgICBpZiAoZS5jb2RlID09IE5BVl9VUCkge1xuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICB0aGlzLm5hdmlnYXRlVXAoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKGUuY29kZSA9PSBOQVZfRE9XTikge1xuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICB0aGlzLm5hdmlnYXRlRG93bigpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgLyoqXG4gICAgICogS2V5Ym9hcmQgbmF2aWdhdGlvblxuICAgICAqL1xuICAgIG5hdmlnYXRlVXAoKSB7XG4gICAgICAgIGxldCByZWZlcmVuY2VfaW5kZXggPSB0aGlzLmN1cnJlbnRfdGFiX2luZGV4O1xuICAgICAgICBjb25zdCBpbmRpY2VzX2Fib3ZlID0gdGhpcy5nZXRJbmRleGVzKCdhYm92ZScsIHJlZmVyZW5jZV9pbmRleCk7XG4gICAgICAgIGlmIChpbmRpY2VzX2Fib3ZlLmxlbmd0aCA9PSAwKSB7XG4gICAgICAgICAgICByZWZlcmVuY2VfaW5kZXggPSB0aGlzLmdldE1heEluZGV4KCkgKyAxO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGNsb3Nlc3RfaW5kZXggPSB0aGlzLmdldENsb3NldEluZGV4KHJlZmVyZW5jZV9pbmRleCwgdGhpcy5nZXRJbmRleGVzKCdhYm92ZScsIHJlZmVyZW5jZV9pbmRleCkpO1xuICAgICAgICB0aGlzLm5hdmlnYXRlVG9JbmRleChjbG9zZXN0X2luZGV4KTtcbiAgICB9XG4gICAgbmF2aWdhdGVEb3duKCkge1xuICAgICAgICBsZXQgcmVmZXJlbmNlX2luZGV4ID0gdGhpcy5jdXJyZW50X3RhYl9pbmRleDtcbiAgICAgICAgY29uc3QgaW5kaWNlc19iZWxvdyA9IHRoaXMuZ2V0SW5kZXhlcygnYmVsb3cnLCByZWZlcmVuY2VfaW5kZXgpO1xuICAgICAgICBpZiAoaW5kaWNlc19iZWxvdy5sZW5ndGggPT0gMCkge1xuICAgICAgICAgICAgcmVmZXJlbmNlX2luZGV4ID0gMDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjbG9zZXN0X2luZGV4ID0gdGhpcy5nZXRDbG9zZXRJbmRleChyZWZlcmVuY2VfaW5kZXgsIHRoaXMuZ2V0SW5kZXhlcygnYmVsb3cnLCByZWZlcmVuY2VfaW5kZXgpKTtcbiAgICAgICAgdGhpcy5uYXZpZ2F0ZVRvSW5kZXgoY2xvc2VzdF9pbmRleCk7XG4gICAgfVxuICAgIGdldE1heEluZGV4KCkge1xuICAgICAgICByZXR1cm4gTWF0aC5tYXgoLi4udGhpcy5nZXRJbmRleGVzKCdhbGwnKSk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIFJldHVybnMgYXJyYXkgb2YgaW5kaWNlcyBmb3IgdmlzaWJsZSB0YWJiYWJsZSBlbGVtZW50c1xuICAgICAqIEBwYXJhbSBkaXJlY3Rpb25cbiAgICAgKiBAcGFyYW0gcmVmZXJlbmNlX2luZGV4XG4gICAgICogQHJldHVybnNcbiAgICAgKi9cbiAgICBnZXRJbmRleGVzKGRpcmVjdGlvbiA9ICdhbGwnLCByZWZlcmVuY2VfaW5kZXggPSBudWxsKSB7XG4gICAgICAgIGxldCBpbmRpY2VzX2FsbCA9IG51bGw7XG4gICAgICAgIGNvbnN0IHZpc2libGVfZWxlbWVudHMgPSB0aGlzLmdldFZpc2libGVFbGVtZW50cygpO1xuICAgICAgICBpZiAoZGlyZWN0aW9uID09ICdhbGwnKSB7XG4gICAgICAgICAgICBpbmRpY2VzX2FsbCA9IHZpc2libGVfZWxlbWVudHMubWFwKChlbGVtZW50KSA9PiBlbGVtZW50LnRhYkluZGV4KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmICh0eXBlb2YgcmVmZXJlbmNlX2luZGV4ID09ICdudW1iZXInKSB7XG4gICAgICAgICAgICBpbmRpY2VzX2FsbCA9IHZpc2libGVfZWxlbWVudHMuZmlsdGVyKGVsZW1lbnQgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBkaXJlY3Rpb24gPT0gJ2JlbG93JyA/IGVsZW1lbnQudGFiSW5kZXggPiByZWZlcmVuY2VfaW5kZXggOiBlbGVtZW50LnRhYkluZGV4IDwgcmVmZXJlbmNlX2luZGV4O1xuICAgICAgICAgICAgfSkubWFwKChlbGVtZW50KSA9PiBlbGVtZW50LnRhYkluZGV4KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSWYgZGlyZWN0aW9uIGlzbid0ICdhbGwnLCByZWZlcmVuY2VfaW5kZXggbXVzdCBiZSBzcGVjaWZpZWRgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaW5kaWNlc19hbGw7XG4gICAgfVxuICAgIGlzRWxlbWVudFZpc2libGUoZWxlbWVudCkge1xuICAgICAgICByZXR1cm4gZWxlbWVudC5vZmZzZXRQYXJlbnQgIT0gbnVsbDtcbiAgICB9XG4gICAgZ2V0VmlzaWJsZUVsZW1lbnRzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy50YWJiYWJsZV9lbGVtZW50cy5maWx0ZXIoKGVsZW0pID0+IHRoaXMuaXNFbGVtZW50VmlzaWJsZShlbGVtKSk7XG4gICAgfVxuICAgIGdldEVsZW1lbnRCeUluZGV4KGluZGV4KSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldFZpc2libGVFbGVtZW50cygpLmZpbmQoZWxlbSA9PiBlbGVtLnRhYkluZGV4ID09IGluZGV4KTtcbiAgICB9XG4gICAgZ2V0Q2xvc2V0SW5kZXgocmVmZXJlbmNlX2luZGV4LCBmcm9tKSB7XG4gICAgICAgIGlmIChmcm9tLmxlbmd0aCA9PSAxKSB7XG4gICAgICAgICAgICByZXR1cm4gZnJvbVswXTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZnJvbS5yZWR1Y2UoKGEsIGIpID0+IHtcbiAgICAgICAgICAgIC8vY29uc3QgYSA9IHBhcnNlSW50KGFfc3RyKTtcbiAgICAgICAgICAgIC8vY29uc3QgYiA9IHBhcnNlSW50KGJfc3RyKTtcbiAgICAgICAgICAgIHJldHVybiBNYXRoLmFicyhiIC0gcmVmZXJlbmNlX2luZGV4KSA8IE1hdGguYWJzKGEgLSByZWZlcmVuY2VfaW5kZXgpID8gYiA6IGE7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBuYXZpZ2F0ZVRvSW5kZXgoaW5kZXgpIHtcbiAgICAgICAgY29uc3QgdGFyZ2V0X2VsZW0gPSB0aGlzLmdldEVsZW1lbnRCeUluZGV4KGluZGV4KTtcbiAgICAgICAgdGhpcy5jdXJyZW50X3RhYl9pbmRleCA9IGluZGV4O1xuICAgICAgICB0YXJnZXRfZWxlbS5mb2N1cygpO1xuICAgIH1cbiAgICBpbml0R2FtZVVJKCkge1xuICAgICAgICAvLyBHYW1lIFVJXG4gICAgICAgIC8vIHdhdGVyX2J1dHRvbi5pbm5lckhUTUwgPSAnV2F0ZXIgUGxhbnQnXG4gICAgICAgIC8vIHdhdGVyX2J1dHRvbi5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSdcbiAgICAgICAgLy8gd2F0ZXJfYnV0dG9uLnN0eWxlLnRvcCA9ICcxNDBweCdcbiAgICAgICAgLy8gd2F0ZXJfYnV0dG9uLnN0eWxlLmxlZnQgPSAnNTAlJztcbiAgICAgICAgLy8gd2F0ZXJfYnV0dG9uLnN0eWxlLnRyYW5zZm9ybSA9ICd0cmFuc2xhdGVYKC01MCUpJ1xuICAgICAgICAvLyB3YXRlcl9idXR0b24udGFiSW5kZXggPSA0O1xuICAgICAgICAvL0JhY2sgYnV0dG9uXG4gICAgICAgIGNvbnN0IGJhY2tfYnV0dG9uID0gdGhpcy5jcmVhdGVMaW5rQnV0dG9uKCdCYWNrJywgJ21haW4nLCAnYnV0dG9uLXRsJywgMSk7XG4gICAgICAgIHRoaXMud2F0ZXJfYnV0dG9uID0gdGhpcy5jcmVhdGVCdXR0b24oJ1dhdGVyIFBsYW50JywgJ3dhdGVyLWJ1dHRvbicsIDIpO1xuICAgICAgICBjb25zdCB3YXRlcl9idXR0b24gPSB0aGlzLndhdGVyX2J1dHRvbjtcbiAgICAgICAgLy9Qcm9ncmVzcyBtZXNzYWdlXG4gICAgICAgIGNvbnN0IHByb2dyZXNzX21lc3NhZ2VfY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgIHRoaXMucHJvZ3Jlc3NfbWVzc2FnZV9jb250YWluZXIgPSBwcm9ncmVzc19tZXNzYWdlX2NvbnRhaW5lcjtcbiAgICAgICAgcHJvZ3Jlc3NfbWVzc2FnZV9jb250YWluZXIuY2xhc3NMaXN0LmFkZCgncHJvZ3Jlc3MtbWVzc2FnZScpO1xuICAgICAgICAvLyBwcm9ncmVzc19tZXNzYWdlX2NvbnRhaW5lci50YWJJbmRleCA9IDA7XG4gICAgICAgIGNvbnN0IHByb2dyZXNzX21lc3NhZ2VfYm90dG9tID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgIHByb2dyZXNzX21lc3NhZ2VfYm90dG9tLmNsYXNzTGlzdC5hZGQoJ3Byb2dyZXNzLW1lc3NhZ2UtYm90dG9tJyk7XG4gICAgICAgIHRoaXMucHJvZ3Jlc3NfbWVzc2FnZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcbiAgICAgICAgY29uc3QgcHJvZ3Jlc3NfbWVzc2FnZSA9IHRoaXMucHJvZ3Jlc3NfbWVzc2FnZTtcbiAgICAgICAgcHJvZ3Jlc3NfbWVzc2FnZS5pbm5lckhUTUwgPSAnWW91IHdlcmUgYXdheSBmb3IgbiBob3VycyBuIG1pbnV0ZXMgYW5kIHlvdXIgcGxhbnQgaGFzIGdyb3duIGJ5IHggJSc7XG4gICAgICAgIGNvbnN0IGRpc21pc3NfYnV0dG9uID0gdGhpcy5jcmVhdGVCdXR0b24oJ0Rpc21pc3MnLCAnbWVudS1idXR0b24nLCAzLCAoKSA9PiB7XG4gICAgICAgICAgICBwcm9ncmVzc19tZXNzYWdlX2NvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5wcm9ncmVzc19tZXNzYWdlX3BsYW50ID0gdGhpcy5jcmVhdGVCdXR0b24oJ1BsYW50JywgJ21lbnUtYnV0dG9uJywgNCk7XG4gICAgICAgIHRoaXMucHJvZ3Jlc3NfbWVzc2FnZV9wbGFudC5jbGFzc0xpc3QuYWRkKCdzbWFsbC1idXR0b24nKTtcbiAgICAgICAgdGhpcy5wcm9ncmVzc19tZXNzYWdlX3BsYW50LmlubmVySFRNTCA9ICdQbGFudCc7XG4gICAgICAgIHByb2dyZXNzX21lc3NhZ2VfY29udGFpbmVyLmFwcGVuZENoaWxkKHByb2dyZXNzX21lc3NhZ2UpO1xuICAgICAgICBwcm9ncmVzc19tZXNzYWdlX2NvbnRhaW5lci5hcHBlbmRDaGlsZChwcm9ncmVzc19tZXNzYWdlX2JvdHRvbSk7XG4gICAgICAgIHByb2dyZXNzX21lc3NhZ2VfYm90dG9tLmFwcGVuZENoaWxkKGRpc21pc3NfYnV0dG9uKTtcbiAgICAgICAgcHJvZ3Jlc3NfbWVzc2FnZV9ib3R0b20uYXBwZW5kQ2hpbGQodGhpcy5wcm9ncmVzc19tZXNzYWdlX3BsYW50KTtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIEhhdmUgdG8gdXNlIG1vdXNlZG93biBpbnN0ZWFkIG9mIGNsaWNrIGhlcmUgYmVjYXVzZSBvdGhlcndpc2UgdGhlIHByb2dyZXNzXG4gICAgICAgICAqIG1lc3NhZ2UgY29udGFpbmVyIGxvc2VzIGZvY3VzIGJlZm9yZSB0aGUgY2xpY2sgZXZlbnQgaXMgZmlyZWRcbiAgICAgICAgICovXG4gICAgICAgIHRoaXMucHJvZ3Jlc3NfbWVzc2FnZV9wbGFudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCAoKSA9PiB7XG4gICAgICAgICAgICBwcm9ncmVzc19tZXNzYWdlX2NvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICAgICAgbWFpbl9ldmVudHMub25fcmVxdWVzdF9wbGFudF9uZXdfcGxhbnQuZW1pdChnbG9iYWxzLnJlY2VudGx5X3VubG9ja2VkKTtcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIHByb2dyZXNzX21lc3NhZ2VfY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoJ2ZvY3Vzb3V0JywgKCkgPT4ge1xuICAgICAgICAvLyAgICAgcHJvZ3Jlc3NfbWVzc2FnZV9jb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdub25lJ1xuICAgICAgICAvLyB9KVxuICAgICAgICB3YXRlcl9idXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgICAgICAgICBtYWluX2V2ZW50cy5vbl9yZXF1ZXN0X3dhdGVyX3BsYW50LmVtaXQoKTtcbiAgICAgICAgICAgIC8vdGhpcy5nYW1lLndhdGVyQ3VycmVudFBsYW50KClcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucmVuZGVyZXIudWkuYXBwZW5kQ2hpbGQod2F0ZXJfYnV0dG9uKTtcbiAgICAgICAgdGhpcy5yZW5kZXJlci51aS5hcHBlbmRDaGlsZChiYWNrX2J1dHRvbik7XG4gICAgICAgIHRoaXMucmVuZGVyZXIudWkuYXBwZW5kQ2hpbGQocHJvZ3Jlc3NfbWVzc2FnZV9jb250YWluZXIpO1xuICAgIH1cbiAgICBpbml0TWFpbk1lbnUoaXNfbmV3X2dhbWUpIHtcbiAgICAgICAgLy9NYWluIG1lbnVcbiAgICAgICAgLy9QbGF5IGJ1dHRvblxuICAgICAgICB0aGlzLnBsYXlfYnV0dG9uID0gdGhpcy5jcmVhdGVWaWV3QnV0dG9uKGlzX25ld19nYW1lID8gJ05ldyBHYW1lJyA6ICdNeSBQbGFudCcsICdwbGFudCcsICdtZW51LWJ1dHRvbicsIDEsICgpID0+IHtcbiAgICAgICAgICAgIG1haW5fZXZlbnRzLm9uX3JlcXVlc3RfZmFzdF9mb3J3YXJkLmVtaXQoKTtcbiAgICAgICAgICAgIC8vdGhpcy5nYW1lLmZhc3RGb3J3YXJkQnlTZWNvbmRzKHRoaXMuZ2FtZS5nZXRUaW1lQXdheSgpKVxuICAgICAgICB9KTtcbiAgICAgICAgLy9Db2xsZWN0aW9uIGJ1dHRvblxuICAgICAgICBjb25zdCBjb2xsZWN0aW9uX2J1dHRvbiA9IHRoaXMuY3JlYXRlTGlua0J1dHRvbignQ29sbGVjdGlvbicsICdjb2xsZWN0aW9uJywgJ21lbnUtYnV0dG9uJywgMik7XG4gICAgICAgIC8vSGVscCBidXR0b25cbiAgICAgICAgY29uc3QgaGVscF9idXR0b24gPSB0aGlzLmNyZWF0ZUxpbmtCdXR0b24oJ0hlbHAnLCAnaGVscCcsICdtZW51LWJ1dHRvbicsIDMpO1xuICAgICAgICAvL09wdGlvbnMgYnV0dG9uXG4gICAgICAgIGNvbnN0IG9wdGlvbnNfYnV0dG9uID0gdGhpcy5jcmVhdGVMaW5rQnV0dG9uKCdPcHRpb25zJywgJ29wdGlvbnMnLCAnbWVudS1idXR0b24nLCA0KTtcbiAgICAgICAgdGhpcy5tYWluX21lbnUgPSB0aGlzLmNyZWF0ZU1lbnUoKTtcbiAgICAgICAgdGhpcy5tYWluX21lbnUuYXBwZW5kQ2hpbGQodGhpcy5wbGF5X2J1dHRvbik7XG4gICAgICAgIHRoaXMubWFpbl9tZW51LmFwcGVuZENoaWxkKGNvbGxlY3Rpb25fYnV0dG9uKTtcbiAgICAgICAgdGhpcy5tYWluX21lbnUuYXBwZW5kQ2hpbGQoaGVscF9idXR0b24pO1xuICAgICAgICB0aGlzLm1haW5fbWVudS5hcHBlbmRDaGlsZChvcHRpb25zX2J1dHRvbik7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuYWRkTWVudSh0aGlzLm1haW5fbWVudSwgJ21haW4nKTtcbiAgICB9XG4gICAgaW5pdE9wdGlvbnNNZW51KCkge1xuICAgICAgICAvL09wdGlvbnMgbWVudVxuICAgICAgICBjb25zdCBvcHRpb25zX21lbnUgPSB0aGlzLmNyZWF0ZU1lbnUoKTtcbiAgICAgICAgY29uc3QgcGFjZV9zZWxlY3RvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICBjb25zdCBwYWNlX3NlbGVjdG9yX2xhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xuICAgICAgICBjb25zdCBwYWNlX3NlbGVjdG9yX2Ryb3Bkb3duID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2VsZWN0Jyk7XG4gICAgICAgIC8vIE1ha2UgZHJvcGRvd24gbmF2aWdhdGFibGUgYnkgYXJyb3cga2V5c1xuICAgICAgICB0aGlzLmFkZFRhYmJhYmxlRWxlbWVudChwYWNlX3NlbGVjdG9yX2Ryb3Bkb3duLCAxKTtcbiAgICAgICAgcGFjZV9zZWxlY3Rvci5jbGFzc0xpc3QuYWRkKCdwYWNlLXNlbGVjdG9yJyk7XG4gICAgICAgIHBhY2Vfc2VsZWN0b3JfbGFiZWwuaW5uZXJIVE1MID0gJ1BhY2U6ICc7XG4gICAgICAgIGZvciAoY29uc3QgcGFjZV9rZXkgaW4gY29uc3RhbnRzLnBhY2VzKSB7XG4gICAgICAgICAgICBjb25zdCBvcHRpb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdvcHRpb24nKTtcbiAgICAgICAgICAgIG9wdGlvbi52YWx1ZSA9IHBhY2Vfa2V5O1xuICAgICAgICAgICAgb3B0aW9uLmlubmVySFRNTCA9IHBhY2Vfa2V5O1xuICAgICAgICAgICAgbGV0IHNob3VsZF9iZV9zZWxlY3RlZCA9IHBhcnNlRmxvYXQocGFjZV9rZXkpID09IDEgLyBnbG9iYWxzLnNlY29uZHNfcGVyX3RpY2s7XG4gICAgICAgICAgICBpZiAoc2hvdWxkX2JlX3NlbGVjdGVkKSB7XG4gICAgICAgICAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHBhY2Vfc2VsZWN0b3JfZHJvcGRvd24uYXBwZW5kQ2hpbGQob3B0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICBtYWluX2V2ZW50cy5hZnRlcl9kYXRhX3Jlc2V0Lm9uKCgpID0+IHtcbiAgICAgICAgICAgIHBhY2Vfc2VsZWN0b3JfZHJvcGRvd24udmFsdWUgPSBcIjFcIjtcbiAgICAgICAgfSk7XG4gICAgICAgIHBhY2Vfc2VsZWN0b3IuYXBwZW5kQ2hpbGQocGFjZV9zZWxlY3Rvcl9sYWJlbCk7XG4gICAgICAgIHBhY2Vfc2VsZWN0b3IuYXBwZW5kQ2hpbGQocGFjZV9zZWxlY3Rvcl9kcm9wZG93bik7XG4gICAgICAgIGNvbnN0IG9wdGlvbnNfYmFjayA9IHRoaXMuY3JlYXRlTGlua0J1dHRvbignQmFjaycsICdtYWluJywgJ21lbnUtYnV0dG9uJywgMik7XG4gICAgICAgIGNvbnN0IHJlc2V0X2J1dHRvbiA9IHRoaXMuY3JlYXRlQnV0dG9uKCdSZXNldCBHYW1lJywgJ21lbnUtYnV0dG9uJywgMyk7XG4gICAgICAgIG9wdGlvbnNfbWVudS5hcHBlbmRDaGlsZChwYWNlX3NlbGVjdG9yKTtcbiAgICAgICAgb3B0aW9uc19tZW51LmFwcGVuZENoaWxkKG9wdGlvbnNfYmFjayk7XG4gICAgICAgIG9wdGlvbnNfbWVudS5hcHBlbmRDaGlsZChyZXNldF9idXR0b24pO1xuICAgICAgICAvL09wdGlvbnMgbWVudVxuICAgICAgICBwYWNlX3NlbGVjdG9yX2Ryb3Bkb3duLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIChlKSA9PiB7XG4gICAgICAgICAgICBnbG9iYWxzLnNlY29uZHNfcGVyX3RpY2sgPSAxIC8gcGFyc2VGbG9hdChlLnRhcmdldC52YWx1ZSk7XG4gICAgICAgICAgICBtYWluX2V2ZW50cy5vbl9yZXF1ZXN0X2RhdGFfc2F2ZS5lbWl0KCk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXNldF9idXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgICAgICAgICBtYWluX2V2ZW50cy5vbl9yZXF1ZXN0X2RhdGFfcmVzZXQuZW1pdCgpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5hZGRNZW51KG9wdGlvbnNfbWVudSwgJ29wdGlvbnMnKTtcbiAgICB9XG4gICAgaW5pdENvbGxlY3Rpb25NZW51KHBsYW50X3RlbXBsYXRlcywgdW5sb2NrZWRfcGxhbnRzLCBncm93bl9wbGFudHMpIHtcbiAgICAgICAgLy8gQ29sbGVjdGlvbiBtZW51XG4gICAgICAgIGNvbnN0IGNvbGxlY3Rpb25fbWVudSA9IHRoaXMuY3JlYXRlTWVudSgnbWVudS1ub24tY2VudGVyZWQnKTtcbiAgICAgICAgY29uc3QgY29sbGVjdGlvbl9iYWNrID0gdGhpcy5jcmVhdGVMaW5rQnV0dG9uKCdCYWNrJywgJ21haW4nLCAnbWVudS1idXR0b24nLCAxKTtcbiAgICAgICAgY29sbGVjdGlvbl9tZW51LmFwcGVuZENoaWxkKGNvbGxlY3Rpb25fYmFjayk7XG4gICAgICAgIGxldCBidXR0b25faW5kZXggPSAxO1xuICAgICAgICBmb3IgKGNvbnN0IHRlbXBsYXRlX2lkIGluIHBsYW50X3RlbXBsYXRlcykge1xuICAgICAgICAgICAgYnV0dG9uX2luZGV4Kys7XG4gICAgICAgICAgICBjb25zdCBwbGFudF9idXR0b24gPSB0aGlzLmNyZWF0ZUJ1dHRvbignJywgJ21lbnUtYnV0dG9uJywgYnV0dG9uX2luZGV4KTtcbiAgICAgICAgICAgIHBsYW50X2J1dHRvbi5jbGFzc0xpc3QuYWRkKCdwbGFudC1idXR0b24nKTtcbiAgICAgICAgICAgIC8vIGNvbnN0IHBsYW50ID0gYXdhaXQgUGxhbnQuZnJvbVRlbXBsYXRlKHRlbXBsYXRlX2lkLCB0ZW1wbGF0ZV9pZCwgdGhpcy5jYWNoZSlcbiAgICAgICAgICAgIGNvbnN0IHBsYW50X3RlbXBsYXRlID0gcGxhbnRfdGVtcGxhdGVzW3RlbXBsYXRlX2lkXTtcbiAgICAgICAgICAgIGNvbnN0IGltZ19lbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyk7XG4gICAgICAgICAgICBpbWdfZWxlbWVudC5jbGFzc0xpc3QuYWRkKCdjb2xsZWN0aW9uLWltYWdlJyk7XG4gICAgICAgICAgICB0aGlzLmNvbGxlY3Rpb25faW1hZ2VzW3RlbXBsYXRlX2lkXSA9IGltZ19lbGVtZW50O1xuICAgICAgICAgICAgcGxhbnRfYnV0dG9uLmFwcGVuZENoaWxkKGltZ19lbGVtZW50KTtcbiAgICAgICAgICAgIGNvbnN0IGlzX3BsYW50X3VubG9ja2VkID0gdW5sb2NrZWRfcGxhbnRzLmluY2x1ZGVzKHBsYW50X3RlbXBsYXRlLnBsYW50X2lkKTtcbiAgICAgICAgICAgIGNvbnN0IGlzX3BsYW50X2dyb3duID0gZ3Jvd25fcGxhbnRzLmluY2x1ZGVzKHBsYW50X3RlbXBsYXRlLnBsYW50X2lkKTtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlQ29sbGVjdGlvbkltYWdlKHBsYW50X3RlbXBsYXRlLCBpc19wbGFudF91bmxvY2tlZCwgaXNfcGxhbnRfZ3Jvd24pO1xuICAgICAgICAgICAgY29sbGVjdGlvbl9tZW51LmFwcGVuZENoaWxkKHBsYW50X2J1dHRvbik7XG4gICAgICAgIH1cbiAgICAgICAgbWFpbl9ldmVudHMuYWZ0ZXJfZGF0YV9yZXNldC5vbigoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlc2V0Q29sbGVjdGlvbkltYWdlcyhwbGFudF90ZW1wbGF0ZXMpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5hZGRNZW51KGNvbGxlY3Rpb25fbWVudSwgJ2NvbGxlY3Rpb24nKTtcbiAgICB9XG4gICAgaW5pdFBsYW50RW50cnlNZW51KCkge1xuICAgICAgICAvL1BsYW50IEVudHJ5XG4gICAgICAgIGNvbnN0IHBsYW50X21lbnUgPSB0aGlzLmNyZWF0ZU1lbnUoKTtcbiAgICAgICAgY29uc3QgcGxhbnRfYmFjayA9IHRoaXMuY3JlYXRlTGlua0J1dHRvbignQmFjaycsICdjb2xsZWN0aW9uJywgJ21lbnUtYnV0dG9uJywgMSk7XG4gICAgICAgIHRoaXMucGxhbnRfaW1hZ2UuY2xhc3NMaXN0LmFkZCgncGxhbnQtZW50cnktaW1hZ2UnKTtcbiAgICAgICAgY29uc3QgcGxhbnRfYnV0dG9uID0gdGhpcy5jcmVhdGVCdXR0b24oJ1BsYW50JywgJ21lbnUtYnV0dG9uJywgMik7XG4gICAgICAgIGNvbnN0IHN0YXRzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndWwnKTtcbiAgICAgICAgc3RhdHMuYXBwZW5kQ2hpbGQodGhpcy5wbGFudF9zdGFnZXMpO1xuICAgICAgICBzdGF0cy5hcHBlbmRDaGlsZCh0aGlzLnBsYW50X3RpbWVfdG9fZ3Jvdyk7XG4gICAgICAgIHN0YXRzLmFwcGVuZENoaWxkKHRoaXMucGxhbnRfd2F0ZXJfZnJlcXVlbmN5KTtcbiAgICAgICAgY29uc3QgaW5mbyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICBpbmZvLmNsYXNzTGlzdC5hZGQoJ3BsYW50LWVudHJ5LWluZm8nKTtcbiAgICAgICAgaW5mby5hcHBlbmRDaGlsZCh0aGlzLnBsYW50X2Rlc2NyaXB0aW9uKTtcbiAgICAgICAgaW5mby5hcHBlbmRDaGlsZChzdGF0cyk7XG4gICAgICAgIHBsYW50X21lbnUuYXBwZW5kQ2hpbGQocGxhbnRfYmFjayk7XG4gICAgICAgIHBsYW50X21lbnUuYXBwZW5kQ2hpbGQodGhpcy5wbGFudF9pbWFnZSk7XG4gICAgICAgIHBsYW50X21lbnUuYXBwZW5kQ2hpbGQodGhpcy5wbGFudF9uYW1lKTtcbiAgICAgICAgcGxhbnRfbWVudS5hcHBlbmRDaGlsZChpbmZvKTtcbiAgICAgICAgcGxhbnRfbWVudS5hcHBlbmRDaGlsZChwbGFudF9idXR0b24pO1xuICAgICAgICBwbGFudF9idXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgICAgICAgICBtYWluX2V2ZW50cy5vbl9yZXF1ZXN0X3BsYW50X25ld19wbGFudC5lbWl0KHRoaXMuY3VycmVudF9wbGFudF9pbl9tZW51LnBsYW50X2lkKTtcbiAgICAgICAgICAgIC8vdGhpcy5nYW1lLnBsYW50TmV3UGxhbnQodGhpcy5jdXJyZW50X3BsYW50X2luX21lbnUucGxhbnRfaWQpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5hZGRNZW51KHBsYW50X21lbnUsICdwbGFudCcpO1xuICAgIH1cbiAgICBpbml0SGVscE1lbnUoKSB7XG4gICAgICAgIGNvbnN0IGhlbHBfbWVudSA9IHRoaXMuY3JlYXRlTWVudSgnbWVudS1ub24tY2VudGVyZWQnKTtcbiAgICAgICAgY29uc3QgYmFja19idXR0b24gPSB0aGlzLmNyZWF0ZUxpbmtCdXR0b24oJ0JhY2snLCAnbWFpbicsIG51bGwsIDEpO1xuICAgICAgICBjb25zdCB0ZXh0X2VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XG4gICAgICAgIHRleHRfZWxlbWVudC5pbm5lckhUTUwgPSBgV2VsY29tZSB0byBNeSBQaXhlbCBQbGFudC4gVGhpcyBpcyBhIHNtYWxsIHJlbGF4aW5nIGdhbWUgd2hlcmUgdGhlIHNvbGVcbiAgICAgICAgcHVycG9zZSBpcyB0byBqdXN0IHdhdGVyIHlvdXIgcGxhbnQgYW5kIHdhdGNoIGl0IGdyb3cuPGJyPjxicj5cbiAgICAgICAgXG4gICAgICAgIEVhY2ggcGxhbnQgaGFzIHNldmVyYWwgc3RhZ2VzIG9mIGdyb3d0aCwgZWFjaCBvZiB2YXJ5aW5nIGxlbmd0aHMuIDxicj48YnI+XG4gICAgICAgIFxuICAgICAgICBBIHBsYW50IGhhcyBhIHdhdGVyIGxldmVsIC0gd2hpY2ggaW5kaWNhdGVzIGhvdyBtdWNoIHdhdGVyIHRoZSBwbGFudCBoYXMuIFRoZSB3YXRlclxuICAgICAgICBsZXZlbHMgYXJlIHNwbGl0IGludG8gd2F0ZXIgbGV2ZWwgc3RhZ2VzLCBhbmQgdGhlIGxlc3Mgd2F0ZXIgYSBwbGFudCBoYXMsIHRoZSBzbG93ZXIgaXQgd2lsbCBncm93LiBUaGUgd2F0ZXIgbGV2ZWxcbiAgICAgICAgc3RhZ2VzIGFyZSBkaXZpZGVkIGJ5IGRhcmsgdmVydGljYWwgbGluZXMgdGhhdCB5b3UgY2FuIHNlZSBvbiB5b3VyIHdhdGVyIGxldmVsIGJhci4gPGJyPjxicj5cbiAgICAgICAgXG4gICAgICAgIFdoZW5ldmVyIHlvdSBncm93IGEgcGxhbnQsIGEgbmV3IHBsYW50IGdldHMgdW5sb2NrZWQuIEVhY2ggbmV3bHkgdW5sb2NrZWQgcGxhbnQgdGFrZXMgbG9uZ2VyIGFuZCBsb25nZXIgdG8gZ3Jvdy4gPGJyPjxicj5cbiAgICAgICAgXG4gICAgICAgIFRoZSBDb2xsZWN0aW9uIGlzIGEgcGxhY2Ugd2hlcmUgeW91IGNhbiB2aWV3IGFsbCBvZiB5b3VyIHVubG9ja2VkIHBsYW50IHR5cGVzIGFuZCBzb21lIGluZm9ybWF0aW9uIGFib3V0IHRoZW0sIHN1Y2ggYXMgaG93IGxvbmcgdGhleSB0YWtlIHRvIGdyb3csIGhvdyBtYW55IHN0YWdlc1xuICAgICAgICB0aGV5IGhhdmUsIGFuZCBob3cgZnJlcXVlbnRseSB0aGV5IGhhdmUgdG8gYmUgd2F0ZXJlZC4gQ3VycmVudGx5IHRoZXJlIGFyZSA0IHBsYW50IHR5cGVzIGluIHRoZSBnYW1lLiA8YnI+PGJyPlxuICAgICAgICBcbiAgICAgICAgR29vZCBsdWNrIHdpdGggeW91ciBwbGFudHMgYW5kIEkgaG9wZSB5b3UnbGwgaGF2ZSBmdW4gcGxheWluZyB0aGlzIGxpdHRsZSBnYW1lIVxuICAgICAgICBgO1xuICAgICAgICBoZWxwX21lbnUuYXBwZW5kQ2hpbGQoYmFja19idXR0b24pO1xuICAgICAgICBoZWxwX21lbnUuYXBwZW5kQ2hpbGQodGV4dF9lbGVtZW50KTtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5hZGRNZW51KGhlbHBfbWVudSwgJ2hlbHAnKTtcbiAgICB9XG4gICAgaW5pdFVpKHBsYW50X3RlbXBsYXRlcywgdW5sb2NrZWRfcGxhbnRzLCBncm93bl9wbGFudHMsIGlzX25ld19nYW1lKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICB0aGlzLmluaXRHYW1lVUkoKTtcbiAgICAgICAgICAgIHRoaXMuaW5pdE1haW5NZW51KGlzX25ld19nYW1lKTtcbiAgICAgICAgICAgIHRoaXMuaW5pdE9wdGlvbnNNZW51KCk7XG4gICAgICAgICAgICB0aGlzLmluaXRQbGFudEVudHJ5TWVudSgpO1xuICAgICAgICAgICAgdGhpcy5pbml0Q29sbGVjdGlvbk1lbnUocGxhbnRfdGVtcGxhdGVzLCB1bmxvY2tlZF9wbGFudHMsIGdyb3duX3BsYW50cyk7XG4gICAgICAgICAgICB0aGlzLmluaXRIZWxwTWVudSgpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgc2V0UGxheUJ1dHRvblRleHQoc3RyKSB7XG4gICAgICAgIHRoaXMucGxheV9idXR0b24uaW5uZXJIVE1MID0gc3RyO1xuICAgIH1cbiAgICBhZGRUYWJiYWJsZUVsZW1lbnQoZWxlbWVudCwgaW5kZXgpIHtcbiAgICAgICAgZWxlbWVudC50YWJJbmRleCA9IGluZGV4O1xuICAgICAgICB0aGlzLnRhYmJhYmxlX2VsZW1lbnRzLnB1c2goZWxlbWVudCk7XG4gICAgfVxuICAgIGNyZWF0ZUJ1dHRvbih0ZXh0LCBjbGFzc19uYW1lID0gbnVsbCwgaW5kZXggPSBudWxsLCBvbl9jbGljayA9IG51bGwpIHtcbiAgICAgICAgY29uc3QgYnRuID0gdGhpcy5idXR0b24uY2xvbmVOb2RlKCk7XG4gICAgICAgIGJ0bi5jbGFzc0xpc3QuYWRkKGNsYXNzX25hbWUpO1xuICAgICAgICBidG4uaW5uZXJIVE1MID0gdGV4dDtcbiAgICAgICAgaWYgKGluZGV4KSB7XG4gICAgICAgICAgICB0aGlzLmFkZFRhYmJhYmxlRWxlbWVudChidG4sIGluZGV4KTtcbiAgICAgICAgfVxuICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgICAgICAgICBpZiAob25fY2xpY2spIHtcbiAgICAgICAgICAgICAgICBvbl9jbGljaygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGJ0bjtcbiAgICB9XG4gICAgY3JlYXRlTGlua0J1dHRvbih0ZXh0ID0gXCJcIiwgbGlua190byA9IFwiXCIsIGNsYXNzX25hbWUgPSBudWxsLCBpbmRleCA9IG51bGwsIG9uX2NsaWNrID0gbnVsbCkge1xuICAgICAgICBjb25zdCBidG4gPSB0aGlzLmNyZWF0ZUJ1dHRvbih0ZXh0LCBjbGFzc19uYW1lLCBpbmRleCk7XG4gICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcbiAgICAgICAgICAgIG1haW5fZXZlbnRzLm9uX3JlcXVlc3Rfc2hvd19tZW51LmVtaXQobGlua190byk7XG4gICAgICAgICAgICBpZiAob25fY2xpY2spIHtcbiAgICAgICAgICAgICAgICBvbl9jbGljaygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGJ0bjtcbiAgICB9XG4gICAgY3JlYXRlVmlld0J1dHRvbih0ZXh0ID0gXCJcIiwgbGlua190bywgY2xhc3NfbmFtZSA9IFwiXCIsIGluZGV4ID0gbnVsbCwgb25fY2xpY2sgPSBudWxsKSB7XG4gICAgICAgIGNvbnN0IGJ0biA9IHRoaXMuY3JlYXRlQnV0dG9uKHRleHQsIGNsYXNzX25hbWUsIGluZGV4KTtcbiAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgICAgICAgICAgbWFpbl9ldmVudHMub25fcmVxdWVzdF9zZXRfdmlldy5lbWl0KGxpbmtfdG8pO1xuICAgICAgICAgICAgaWYgKG9uX2NsaWNrKSB7XG4gICAgICAgICAgICAgICAgb25fY2xpY2soKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBidG47XG4gICAgfVxuICAgIGNyZWF0ZU1lbnUoY2xhc3NfbmFtZSA9IG51bGwpIHtcbiAgICAgICAgY29uc3QgbWVudSA9IHRoaXMubWVudS5jbG9uZU5vZGUoKTtcbiAgICAgICAgbWVudS5jbGFzc0xpc3QuYWRkKGNsYXNzX25hbWUpO1xuICAgICAgICByZXR1cm4gbWVudTtcbiAgICB9XG4gICAgc2hvd1BsYW50TWVudShwbGFudF90ZW1wbGF0ZSwgaXNfcGxhbnRfZ3Jvd24pIHtcbiAgICAgICAgdGhpcy5wbGFudF9pbWFnZS5zcmMgPSBpc19wbGFudF9ncm93biA/IGdldFBsYW50VGVtcGxhdGVGdWxseUdyb3duSW1hZ2VVUkwocGxhbnRfdGVtcGxhdGUpIDogcGxhbnRfdGVtcGxhdGUuc3RhZ2VzWzBdLmltYWdlX3VybDtcbiAgICAgICAgdGhpcy5wbGFudF9uYW1lLmlubmVySFRNTCA9IHBsYW50X3RlbXBsYXRlLm5hbWU7XG4gICAgICAgIHRoaXMucGxhbnRfZGVzY3JpcHRpb24uaW5uZXJIVE1MID0gcGxhbnRfdGVtcGxhdGUuZGVzY3JpcHRpb247XG4gICAgICAgIHRoaXMucGxhbnRfc3RhZ2VzLmlubmVySFRNTCA9IFwiPGI+U3RhZ2VzOiA8L2I+XCIgKyBwbGFudF90ZW1wbGF0ZS5zdGFnZXMubGVuZ3RoO1xuICAgICAgICBjb25zdCB0aW1lX3RvX2dyb3dfc2Vjb25kcyA9IHRlbXBsYXRlVGltZVRvR3JvdyhwbGFudF90ZW1wbGF0ZSwgZ2xvYmFscy5zZWNvbmRzX3Blcl90aWNrKTtcbiAgICAgICAgY29uc3QgdGltZV90b19ncm93X3N0ciA9IGh1bWFuUmVhZGFibGVUaW1lRnJvbVNlY29uZHModGltZV90b19ncm93X3NlY29uZHMpO1xuICAgICAgICB0aGlzLnBsYW50X3RpbWVfdG9fZ3Jvdy5pbm5lckhUTUwgPSBcIjxiPlRpbWUgdG8gZ3JvdyBhdCBtYXggd2F0ZXIgbGV2ZWw6IDwvYj5cIiArIHRpbWVfdG9fZ3Jvd19zdHI7XG4gICAgICAgIGNvbnN0IHdhdGVyX2ZyZXF1ZW5jeV9zZWNvbmRzID0gdGVtcGxhdGVXYXRlcmluZ0ZyZXF1ZW5jeShwbGFudF90ZW1wbGF0ZSwgZ2xvYmFscy5zZWNvbmRzX3Blcl90aWNrKTtcbiAgICAgICAgY29uc3Qgd2F0ZXJfZnJlcXVlbmN5X3N0ciA9IGh1bWFuUmVhZGFibGVUaW1lRnJvbVNlY29uZHMod2F0ZXJfZnJlcXVlbmN5X3NlY29uZHMpO1xuICAgICAgICB0aGlzLnBsYW50X3dhdGVyX2ZyZXF1ZW5jeS5pbm5lckhUTUwgPSBcIjxiPk11c3QgYmUgd2F0ZXJlZCBhdCBsZWFzdCBldmVyeTogPC9iPlwiICsgd2F0ZXJfZnJlcXVlbmN5X3N0cjtcbiAgICAgICAgdGhpcy5jdXJyZW50X3BsYW50X2luX21lbnUgPSBwbGFudF90ZW1wbGF0ZTtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5zaG93TWVudSgncGxhbnQnKTtcbiAgICB9XG4gICAgZGlzcGxheVByb2dyZXNzTWVzc2FnZShwbGFudCwgcGxhbnRfdGVtcGxhdGVzLCBmZiA9IHRydWUsIGdyb3d0aF9iZWZvcmUgPSBudWxsLCBncm93dGhfYWZ0ZXIgPSBudWxsLCBzZWNvbmRzX2VsYXBzZWQgPSBudWxsKSB7XG4gICAgICAgIGxldCBzaG93X3BsYW50X2J1dHRvbiA9IGZhbHNlO1xuICAgICAgICBsZXQgbWVzc2FnZSA9IFwiXCI7XG4gICAgICAgIGNvbnN0IHRpbWUgPSBzZWNvbmRzVG9UaW1lKHNlY29uZHNfZWxhcHNlZCk7XG4gICAgICAgIGxldCBoYXNfdGltZSA9IHRpbWUubSA+IDA7XG4gICAgICAgIGlmIChoYXNfdGltZSAmJiBmZikge1xuICAgICAgICAgICAgY29uc3QgZ3Jvd3RoX2RpZmZlcmVuY2UgPSBncm93dGhfYWZ0ZXIgLSBncm93dGhfYmVmb3JlO1xuICAgICAgICAgICAgbGV0IGdyb3d0aF9wZXJjZW50ID0gZ3Jvd3RoX2RpZmZlcmVuY2UgLyBwbGFudC5tYXhHcm93dGgoKSAqIDEwMDtcbiAgICAgICAgICAgIGlmIChwbGFudC5pc0Z1bGx5R3Jvd24oKSkge1xuICAgICAgICAgICAgICAgIGdyb3d0aF9wZXJjZW50ID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG1lc3NhZ2UgPSB0aGlzLnByb2dyZXNzTWVzc2FnZVRleHQodGltZSwgZ3Jvd3RoX3BlcmNlbnQpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKCFmZikge1xuICAgICAgICAgICAgbWVzc2FnZSA9IHRoaXMucHJvZ3Jlc3NNZXNzYWdlVGV4dCh7IGg6IDAsIG06IDAgfSwgdHJ1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdW5sb2NrID0gZ2V0VGVtcGxhdGVVbmxvY2socGxhbnQucGxhbnRfaWQsIHBsYW50X3RlbXBsYXRlcyk7XG4gICAgICAgIGlmIChwbGFudC5pc0Z1bGx5R3Jvd24oKSAmJiB1bmxvY2spIHtcbiAgICAgICAgICAgIG1lc3NhZ2UgKz0gJzxicj48Yj5Zb3UgaGF2ZSB1bmxvY2tlZCBhIG5ldyBwbGFudCAtICcgKyB1bmxvY2submFtZSArICcuIFdvdWxkIHlvdSBsaWtlIHRvIHBsYW50IGl0Pyc7XG4gICAgICAgICAgICBnbG9iYWxzLnJlY2VudGx5X3VubG9ja2VkID0gdW5sb2NrLnBsYW50X2lkO1xuICAgICAgICAgICAgc2hvd19wbGFudF9idXR0b24gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChzaG93X3BsYW50X2J1dHRvbikge1xuICAgICAgICAgICAgdGhpcy5wcm9ncmVzc19tZXNzYWdlX3BsYW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnByb2dyZXNzX21lc3NhZ2VfcGxhbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnByb2dyZXNzX21lc3NhZ2UuaW5uZXJIVE1MID0gbWVzc2FnZTtcbiAgICAgICAgdGhpcy5wcm9ncmVzc19tZXNzYWdlX2NvbnRhaW5lci5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnO1xuICAgICAgICB0aGlzLnByb2dyZXNzX21lc3NhZ2VfY29udGFpbmVyLmZvY3VzKCk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIElmIHlvdSB3YW50IHRvIGluZGljYXRlIHRoYXQgdGhlIHBsYW50IGhhcyBmdWxseSBncm93biwgcGFzcyAndHJ1ZScgZm9yIGBncm93dGhfcGVyY2VudGFnZWBcbiAgICAgKi9cbiAgICBwcm9ncmVzc01lc3NhZ2VUZXh0KHRpbWUsIGdyb3d0aF9wZXJjZW50YWdlKSB7XG4gICAgICAgIGNvbnN0IGF3YXlfc3RyID0gdGltZS5oID4gMCB8fCB0aW1lLm0gPiAwID8gJ1lvdSB3ZXJlIGF3YXkgZm9yJyA6ICcnO1xuICAgICAgICBjb25zdCBocnNfc3RyID0gdGltZS5oID09IDEgPyAnMSBob3VyJyA6IHRpbWUuaCA+IDAgPyB0aW1lLmggKyAnIGhvdXJzJyA6ICcnO1xuICAgICAgICBjb25zdCBtaW5zX3N0ciA9IHRpbWUubSA9PSAxID8gJzEgbWludXRlJyA6IHRpbWUubSA+IDAgPyB0aW1lLm0gKyAnIG1pbnV0ZXMnIDogJyc7XG4gICAgICAgIGNvbnN0IGFuZF9zdHIgPSB0aW1lLmggPiAwICYmIHRpbWUubSA+IDAgPyAnYW5kJyA6ICcnO1xuICAgICAgICBjb25zdCBncm93dGhfc3RyID0gdHlwZW9mIGdyb3d0aF9wZXJjZW50YWdlID09PSAnYm9vbGVhbicgPyAnZnVsbHkgZ3Jvd24nIDogJ2dyb3duIGJ5ICcgKyBncm93dGhfcGVyY2VudGFnZS50b0ZpeGVkKDIpICsgJyAlJztcbiAgICAgICAgcmV0dXJuIGAke2F3YXlfc3RyfSAke2hyc19zdHJ9ICR7YW5kX3N0cn0gJHttaW5zX3N0cn0gJHthbmRfc3RyfSB5b3VyIHBsYW50IGhhcyAke2dyb3d0aF9zdHJ9YDtcbiAgICB9XG4gICAgY2FsY3VsYXRlUG9zaXRpb25zKHBsYW50KSB7XG4gICAgICAgIHRoaXMud2F0ZXJfYnV0dG9uLnN0eWxlLnRvcCA9IHBsYW50LnBvc2l0aW9uLnkgKiBjb25zdGFudHMuc2NhbGUgKyAyMDAgKyAncHgnO1xuICAgICAgICB0aGlzLndhdGVyX2J1dHRvbi5zdHlsZS5sZWZ0ID0gd2luZG93LmlubmVyV2lkdGggLyAyICsgJ3B4JztcbiAgICB9XG4gICAgdXBkYXRlQ29sbGVjdGlvbkltYWdlKHBsYW50X3RlbXBsYXRlLCBpc19wbGFudF91bmxvY2tlZCwgaXNfcGxhbnRfZ3Jvd24pIHtcbiAgICAgICAgY29uc3QgaW1nX2VsZW1lbnQgPSB0aGlzLmNvbGxlY3Rpb25faW1hZ2VzW3BsYW50X3RlbXBsYXRlLnBsYW50X2lkXTtcbiAgICAgICAgY29uc3QgcGxhbnRfYnV0dG9uID0gaW1nX2VsZW1lbnQuY2xvc2VzdCgnYnV0dG9uJyk7XG4gICAgICAgIGlmIChpc19wbGFudF91bmxvY2tlZCkge1xuICAgICAgICAgICAgbGV0IHN0YWdlID0gMDtcbiAgICAgICAgICAgIGlmIChpc19wbGFudF9ncm93bikge1xuICAgICAgICAgICAgICAgIHN0YWdlID0gZ2V0VGVtcGxhdGVNYXhTdGFnZUluZGV4KHBsYW50X3RlbXBsYXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vY29uc3QgaW1hZ2UgPSB0aGlzLmNhY2hlLmdldCgnaW1hZ2VfYmxvYnMvJyArIHBsYW50X3RlbXBsYXRlLnBsYW50X2lkICsgJy8nICsgbWF4X3N0YWdlKVxuICAgICAgICAgICAgY29uc3QgaW1hZ2VfdXJsID0gcGxhbnRfdGVtcGxhdGUuc3RhZ2VzW3N0YWdlXS5pbWFnZV91cmw7IC8vVVJMLmNyZWF0ZU9iamVjdFVSTChpbWFnZSk7XG4gICAgICAgICAgICBpbWdfZWxlbWVudC5zcmMgPSBpbWFnZV91cmw7XG4gICAgICAgICAgICAvL0NoZWNrIGlmIHRleHQgaGFzIGFscmVhZHkgYmVlbiBhZGRlZCB0byB0aGUgYnV0dG9uXG4gICAgICAgICAgICBpZiAoIXBsYW50X2J1dHRvbi5xdWVyeVNlbGVjdG9yKCdwJykpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB0ZXh0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xuICAgICAgICAgICAgICAgIHRleHQuaW5uZXJIVE1MID0gcGxhbnRfdGVtcGxhdGUubmFtZTtcbiAgICAgICAgICAgICAgICBwbGFudF9idXR0b24uYXBwZW5kQ2hpbGQodGV4dCk7XG4gICAgICAgICAgICAgICAgLy9BZGRpdGlvbmFsbHkgd2UgY2FuIGFkZCB0aGUgZXZlbnQgbGlzZXRlbmVyLCBiZWNhdXNlIHRoaXMgYWJvdmUgaWYgc3RhdGVtZW50XG4gICAgICAgICAgICAgICAgLy93aWxsIG9ubHkgYmUgdHJ1ZSBvbmNlLCB3aGVuIHRoZSBwbGFudCBpc24ndCB1bmxvY2tlZCBhbmQgdGhlcmUgaXMgbm8gdGV4dFxuICAgICAgICAgICAgICAgIHBsYW50X2J1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG93UGxhbnRNZW51KHBsYW50X3RlbXBsYXRlLCBpc19wbGFudF9ncm93bik7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBpbWdfZWxlbWVudC5zcmMgPSAnaW1hZ2VzL3F1ZXN0aW9uLW1hcmsuanBlZyc7XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmVzZXRDb2xsZWN0aW9uSW1hZ2VzKHBsYW50X3RlbXBsYXRlcykge1xuICAgICAgICBmb3IgKGNvbnN0IHRlbXBsYXRlX2lkIGluIHBsYW50X3RlbXBsYXRlcykge1xuICAgICAgICAgICAgaWYgKHRlbXBsYXRlX2lkICE9ICdiYXNpY19wbGFudCcpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUNvbGxlY3Rpb25JbWFnZShwbGFudF90ZW1wbGF0ZXNbdGVtcGxhdGVfaWRdLCBmYWxzZSwgZmFsc2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuIiwidmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgZnVuY3Rpb24gYWRvcHQodmFsdWUpIHsgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgUCA/IHZhbHVlIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZSh2YWx1ZSk7IH0pOyB9XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogYWRvcHQocmVzdWx0LnZhbHVlKS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5pbXBvcnQgbWFpbl9ldmVudHMgZnJvbSAnLi9tYWluX2V2ZW50cyc7XG5pbXBvcnQgUGxhbnQgZnJvbSAnLi9QbGFudCc7XG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTYXZlTWFuYWdlciB7XG4gICAgY29uc3RydWN0b3Ioc3RvcmFnZSwgY2FjaGUpIHtcbiAgICAgICAgdGhpcy5zdG9yYWdlID0gc3RvcmFnZTtcbiAgICAgICAgdGhpcy5jYWNoZSA9IGNhY2hlO1xuICAgIH1cbiAgICBzYXZlRGF0YShkYXRhKSB7XG4gICAgICAgIC8vSWYgY3VzdG9tIGRhdGEgb2JqZWN0IHdhcyBwYXNzZWQsIHNhdmUgdGhhdFxuICAgICAgICAvLyBpZihkYXRhKSB7XG4gICAgICAgIC8vICAgICB0aGlzLnN0b3JhZ2Uuc2V0KCdkYXRhJywgZGF0YSlcbiAgICAgICAgLy8gICAgIHJldHVybjtcbiAgICAgICAgLy8gfVxuICAgICAgICAvL090aGVyd2lzZSBnZXQgY3VycmVudCBwbGFudHMgYW5kIHNhdmUgdGhlbVxuICAgICAgICB0aGlzLnVwZGF0ZUNhY2hlZERhdGEoZGF0YSk7XG4gICAgICAgIHRoaXMuc2V0RGF0YSh0aGlzLmRhdGEpO1xuICAgIH1cbiAgICB1cGRhdGVDYWNoZWREYXRhKGRhdGEpIHtcbiAgICAgICAgaWYgKGRhdGEuc2Vjb25kc19wZXJfdGljayAhPSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMuZGF0YS5wYWNlID0gMSAvIGRhdGEuc2Vjb25kc19wZXJfdGljaztcbiAgICAgICAgfVxuICAgICAgICBpZiAoZGF0YS5wbGFudCAhPSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMuZGF0YS5wbGFudCA9IGRhdGEucGxhbnQudG9KU09OKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRhdGEubmV3X2dhbWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5kYXRhLm5ld19nYW1lID0gZGF0YS5uZXdfZ2FtZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZGF0YS51bmxvY2tlZF9wbGFudHMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5kYXRhLnVubG9ja2VkX3BsYW50cyA9IGRhdGEudW5sb2NrZWRfcGxhbnRzO1xuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhLmdyb3duX3BsYW50cyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLmRhdGEuZ3Jvd25fcGxhbnRzID0gZGF0YS5ncm93bl9wbGFudHM7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kYXRhLmxlYXZlX3RpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICB9XG4gICAgc2V0Q2FjaGVkRGF0YShkYXRhKSB7XG4gICAgICAgIHRoaXMuZGF0YSA9IGRhdGE7XG4gICAgfVxuICAgIGdldERlZmF1bHREYXRhKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgYmFzaWNfcGxhbnQgPSB5aWVsZCBQbGFudC5mcm9tVGVtcGxhdGUoMCwgJ2Jhc2ljX3BsYW50JywgdGhpcy5jYWNoZSk7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHBhY2U6IDEsXG4gICAgICAgICAgICAgICAgbWF4X2lkOiAxLFxuICAgICAgICAgICAgICAgIGxlYXZlX3RpbWU6IG51bGwsXG4gICAgICAgICAgICAgICAgdW5sb2NrZWRfcGxhbnRzOiBbXCJiYXNpY19wbGFudFwiXSxcbiAgICAgICAgICAgICAgICBncm93bl9wbGFudHM6IFtdLFxuICAgICAgICAgICAgICAgIHBsYW50OiBiYXNpY19wbGFudC50b0pTT04oKSxcbiAgICAgICAgICAgICAgICBuZXdfZ2FtZTogdHJ1ZSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBzZXREYXRhVG9EZWZhdWx0cygpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB5aWVsZCB0aGlzLmdldERlZmF1bHREYXRhKCk7XG4gICAgICAgICAgICB0aGlzLnNldERhdGEoZGF0YSk7XG4gICAgICAgICAgICBtYWluX2V2ZW50cy5hZnRlcl9kYXRhX3Jlc2V0LmVtaXQoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHNldERhdGEoZGF0YSkge1xuICAgICAgICB0aGlzLnNldENhY2hlZERhdGEoZGF0YSk7XG4gICAgICAgIHRoaXMuc3RvcmFnZS5zZXQoJ2RhdGEnLCBkYXRhKTtcbiAgICB9XG4gICAgcmVzZXREYXRhKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgeWllbGQgdGhpcy5zZXREYXRhVG9EZWZhdWx0cygpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgZ2V0RGF0YSgpIHtcbiAgICAgICAgaWYgKCF0aGlzLnN0b3JhZ2UuaGFzKCdkYXRhJykpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IHJldHJpZXZlIHNhdmUgZGF0YTogbm8gZGF0YSBpcyBzZXQnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy5zdG9yYWdlLmdldCgnZGF0YScpO1xuICAgIH1cbiAgICBzZXREYXRhSWZOdWxsKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgaWYgKCF0aGlzLnN0b3JhZ2UuaGFzKCdkYXRhJykpIHtcbiAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLnNldERhdGFUb0RlZmF1bHRzKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBkZWZhdWx0X2RhdGEgPSB5aWVsZCB0aGlzLmdldERlZmF1bHREYXRhKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhID0gT2JqZWN0LmFzc2lnbihPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0X2RhdGEpLCB0aGlzLmdldERhdGEoKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIGhvdyBsb25nIHRoZSB1c2VyIHdhcyBhd2F5IChub3QgaW4tZ2FtZSBvciB3aW5kb3cgbm90IGZvY3VzZWQpXG4gICAgICogQHJldHVybnNcbiAgICAgKi9cbiAgICBnZXRUaW1lQXdheSgpIHtcbiAgICAgICAgbGV0IGN1cnJlbnRfdGltZV9tcyA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgICAgICBsZXQgdGltZV9kaWZmZXJlbmNlX21zID0gY3VycmVudF90aW1lX21zIC0gdGhpcy5kYXRhLmxlYXZlX3RpbWU7XG4gICAgICAgIHJldHVybiB0aGlzLmRhdGEubGVhdmVfdGltZSA/ICh0aW1lX2RpZmZlcmVuY2VfbXMpIC8gMTAwMCA6IG51bGw7XG4gICAgfVxufVxuIiwidmFyIF9fYXdhaXRlciA9ICh0aGlzICYmIHRoaXMuX19hd2FpdGVyKSB8fCBmdW5jdGlvbiAodGhpc0FyZywgX2FyZ3VtZW50cywgUCwgZ2VuZXJhdG9yKSB7XG4gICAgZnVuY3Rpb24gYWRvcHQodmFsdWUpIHsgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgUCA/IHZhbHVlIDogbmV3IFAoZnVuY3Rpb24gKHJlc29sdmUpIHsgcmVzb2x2ZSh2YWx1ZSk7IH0pOyB9XG4gICAgcmV0dXJuIG5ldyAoUCB8fCAoUCA9IFByb21pc2UpKShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgIGZ1bmN0aW9uIGZ1bGZpbGxlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvci5uZXh0KHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gcmVqZWN0ZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3JbXCJ0aHJvd1wiXSh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHN0ZXAocmVzdWx0KSB7IHJlc3VsdC5kb25lID8gcmVzb2x2ZShyZXN1bHQudmFsdWUpIDogYWRvcHQocmVzdWx0LnZhbHVlKS50aGVuKGZ1bGZpbGxlZCwgcmVqZWN0ZWQpOyB9XG4gICAgICAgIHN0ZXAoKGdlbmVyYXRvciA9IGdlbmVyYXRvci5hcHBseSh0aGlzQXJnLCBfYXJndW1lbnRzIHx8IFtdKSkubmV4dCgpKTtcbiAgICB9KTtcbn07XG5pbXBvcnQgY29uc3RhbnRzIGZyb20gJy4vY29uc3QnO1xuaW1wb3J0IEltYWdlTG9hZGVyIGZyb20gJy4vSW1hZ2VMb2FkZXInO1xuaW1wb3J0IE15Q2FjaGUgZnJvbSAnLi9NeUNhY2hlJztcbmltcG9ydCBNeVN0b3JhZ2UgZnJvbSAnLi9NeVN0b3JhZ2UnO1xuaW1wb3J0IFBsYW50IGZyb20gJy4vUGxhbnQnO1xuaW1wb3J0IFJlbmRlcmVyIGZyb20gJy4vUmVuZGVyZXInO1xuaW1wb3J0IFVJTWFuYWdlciBmcm9tICcuL1VJTWFuYWdlcic7XG5pbXBvcnQgeyBnZXRWaWV3cG9ydENlbnRlciB9IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQgU2F2ZU1hbmFnZXIgZnJvbSAnLi9TYXZlTWFuYWdlcic7XG5pbXBvcnQgbWFpbl9ldmVudHMgZnJvbSAnLi9tYWluX2V2ZW50cyc7XG5pbXBvcnQgZ2xvYmFscyBmcm9tICcuL2dsb2JhbHMnO1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgR2FtZSB7XG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMucmVuZGVyZXIgPSBuZXcgUmVuZGVyZXIoJ2NhbnZhcycsICd1aScsICdtZW51cycpO1xuICAgICAgICB0aGlzLmNhY2hlID0gbmV3IE15Q2FjaGUoKTtcbiAgICAgICAgdGhpcy5zdG9yYWdlID0gbmV3IE15U3RvcmFnZSgpO1xuICAgICAgICB0aGlzLmRhdGEgPSBuZXcgU2F2ZU1hbmFnZXIodGhpcy5zdG9yYWdlLCB0aGlzLmNhY2hlKTtcbiAgICAgICAgdGhpcy51aSA9IG5ldyBVSU1hbmFnZXIodGhpcy5yZW5kZXJlcik7XG4gICAgICAgIHRoaXMuaW1hZ2VfbG9hZGVyID0gbmV3IEltYWdlTG9hZGVyKHRoaXMuY2FjaGUpO1xuICAgICAgICB0aGlzLmZpcnN0X2luaXQgPSBmYWxzZTsgLy9XaGV0aGVyIHRoaXMgdGhlIGdhbWUgaGFzIGJlZW4gaW5pdGlhbGl6ZWQgYXQgbGVhc3Qgb25jZVxuICAgICAgICB0aGlzLmxhc3RfZnJhbWVfdGltZSA9IDA7XG4gICAgICAgIHRoaXMuZGVsdGEgPSAwO1xuICAgICAgICB0aGlzLmRlbHRhX3N1bSA9IDA7XG4gICAgICAgIHRoaXMucGxhbnRfdGVtcGxhdGVzID0ge307XG4gICAgICAgIHRoaXMucGxhbnRzID0ge307XG4gICAgICAgIHRoaXMubG9hZGluZyA9IHRydWU7XG4gICAgICAgIHRoaXMuY3VycmVudF92aWV3ID0gbnVsbDtcbiAgICAgICAgbWFpbl9ldmVudHMub25fcmVxdWVzdF9kYXRhX3Jlc2V0Lm9uKHRoaXMub25SZXF1ZXN0RGF0YVJlc2V0LmJpbmQodGhpcykpO1xuICAgICAgICBtYWluX2V2ZW50cy5vbl9yZXF1ZXN0X2RhdGFfc2F2ZS5vbih0aGlzLm9uUmVxdWVzdERhdGFTYXZlLmJpbmQodGhpcykpO1xuICAgICAgICBtYWluX2V2ZW50cy5vbl9yZXF1ZXN0X3Nob3dfbWVudS5vbih0aGlzLm9uUmVxdWVzdFNob3dNZW51LmJpbmQodGhpcykpO1xuICAgICAgICBtYWluX2V2ZW50cy5vbl9yZXF1ZXN0X3NldF92aWV3Lm9uKHRoaXMub25SZXF1ZXN0U2V0Vmlldy5iaW5kKHRoaXMpKTtcbiAgICAgICAgbWFpbl9ldmVudHMub25fcmVxdWVzdF9mYXN0X2ZvcndhcmQub24odGhpcy5vblJlcXVlc3RGYXN0Rm9yd2FyZC5iaW5kKHRoaXMpKTtcbiAgICAgICAgbWFpbl9ldmVudHMub25fcmVxdWVzdF9wbGFudF9uZXdfcGxhbnQub24odGhpcy5vblJlcXVlc3RQbGFudE5ld1BsYW50LmJpbmQodGhpcykpO1xuICAgICAgICBtYWluX2V2ZW50cy5vbl9yZXF1ZXN0X3dhdGVyX3BsYW50Lm9uKHRoaXMub25SZXF1ZXN0V2F0ZXJQbGFudC5iaW5kKHRoaXMpKTtcbiAgICAgICAgbWFpbl9ldmVudHMuYWZ0ZXJfZGF0YV9yZXNldC5vbih0aGlzLmFmdGVyRGF0YVJlc2V0LmJpbmQodGhpcykpO1xuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZm9jdXMnLCAoKSA9PiB7XG4gICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50X3ZpZXcgPT0gJ3BsYW50JyAmJiAhdGhpcy5kYXRhLmRhdGEubmV3X2dhbWUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZhc3RGb3J3YXJkQnlTZWNvbmRzKHRoaXMuZGF0YS5nZXRUaW1lQXdheSgpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuaGlkZVVJKCk7XG4gICAgfVxuICAgIG9uUmVxdWVzdERhdGFSZXNldCgpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IGNvbmZpcm1fcmVzZXQgPSBjb25maXJtKCdBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gcmVzZXQgYWxsIGRhdGE/IFBsYW50IGRhdGEgYW5kIGNvbGxlY3Rpb24gd2lsbCBiZSBsb3N0Jyk7XG4gICAgICAgICAgICBpZiAoIWNvbmZpcm1fcmVzZXQpXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgeWllbGQgdGhpcy5kYXRhLnJlc2V0RGF0YSgpO1xuICAgICAgICAgICAgeWllbGQgdGhpcy5pbml0KCk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBhZnRlckRhdGFSZXNldCgpIHtcbiAgICAgICAgaWYgKHRoaXMudWkucGxheV9idXR0b24pIHtcbiAgICAgICAgICAgIHRoaXMudWkuc2V0UGxheUJ1dHRvblRleHQoJ05ldyBHYW1lJyk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgb25SZXF1ZXN0RGF0YVNhdmUoKSB7XG4gICAgICAgIHRoaXMuZGF0YS5zYXZlRGF0YSh7XG4gICAgICAgICAgICBzZWNvbmRzX3Blcl90aWNrOiBnbG9iYWxzLnNlY29uZHNfcGVyX3RpY2ssXG4gICAgICAgICAgICBwbGFudDogdGhpcy5wbGFudFxuICAgICAgICB9KTtcbiAgICB9XG4gICAgb25SZXF1ZXN0U2hvd01lbnUobWVudV9pZCkge1xuICAgICAgICB0aGlzLnNldFZpZXcobnVsbCk7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuc2hvd01lbnUobWVudV9pZCk7XG4gICAgfVxuICAgIG9uUmVxdWVzdFNldFZpZXcodmlld19pZCkge1xuICAgICAgICB0aGlzLnNldFZpZXcodmlld19pZCk7XG4gICAgfVxuICAgIG9uUmVxdWVzdEZhc3RGb3J3YXJkKCkge1xuICAgICAgICB0aGlzLmZhc3RGb3J3YXJkQnlTZWNvbmRzKHRoaXMuZGF0YS5nZXRUaW1lQXdheSgpKTtcbiAgICB9XG4gICAgb25SZXF1ZXN0V2F0ZXJQbGFudCgpIHtcbiAgICAgICAgdGhpcy53YXRlckN1cnJlbnRQbGFudCgpO1xuICAgIH1cbiAgICBvblJlcXVlc3RQbGFudE5ld1BsYW50KHRlbXBsYXRlX2lkKSB7XG4gICAgICAgIHRoaXMucGxhbnROZXdQbGFudCh0ZW1wbGF0ZV9pZCk7XG4gICAgfVxuICAgIGluaXQoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICB0aGlzLnNldExvYWRpbmcodHJ1ZSk7XG4gICAgICAgICAgICB5aWVsZCB0aGlzLmluaXRUZW1wbGF0ZXMoKTtcbiAgICAgICAgICAgIHlpZWxkIHRoaXMuaW5pdEltYWdlcygpO1xuICAgICAgICAgICAgeWllbGQgdGhpcy5kYXRhLnNldERhdGFJZk51bGwoKTtcbiAgICAgICAgICAgIHRoaXMuaW5pdFRlbXBsYXRlSW1hZ2VVUkxzKCk7XG4gICAgICAgICAgICBnbG9iYWxzLnNlY29uZHNfcGVyX3RpY2sgPSAxIC8gdGhpcy5kYXRhLmRhdGEucGFjZTtcbiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5jYWxjdWxhdGVQb3NpdGlvbnMoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgY29uc29sZS5sb2codGhpcy5kYXRhLmRhdGEpO1xuICAgICAgICAgICAgaWYgKCF0aGlzLmZpcnN0X2luaXQpIHtcbiAgICAgICAgICAgICAgICB5aWVsZCB0aGlzLnVpLmluaXRVaSh0aGlzLnBsYW50X3RlbXBsYXRlcywgdGhpcy5kYXRhLmRhdGEudW5sb2NrZWRfcGxhbnRzLCB0aGlzLmRhdGEuZGF0YS5ncm93bl9wbGFudHMsIHRoaXMuZGF0YS5kYXRhLm5ld19nYW1lKTtcbiAgICAgICAgICAgICAgICB0aGlzLmZpcnN0X2luaXQgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgeWllbGQgdGhpcy5pbml0UGxhbnRzKCk7XG4gICAgICAgICAgICB0aGlzLmNhbGN1bGF0ZVBvc2l0aW9ucygpO1xuICAgICAgICAgICAgdGhpcy5zZXRMb2FkaW5nKGZhbHNlKTtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuc2hvd01lbnUoJ21haW4nKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGluaXRJbWFnZXMoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IHRlbXBsYXRlX2lkIGluIHRoaXMucGxhbnRfdGVtcGxhdGVzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB0aGlzLnBsYW50X3RlbXBsYXRlc1t0ZW1wbGF0ZV9pZF07XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0ZW1wbGF0ZS5zdGFnZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5pbWFnZV9sb2FkZXIubG9hZFRlbXBsYXRlSW1hZ2VJZk51bGwodGVtcGxhdGUucGxhbnRfaWQsIGkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGluaXRQbGFudHMoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBwbGFudCA9IHlpZWxkIFBsYW50LmZyb21KU09OKHRoaXMuZGF0YS5kYXRhLnBsYW50LCB0aGlzLmNhY2hlKTtcbiAgICAgICAgICAgIHRoaXMuc2V0UGxhbnQocGxhbnQpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgaW5pdFRlbXBsYXRlcygpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgdGVtcGxhdGVfaWQgb2YgY29uc3RhbnRzLnBsYW50X3RlbXBsYXRlX2lkcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlcyA9IHlpZWxkIGZldGNoKCdwbGFudF90ZW1wbGF0ZXMvJyArIHRlbXBsYXRlX2lkICsgJy5qc29uJyk7XG4gICAgICAgICAgICAgICAgY29uc3QganNvbiA9IHlpZWxkIHJlcy5qc29uKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5wbGFudF90ZW1wbGF0ZXNbdGVtcGxhdGVfaWRdID0ganNvbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGluaXRUZW1wbGF0ZUltYWdlVVJMcygpIHtcbiAgICAgICAgZm9yIChjb25zdCB0ZW1wbGF0ZV9pZCBpbiB0aGlzLnBsYW50X3RlbXBsYXRlcykge1xuICAgICAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB0aGlzLnBsYW50X3RlbXBsYXRlc1t0ZW1wbGF0ZV9pZF07XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGkgaW4gdGVtcGxhdGUuc3RhZ2VzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaW1hZ2UgPSB0aGlzLmNhY2hlLmdldCgnaW1hZ2VfYmxvYnMvJyArIHRlbXBsYXRlLnBsYW50X2lkICsgJy8nICsgaSk7XG4gICAgICAgICAgICAgICAgdGVtcGxhdGUuc3RhZ2VzW2ldLmltYWdlX3VybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoaW1hZ2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIG9uUGxhbnRGdWxseUdyb3duKHBsYW50KSB7XG4gICAgICAgIHRoaXMudWkuZGlzcGxheVByb2dyZXNzTWVzc2FnZSh0aGlzLnBsYW50LCB0aGlzLnBsYW50X3RlbXBsYXRlcywgZmFsc2UpO1xuICAgICAgICB0aGlzLmRhdGEuc2F2ZURhdGEoe1xuICAgICAgICAgICAgcGxhbnQ6IHRoaXMucGxhbnQsXG4gICAgICAgICAgICB1bmxvY2tlZF9wbGFudHM6IFsuLi50aGlzLmRhdGEuZGF0YS51bmxvY2tlZF9wbGFudHMsIHBsYW50LnVubG9ja3NdLFxuICAgICAgICAgICAgZ3Jvd25fcGxhbnRzOiBbLi4udGhpcy5kYXRhLmRhdGEuZ3Jvd25fcGxhbnRzLCBwbGFudC5wbGFudF9pZF1cbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChwbGFudC51bmxvY2tzKSB7XG4gICAgICAgICAgICBjb25zdCB1bmxvY2tlZF90ZW1wbGF0ZSA9IHRoaXMucGxhbnRfdGVtcGxhdGVzW3BsYW50LnVubG9ja3NdO1xuICAgICAgICAgICAgdGhpcy51aS51cGRhdGVDb2xsZWN0aW9uSW1hZ2UodW5sb2NrZWRfdGVtcGxhdGUsIHRydWUsIGZhbHNlKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnVpLnVwZGF0ZUNvbGxlY3Rpb25JbWFnZSh0aGlzLnBsYW50X3RlbXBsYXRlc1twbGFudC5wbGFudF9pZF0sIHRydWUsIHRydWUpO1xuICAgIH1cbiAgICBmYXN0Rm9yd2FyZEJ5U2Vjb25kcyhzZWNvbmRzKSB7XG4gICAgICAgIGlmICh0aGlzLmRhdGEuZGF0YS5uZXdfZ2FtZSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICghc2Vjb25kcykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGdyb3d0aF9iZWZvcmUgPSB0aGlzLnBsYW50Lmdyb3d0aDtcbiAgICAgICAgY29uc3QgdGlja3MgPSB0aGlzLmdldFRpY2tzQnlTZWNvbmRzKHNlY29uZHMpO1xuICAgICAgICB0aGlzLnBsYW50LmZhc3RGb3J3YXJkKHRpY2tzKTtcbiAgICAgICAgY29uc3QgZ3Jvd3RoX2FmdGVyID0gdGhpcy5wbGFudC5ncm93dGg7XG4gICAgICAgIHRoaXMudWkuZGlzcGxheVByb2dyZXNzTWVzc2FnZSh0aGlzLnBsYW50LCB0aGlzLnBsYW50X3RlbXBsYXRlcywgdHJ1ZSwgZ3Jvd3RoX2JlZm9yZSwgZ3Jvd3RoX2FmdGVyLCBzZWNvbmRzKTtcbiAgICB9XG4gICAgZ2V0VGlja3NCeVNlY29uZHMoc2Vjb25kcykge1xuICAgICAgICByZXR1cm4gc2Vjb25kcyAvIGdsb2JhbHMuc2Vjb25kc19wZXJfdGljaztcbiAgICB9XG4gICAgc2V0Vmlldyh2aWV3X25hbWUpIHtcbiAgICAgICAgdGhpcy5jdXJyZW50X3ZpZXcgPSB2aWV3X25hbWU7XG4gICAgICAgIGlmICh2aWV3X25hbWUpIHtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuaGlkZU1lbnUoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodmlld19uYW1lID09ICdwbGFudCcpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmRhdGEuZGF0YS5uZXdfZ2FtZSA9PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhLnNhdmVEYXRhKHtcbiAgICAgICAgICAgICAgICAgICAgbmV3X2dhbWU6IGZhbHNlXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGhpcy51aS5zZXRQbGF5QnV0dG9uVGV4dCgnTXkgUGxhbnQnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBjYWxjdWxhdGVQb3NpdGlvbnMoKSB7XG4gICAgICAgIHRoaXMucGxhbnQuc2V0UG9zaXRpb24oZ2V0Vmlld3BvcnRDZW50ZXIoKSk7XG4gICAgICAgIHRoaXMudWkuY2FsY3VsYXRlUG9zaXRpb25zKHRoaXMucGxhbnQpO1xuICAgIH1cbiAgICBzZXRMb2FkaW5nKGxvYWRpbmcpIHtcbiAgICAgICAgdGhpcy5sb2FkaW5nID0gbG9hZGluZztcbiAgICAgICAgaWYgKHRoaXMubG9hZGluZykge1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJlci51aS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICAgICAgaWYgKHRoaXMucmVuZGVyZXIubWVudSkge1xuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuY3VycmVudE1lbnUoKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgaWYgKHRoaXMucmVuZGVyZXIubWVudSkge1xuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuY3VycmVudE1lbnUoKS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyZXIudWkuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgc3RhcnQoKSB7XG4gICAgICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5nYW1lTG9vcC5iaW5kKHRoaXMpKTtcbiAgICB9XG4gICAgdGljaygpIHtcbiAgICAgICAgdGhpcy5kYXRhLnNhdmVEYXRhKHtcbiAgICAgICAgICAgIHBsYW50OiB0aGlzLnBsYW50XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnBsYW50LnRpY2soKTtcbiAgICB9XG4gICAgZHJhdygpIHtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5jbGVhcigpO1xuICAgICAgICBpZiAoIXRoaXMubG9hZGluZyAmJiAhdGhpcy5yZW5kZXJlci5tZW51ICYmIHRoaXMuY3VycmVudF92aWV3ID09ICdwbGFudCcpIHtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIuZHJhd1BsYW50KHRoaXMucGxhbnQpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHdhdGVyQ3VycmVudFBsYW50KCkge1xuICAgICAgICB0aGlzLnBsYW50LndhdGVyX2xldmVsLnRvcCgpO1xuICAgICAgICB0aGlzLnBsYW50LnVwZGF0ZVdhdGVyTGV2ZWxCYXIoKTtcbiAgICB9XG4gICAgZ2FtZUxvb3AoKSB7XG4gICAgICAgIHRoaXMuY2FsY3VsYXRlRGVsdGFTdW0oKTtcbiAgICAgICAgaWYgKHRoaXMuZGVsdGFfc3VtID4gZ2xvYmFscy5zZWNvbmRzX3Blcl90aWNrICYmICF0aGlzLmxvYWRpbmcgJiYgdGhpcy5jdXJyZW50X3ZpZXcgPT0gJ3BsYW50Jykge1xuICAgICAgICAgICAgdGhpcy50aWNrKCk7XG4gICAgICAgICAgICB0aGlzLmRlbHRhX3N1bSA9IDA7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kcmF3KCk7XG4gICAgICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5nYW1lTG9vcC5iaW5kKHRoaXMpKTtcbiAgICB9XG4gICAgY2FsY3VsYXRlRGVsdGFTdW0oKSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRfdGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgICAgICB0aGlzLmRlbHRhID0gKGN1cnJlbnRfdGltZSAtIHRoaXMubGFzdF9mcmFtZV90aW1lKSAvIDEwMDA7XG4gICAgICAgIHRoaXMubGFzdF9mcmFtZV90aW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgICAgIHRoaXMuZGVsdGFfc3VtICs9IHRoaXMuZGVsdGE7XG4gICAgfVxuICAgIC8vIGNyZWF0ZVBsYW50KHBsYW50OiBQbGFudCkge1xuICAgIC8vICAgICB0aGlzLnBsYW50c1twbGFudC5pZF0gPSBwbGFudDtcbiAgICAvLyB9XG4gICAgcGxhbnROZXdQbGFudCh0ZW1wbGF0ZV9pZCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgcGxhbnQgPSB5aWVsZCBQbGFudC5mcm9tVGVtcGxhdGUoJ215X3BsYW50JywgdGVtcGxhdGVfaWQsIHRoaXMuY2FjaGUpO1xuICAgICAgICAgICAgdGhpcy5zZXRQbGFudChwbGFudCk7XG4gICAgICAgICAgICB0aGlzLnNldFZpZXcoJ3BsYW50Jyk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBzZXRQbGFudChwbGFudCkge1xuICAgICAgICB0aGlzLnBsYW50ID0gcGxhbnQ7XG4gICAgICAgIHRoaXMucGxhbnQub25GdWxseUdyb3duKHRoaXMub25QbGFudEZ1bGx5R3Jvd24uYmluZCh0aGlzKSk7XG4gICAgfVxuICAgIHVubG9ja0FsbCgpIHtcbiAgICAgICAgdGhpcy5kYXRhLnNhdmVEYXRhKHtcbiAgICAgICAgICAgIHVubG9ja2VkX3BsYW50czogWy4uLmNvbnN0YW50cy5wbGFudF90ZW1wbGF0ZV9pZHNdXG4gICAgICAgIH0pO1xuICAgICAgICBhbGVydCgnQWxsIHBsYW50cyBoYXZlIGJlZW4gdW5sb2NrZWQsIHBsZWFzZSByZWZyZXNoIHRoZSBwYWdlJyk7XG4gICAgfVxufVxuIiwiaW1wb3J0IEdhbWUgZnJvbSAnLi9HYW1lJztcbmNvbnN0IGdhbWUgPSBuZXcgR2FtZSgpO1xuZ2FtZS5pbml0KCkudGhlbigoKSA9PiB7XG4gICAgZ2FtZS5zdGFydCgpO1xufSk7XG53aW5kb3cuZ2FtZSA9IGdhbWU7XG4iXSwibmFtZXMiOltdLCJzb3VyY2VSb290IjoiIn0=\n//# sourceURL=webpack-internal:///680\n")}},__webpack_require__={r:g=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(g,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(g,"__esModule",{value:!0})}},__webpack_exports__={};__webpack_modules__[680](0,__webpack_exports__,__webpack_require__);var __webpack_export_target__=this;for(var i in __webpack_exports__)__webpack_export_target__[i]=__webpack_exports__[i];__webpack_exports__.__esModule&&Object.defineProperty(__webpack_export_target__,"__esModule",{value:!0})})();