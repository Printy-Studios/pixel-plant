(()=>{"use strict";var __webpack_modules__={680:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{eval("// ESM COMPAT FLAG\n__webpack_require__.r(__webpack_exports__);\n\n;// CONCATENATED MODULE: ./src/const.ts\nconst constants = {\n    scale: 8,\n    paces: {\n        \"4\": 4,\n        \"2\": 2,\n        \"1\": 1,\n        \"0.5\": 0.5,\n        \"0.25\": 0.25\n    },\n    plant_template_ids: [\n        \"basic_plant\",\n        \"yellow_dip\",\n        \"blue_haze\",\n        \"red_quartz\"\n    ]\n};\n/* harmony default export */ const src_const = (constants);\n\n;// CONCATENATED MODULE: ./src/Vector.ts\nclass Vector {\n    constructor(x, y) {\n        this.x = x;\n        this.y = y;\n    }\n    add(v) {\n        return new Vector(this.x + v.x, this.y + v.y);\n    }\n    divide(n) {\n        return new Vector(this.x / n, this.y / n);\n    }\n}\n\n;// CONCATENATED MODULE: ./src/util.ts\n\n\nfunction rangeOverlap(x1, x2, y1, y2) {\n    return Math.max(0, Math.min(x2, y2) - Math.max(x1, y1) + 1);\n}\nfunction secondsToTime(secs) {\n    var hours = Math.floor(secs / (60 * 60));\n    var divisor_for_minutes = secs % (60 * 60);\n    var minutes = Math.floor(divisor_for_minutes / 60);\n    var divisor_for_seconds = divisor_for_minutes % 60;\n    var seconds = Math.ceil(divisor_for_seconds);\n    var obj = {\n        \"h\": hours,\n        \"m\": minutes,\n        \"s\": seconds\n    };\n    return obj;\n}\nfunction humanReadableTime(time) {\n    const hours_str = time.h > 0 ? `${time.h} ${time.h == 1 ? 'hour' : 'hours'}` : null;\n    const mins_str = time.m > 0 ? `${time.m} ${time.m == 1 ? 'minute' : 'minutes'}` : null;\n    const seconds_str = time.s > 0 ? `${time.s} ${time.s == 1 ? 'second' : 'seconds'}` : null;\n    const arr = [hours_str, mins_str, seconds_str].filter(str => str != null);\n    return arr.join(', ');\n}\nfunction humanReadableTimeFromSeconds(seconds) {\n    const time = secondsToTime(seconds);\n    return humanReadableTime(time);\n}\nfunction getViewportCenter() {\n    return new Vector(window.innerWidth / 2 / src_const.scale, window.innerHeight / 2 / src_const.scale);\n}\nfunction getTemplateMaxStageIndex(template) {\n    return template.stages.length - 1;\n}\nfunction getPlantImageID(plant_id, stage) {\n    return 'images/' + plant_id + '/' + stage;\n}\nfunction getPlantImageBloblID(plant_id, stage) {\n    return 'image_blobs/' + plant_id + '/' + stage;\n}\nfunction getTemplateResourceID(template_id) {\n    return 'templates/' + template_id;\n}\nfunction getPlantTemplateFullyGrownImageURL(plant_template) {\n    const max_stage = plant_template.stages.length - 1;\n    return plant_template.stages[max_stage].image_url;\n}\nfunction getTemplateUnlock(template_id, all_templates) {\n    const unlock_id = all_templates[template_id].unlocks;\n    return all_templates[unlock_id];\n}\n/**\n * Get the maximum units of growth a plant can grow to\n */\nfunction getTemplateMaxGrowth(plant_template) {\n    const max_stage_index = getTemplateMaxStageIndex(plant_template);\n    return plant_template.stages[max_stage_index].at_growth * plant_template.multiplier;\n}\n/**\n * Get the plants max water index\n * @param plant_template\n */\nfunction getTemplateMaxWaterIndex(plant_template) {\n    return plant_template.water_level.stages.length - 1;\n}\n/**\n * Get plant's max water level\n */\nfunction getTemplateMaxWaterStage(plant_template) {\n    const max_index = getTemplateMaxWaterIndex(plant_template);\n    return plant_template.water_level.stages[max_index];\n}\n/**\n * Get the growth rate of a plant at max water level\n */\nfunction getTemplateMaxGrowthRate(plant_template) {\n    const max_water_level = getTemplateMaxWaterStage(plant_template);\n    return max_water_level.growth_rate * plant_template.multiplier;\n}\n/**\n * Time it takes to grow a plant if its is at max water stage\n */\nfunction templateTimeToGrow(plant_template, seconds_per_tick) {\n    const max_growth = getTemplateMaxGrowth(plant_template);\n    const max_growth_rate = getTemplateMaxGrowthRate(plant_template);\n    return max_growth * plant_template.multiplier / max_growth_rate * seconds_per_tick;\n}\n/**\n * How often a plant's water level runs out, in seconds\n *\n */\nfunction templateWateringFrequency(plant_template, seconds_per_tick) {\n    const water_decrease_rate = plant_template.water_level.decrease_rate * plant_template.multiplier;\n    return 100 / water_decrease_rate * seconds_per_tick;\n}\n\n;// CONCATENATED MODULE: ./src/ImageLoader.ts\nvar __awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\n\nclass ImageLoader {\n    constructor(cache) {\n        this.cache = cache;\n    }\n    loadTemplateImageIfNull(plant_id, stage) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const res_id = getPlantImageID(plant_id, stage);\n            if (!this.cache.has(res_id)) {\n                try {\n                    const img_url = './images/' + plant_id + '/' + plant_id + '_' + stage + '.png';\n                    const img_res = yield fetch(img_url);\n                    const img_data = yield img_res.blob();\n                    const image = yield createImageBitmap(img_data);\n                    const blob_id = getPlantImageBloblID(plant_id, stage);\n                    this.cache.set(res_id, image);\n                    this.cache.set(blob_id, img_data);\n                }\n                catch (e) {\n                    throw new Error('Could not load image: ' + e.message);\n                }\n            }\n        });\n    }\n}\n\n;// CONCATENATED MODULE: ./src/MyCache.ts\nclass MyCache {\n    constructor() {\n        this.items = {};\n    }\n    set(id, value) {\n        if (id in this.items) {\n            throw new Error('Cache: Could not store item by id ' + id + ': id already taken');\n        }\n        this.items[id] = value;\n    }\n    get(id) {\n        if (!(id in this.items)) {\n            throw new Error('Cache: Could not find item by id ' + id);\n        }\n        return this.items[id];\n    }\n    has(id) {\n        return (id in this.items);\n    }\n}\n\n;// CONCATENATED MODULE: ./src/MyStorage.ts\nclass MyStorage {\n    constructor() {\n        this.prefix = 'pixel-plant:';\n    }\n    get(key) {\n        return JSON.parse(localStorage.getItem(this.prefix + key));\n    }\n    set(key, value) {\n        localStorage.setItem(this.prefix + key, JSON.stringify(value));\n    }\n    has(key) {\n        return !!localStorage.getItem(this.prefix + key);\n    }\n    remove(key) {\n        localStorage.removeItem(key);\n    }\n}\n\n;// CONCATENATED MODULE: ./src/GameObject.ts\n\nclass GameObject {\n    constructor(position = new Vector(0, 0)) {\n        this.position = position;\n    }\n}\n\n;// CONCATENATED MODULE: ./src/Rect.ts\n\nclass Rect {\n    constructor(position = new Vector(0, 0), size = new Vector(0, 0)) {\n        this.size = size;\n        this.position = position;\n    }\n    calculateBounds() {\n        this.left = this.position.x - this.size.x / 2;\n        this.right = this.position.x + this.size.x / 2;\n        this.top = this.position.y - this.size.y / 2;\n        this.bottom = this.position.y - this.size.y / 2;\n    }\n    setPosition(v) {\n        this.position = v;\n        this.calculateBounds();\n    }\n}\n\n;// CONCATENATED MODULE: ./src/ProgressBar.ts\n\nclass ProgressBar extends Rect {\n    constructor(rect, options) {\n        super(rect.position, rect.size);\n        Object.assign(this, options);\n    }\n}\n//export default ProgressBar\n\n;// CONCATENATED MODULE: ./src/Sprite.ts\n\n\nclass Sprite extends GameObject {\n    constructor(image, position) {\n        super(position);\n        this.image = image;\n        this.width = image.width;\n        this.height = image.height;\n    }\n    getCenter(scale = 1) {\n        return this.position.divide(scale).add(new Vector(-this.width / 2, -this.height / 2));\n    }\n}\n\n;// CONCATENATED MODULE: ./src/WaterLevel.ts\nclass WaterLevel {\n    constructor(decrease_rate = 0.5, stages = []) {\n        this.stages = stages;\n        this.current = 100;\n        this.decrease_rate = decrease_rate;\n        this.validateStages();\n        this.calcCurrentStage();\n    }\n    validateStages() {\n        for (let a = 0; a < this.stages.length; a++) {\n            const stage_a = this.stages[a - 1];\n            const stage_b = this.stages[a];\n            const stage_c = this.stages[a + 1];\n            let valid;\n            if (this.stages.length == 1) {\n                valid = stage_b.from == 0 && stage_b.to == 100;\n            }\n            else if (a == 0) {\n                valid = stage_b.from == 0 && stage_b.to == stage_c.from;\n            }\n            else if (a != this.stages.length - 1) {\n                valid = stage_a.to == stage_b.from && stage_b.to == stage_c.from;\n            }\n            else {\n                valid = stage_b.from == stage_a.to && stage_b.to == 100;\n            }\n            if (!valid) {\n                throw new Error('Invalid water level');\n            }\n        }\n    }\n    calcCurrentStage() {\n        for (let i = 0; i < this.stages.length; i++) {\n            const stage = this.stages[i];\n            if (this.current <= stage.to && this.current >= stage.from) {\n                this.current_stage = i;\n                return;\n            }\n        }\n        throw new Error('Error calculating water current stage');\n    }\n    getCurrentStage() {\n        return this.stages[this.current_stage];\n    }\n    decreaseByTicks(ticks) {\n        this.current = Math.max(0, this.current - this.decrease_rate * ticks);\n        this.calcCurrentStage();\n    }\n    decrease() {\n        this.decreaseByTicks(1);\n    }\n    set(current) {\n        this.current = current;\n        this.calcCurrentStage();\n    }\n    top() {\n        this.set(100);\n    }\n    static fromTemplate(template) {\n        const stages = [];\n        const multiplier = template.multiplier;\n        template.water_level.stages.forEach((stage) => {\n            stages.push(Object.assign(Object.assign({}, stage), { growth_rate: stage.growth_rate * multiplier }));\n        });\n        return new WaterLevel(template.water_level.decrease_rate * multiplier, stages);\n    }\n}\n\n;// CONCATENATED MODULE: ./src/Plant.ts\nvar Plant_awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\n\n\n\n\n\n\n\nclass Plant extends GameObject {\n    constructor(id, options) {\n        super();\n        this.water_level = new WaterLevel(0.5, [\n            {\n                from: 0,\n                to: 100,\n                growth_rate: 4\n            },\n        ]);\n        this.current_stage = 0;\n        this.growth = 0;\n        this.position = new Vector(0, 0);\n        this.size = new Vector(16, 32);\n        this.id = id;\n        Object.assign(this, options);\n        this.initWaterLevelBar();\n        this.setPosition(getViewportCenter());\n    }\n    initWaterLevelBar() {\n        const dividers = this.water_level.stages.map(stage => stage.to);\n        dividers.pop();\n        this.water_level_bar = new ProgressBar(new Rect(new Vector(0, 0), new Vector(20, 2)), {\n            bg_color: '#0008FF42',\n            color: '#0008FFAD',\n            divider_color: 'darkblue',\n            direction: 'right',\n            current: 0,\n            dividers\n        });\n        this.water_level_bar.current = this.water_level.current;\n    }\n    maxGrowth() {\n        return this.stages[this.stages.length - 1].at_growth;\n    }\n    isFullyGrown() {\n        return this.growth > this.maxGrowth();\n    }\n    toJSON() {\n        return {\n            id: this.id,\n            plant_id: this.plant_id,\n            name: this.name,\n            water_level_current: this.water_level.current,\n            growth: this.growth,\n            fully_grown_called: this.fully_grown_called\n        };\n    }\n    onFullyGrown(callback) {\n        this.fully_grown_cb = callback;\n    }\n    static fromJSON(json, cache) {\n        return Plant_awaiter(this, void 0, void 0, function* () {\n            const plant = yield Plant.fromTemplate(json.id, json.plant_id, cache);\n            plant.name = json.name;\n            plant.water_level.set(json.water_level_current);\n            plant.setGrowth(json.growth);\n            plant.fully_grown_called = json.fully_grown_called;\n            return plant;\n        });\n    }\n    static stagesFromTemplate(template, cache) {\n        return Plant_awaiter(this, void 0, void 0, function* () {\n            const plant_stages = [];\n            const multiplier = template.multiplier;\n            for (let i = 0; i < template.stages.length; i++) {\n                const res_id = getPlantImageID(template.plant_id, i);\n                const image = cache.get(res_id);\n                //Plant data\n                const sprite = new Sprite(image);\n                const at_growth = template.stages[i].at_growth * multiplier;\n                plant_stages.push({\n                    sprite,\n                    at_growth\n                });\n            }\n            return plant_stages;\n        });\n    }\n    static fromTemplate(id, template_id, cache) {\n        return Plant_awaiter(this, void 0, void 0, function* () {\n            const res_id = getTemplateResourceID(template_id);\n            if (!cache.has(res_id)) {\n                const template_res = yield fetch('./plant_templates/' + template_id + '.json');\n                const template = yield template_res.json();\n                cache.set(res_id, template);\n            }\n            const template = cache.get(res_id);\n            const stages = yield Plant.stagesFromTemplate(template, cache);\n            const water_level = WaterLevel.fromTemplate(template);\n            const options = {\n                plant_id: template.plant_id,\n                water_level,\n                name: 'My Plant',\n                stages,\n                unlocks: template.unlocks\n            };\n            return new Plant(id, options);\n        });\n    }\n    calculateCurrentStage() {\n        const stage_indexes = this.stages.map((stage, index) => index);\n        var curr_stage_index = stage_indexes.reduce((a, i) => {\n            const prev_stage = this.stages[a];\n            const curr_stage = this.stages[i];\n            let is_growth_in_curr_stage = curr_stage.at_growth > prev_stage.at_growth && this.growth > curr_stage.at_growth;\n            if (is_growth_in_curr_stage) {\n                return i;\n            }\n            else {\n                return a;\n            }\n        });\n        this.current_stage = curr_stage_index;\n    }\n    growBy(added_growth) {\n        this.growth += added_growth;\n        this.calculateCurrentStage();\n        if (this.isFullyGrown() && this.fully_grown_cb && !this.fully_grown_called) {\n            this.fully_grown_cb(this);\n            this.fully_grown_called = true;\n        }\n    }\n    /**\n     * Grows plant by 1 tick\n     */\n    grow() {\n        let growth_rate = 0;\n        if (this.water_level.current > 0) {\n            growth_rate = this.water_level.getCurrentStage().growth_rate;\n        }\n        this.growBy(growth_rate);\n    }\n    setGrowth(growth) {\n        this.growth = growth;\n        this.calculateCurrentStage();\n    }\n    getCurrentStage() {\n        return this.stages[this.current_stage];\n    }\n    fastForward(ticks) {\n        const water_end = this.water_level.current;\n        this.water_level.decreaseByTicks(ticks);\n        const water_start = this.water_level.current;\n        let added_growth = 0;\n        for (let i = 0; i < this.water_level.stages.length; i++) {\n            const water_stage = this.water_level.stages[i];\n            const growt_rate = water_stage.growth_rate;\n            const overlap = rangeOverlap(water_start, water_end, water_stage.from, water_stage.to);\n            added_growth += (overlap / this.water_level.decrease_rate) * growt_rate;\n        }\n        this.growBy(added_growth);\n    }\n    tick() {\n        this.grow();\n        //this.water_level.decrease();\n        this.decreaseWaterLevel();\n    }\n    decreaseWaterLevelByTicks(ticks) {\n        this.water_level.decreaseByTicks(ticks);\n        this.updateWaterLevelBar();\n    }\n    decreaseWaterLevel() {\n        this.decreaseWaterLevelByTicks(1);\n    }\n    updateWaterLevelBar() {\n        this.water_level_bar.current = this.water_level.current;\n    }\n    setPosition(p) {\n        this.position = p;\n        for (let i = 0; i < this.stages.length; i++) {\n            this.stages[i].sprite.position = this.position;\n        }\n        this.water_level_bar.setPosition(new Vector(this.position.x, this.getRect().bottom + 2));\n    }\n    getRect() {\n        return {\n            top: this.position.y - this.size.y / 2,\n            bottom: this.position.y + this.size.y / 2,\n            left: this.position.x - this.size.x / 2,\n            right: this.position.x + this.size.x / 2\n        };\n    }\n}\n\n;// CONCATENATED MODULE: ./src/Renderer.ts\n\n\nclass Renderer {\n    constructor(canvas_id, ui_id, menu_id) {\n        this.scale = src_const.scale;\n        this.menus = {};\n        this.menu = null;\n        this.canvas = document.getElementById(canvas_id);\n        this.ui = document.getElementById(ui_id);\n        this.menu_element = document.getElementById(menu_id);\n        if (!this.canvas) {\n            throw new Error('Could not find canvas element by id ' + canvas_id);\n        }\n        window.addEventListener('resize', (e) => {\n            this.calculateCanvasSize();\n        });\n        this.ctx = this.canvas.getContext('2d');\n        this.calculateCanvasSize();\n    }\n    calculateCanvasSize() {\n        this.canvas.width = window.innerWidth;\n        this.canvas.height = window.innerHeight;\n        this.ctx.scale(this.scale, this.scale);\n        this.ctx.imageSmoothingEnabled = false;\n    }\n    clear() {\n        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\n    }\n    scaledPosition(pos) {\n        return pos.divide(this.scale);\n    }\n    drawSprite(sprite) {\n        const pos = sprite.position.add(new Vector(-sprite.width / 2, -sprite.height / 2)); //sprite.getCenter(this.scale)\n        this.ctx.drawImage(sprite.image, pos.x, pos.y);\n    }\n    drawRect(rect, color) {\n        this.ctx.fillStyle = color;\n        this.ctx.fillRect(rect.left, rect.top, rect.size.x, rect.size.y);\n    }\n    drawLine(from, to, color) {\n        this.ctx.strokeStyle = color;\n        this.ctx.beginPath();\n        this.ctx.moveTo(from.x, from.y);\n        this.ctx.lineTo(to.x, to.y);\n        this.ctx.stroke();\n    }\n    currentMenu() {\n        return document.getElementById(this.menu);\n    }\n    drawProgressBar(progress_bar) {\n        const { position, size } = progress_bar;\n        const { x, y } = position;\n        const { x: width, y: height } = size;\n        const left = x - width / 2;\n        const top = y - height / 2;\n        this.drawRect(progress_bar, progress_bar.bg_color);\n        this.ctx.fillStyle = progress_bar.color;\n        const new_rect = structuredClone(progress_bar);\n        if (progress_bar.direction == 'right') {\n            new_rect.size.x = progress_bar.current / 100 * progress_bar.size.x;\n            this.drawRect(new_rect, progress_bar.color);\n            const bar_length = new_rect.right - new_rect.left;\n            const y = new_rect.position.y - 1;\n            const end_y = new_rect.bottom + 2;\n            for (const divider of progress_bar.dividers) {\n                const x = new_rect.position.x - (bar_length / 2) + bar_length / 100 * divider;\n                const pos1 = new Vector(x, y);\n                const pos2 = new Vector(x, end_y);\n                this.drawLine(pos1, pos2, progress_bar.divider_color);\n            }\n        }\n        else {\n            throw new Error('Progress bar rendering only implemented for right direction');\n        }\n    }\n    drawPlant(plant) {\n        this.drawSprite(plant.getCurrentStage().sprite);\n        this.drawProgressBar(plant.water_level_bar);\n        //this.drawSprite\n    }\n    addMenu(menu, menu_id) {\n        if (menu_id) {\n            menu.id = menu_id + '-menu';\n        }\n        menu.classList.add('menu');\n        document.getElementById('menus').appendChild(menu);\n        this.menus[menu_id] = menu;\n    }\n    showMenu(menu_id) {\n        this.ui.style.display = 'none';\n        this.menu_element.style.display = 'flex';\n        this.hideMenu();\n        const menu = document.getElementById(menu_id + '-menu');\n        if (!menu) {\n            throw new Error('Could not find menu with ID ' + menu_id);\n        }\n        menu.style.display = 'flex';\n        this.menu_element.style.display = 'flex';\n        this.hideUI();\n        //this.menu_element.replaceWith(this.menu)\n    }\n    hideUI() {\n        this.ui.style.display = 'none';\n        this.canvas.style.display = 'none';\n    }\n    showUI() {\n        this.ui.style.display = 'block';\n        this.canvas.style.display = 'flex';\n    }\n    hideMenu() {\n        Object.keys(this.menus).forEach(menu_id => {\n            document.getElementById(menu_id + '-menu').style.display = 'none';\n        });\n        this.menu_element.style.display = 'none';\n        this.showUI();\n    }\n}\n\n;// CONCATENATED MODULE: ./src/MyEvent.ts\nclass MyEvent {\n    constructor() {\n        this.max_id = 0;\n        this.callbacks = {};\n    }\n    on(cb) {\n        this.callbacks[this.max_id++] = cb;\n        return this.max_id;\n    }\n    off(id) {\n        delete this.callbacks[id];\n    }\n    emit(...args) {\n        for (const key in this.callbacks) {\n            this.callbacks[key](...args);\n        }\n    }\n}\n\n;// CONCATENATED MODULE: ./src/main_events.ts\n\nconst main_events = {\n    on_request_plant_new_plant: new MyEvent(),\n    on_request_water_plant: new MyEvent(),\n    on_request_fast_forward: new MyEvent(),\n    on_request_show_menu: new MyEvent(),\n    on_request_set_view: new MyEvent(),\n    on_request_data_reset: new MyEvent(),\n    on_request_data_save: new MyEvent(),\n    after_data_reset: new MyEvent(),\n    on_fast_forward: new MyEvent()\n};\n/* harmony default export */ const src_main_events = (main_events);\n\n;// CONCATENATED MODULE: ./src/globals.ts\nconst globals = {\n    seconds_per_tick: 1,\n    recently_unlocked: 'basic_plant'\n};\n/* harmony default export */ const src_globals = (globals);\n\n;// CONCATENATED MODULE: ./src/UIManager.ts\nvar UIManager_awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\n\n\n\n\nclass UIManager {\n    constructor(renderer) {\n        //game: Game;\n        this.button = document.createElement('button');\n        this.menu = document.createElement('div');\n        this.plant_buttons = [];\n        this.plant_image = document.createElement('img');\n        this.plant_name = document.createElement('h2');\n        this.plant_description = document.createElement('p');\n        this.plant_stages = document.createElement('li');\n        this.plant_time_to_grow = document.createElement('li');\n        this.plant_water_frequency = document.createElement('li');\n        this.tabbable_elements = [];\n        this.current_tab_index = 0;\n        this.collection_images = {};\n        this.renderer = renderer;\n        this.button.classList.add('button');\n        this.menu.classList.add('menu');\n        const NAV_UP = 'ArrowUp';\n        const NAV_DOWN = 'ArrowDown';\n        document.addEventListener('keydown', (e) => {\n            // Keyboard navigation\n            if (e.code == NAV_UP) {\n                e.preventDefault();\n                this.navigateUp();\n            }\n            else if (e.code == NAV_DOWN) {\n                e.preventDefault();\n                this.navigateDown();\n            }\n        });\n    }\n    /**\n     * Keyboard navigation\n     */\n    navigateUp() {\n        let reference_index = this.current_tab_index;\n        const indices_above = this.getIndexes('above', reference_index);\n        if (indices_above.length == 0) {\n            reference_index = this.getMaxIndex() + 1;\n        }\n        const closest_index = this.getClosetIndex(reference_index, this.getIndexes('above', reference_index));\n        this.navigateToIndex(closest_index);\n    }\n    navigateDown() {\n        let reference_index = this.current_tab_index;\n        const indices_below = this.getIndexes('below', reference_index);\n        if (indices_below.length == 0) {\n            reference_index = 0;\n        }\n        const closest_index = this.getClosetIndex(reference_index, this.getIndexes('below', reference_index));\n        this.navigateToIndex(closest_index);\n    }\n    getMaxIndex() {\n        return Math.max(...this.getIndexes('all'));\n    }\n    /**\n     * Returns array of indices for visible tabbable elements\n     * @param direction\n     * @param reference_index\n     * @returns\n     */\n    getIndexes(direction = 'all', reference_index = null) {\n        let indices_all = null;\n        const visible_elements = this.getVisibleElements();\n        if (direction == 'all') {\n            indices_all = visible_elements.map((element) => element.tabIndex);\n        }\n        else if (typeof reference_index == 'number') {\n            indices_all = visible_elements.filter(element => {\n                return direction == 'below' ? element.tabIndex > reference_index : element.tabIndex < reference_index;\n            }).map((element) => element.tabIndex);\n        }\n        else {\n            throw new Error(`If direction isn't 'all', reference_index must be specified`);\n        }\n        return indices_all;\n    }\n    isElementVisible(element) {\n        return element.offsetParent != null;\n    }\n    getVisibleElements() {\n        return this.tabbable_elements.filter((elem) => this.isElementVisible(elem));\n    }\n    getElementByIndex(index) {\n        return this.getVisibleElements().find(elem => elem.tabIndex == index);\n    }\n    getClosetIndex(reference_index, from) {\n        if (from.length == 1) {\n            return from[0];\n        }\n        return from.reduce((a, b) => {\n            //const a = parseInt(a_str);\n            //const b = parseInt(b_str);\n            return Math.abs(b - reference_index) < Math.abs(a - reference_index) ? b : a;\n        });\n    }\n    navigateToIndex(index) {\n        const target_elem = this.getElementByIndex(index);\n        this.current_tab_index = index;\n        target_elem.focus();\n    }\n    initGameUI() {\n        // Game UI\n        // water_button.innerHTML = 'Water Plant'\n        // water_button.style.position = 'absolute'\n        // water_button.style.top = '140px'\n        // water_button.style.left = '50%';\n        // water_button.style.transform = 'translateX(-50%)'\n        // water_button.tabIndex = 4;\n        //Back button\n        const back_button = this.createLinkButton('Back', 'main', 'button-tl', 1);\n        this.water_button = this.createButton('Water Plant', 'water-button', 2);\n        const water_button = this.water_button;\n        //Progress message\n        const progress_message_container = document.createElement('div');\n        this.progress_message_container = progress_message_container;\n        progress_message_container.classList.add('progress-message');\n        // progress_message_container.tabIndex = 0;\n        const progress_message_bottom = document.createElement('div');\n        progress_message_bottom.classList.add('progress-message-bottom');\n        this.progress_message = document.createElement('p');\n        const progress_message = this.progress_message;\n        progress_message.innerHTML = 'You were away for n hours n minutes and your plant has grown by x %';\n        const dismiss_button = this.createButton('Dismiss', 'menu-button', 3, () => {\n            progress_message_container.style.display = 'none';\n        });\n        this.progress_message_plant = this.createButton('Plant', 'menu-button', 4);\n        this.progress_message_plant.classList.add('small-button');\n        this.progress_message_plant.innerHTML = 'Plant';\n        progress_message_container.appendChild(progress_message);\n        progress_message_container.appendChild(progress_message_bottom);\n        progress_message_bottom.appendChild(dismiss_button);\n        progress_message_bottom.appendChild(this.progress_message_plant);\n        /**\n         * Have to use mousedown instead of click here because otherwise the progress\n         * message container loses focus before the click event is fired\n         */\n        this.progress_message_plant.addEventListener('mousedown', () => {\n            progress_message_container.style.display = 'none';\n            src_main_events.on_request_plant_new_plant.emit(src_globals.recently_unlocked);\n        });\n        // progress_message_container.addEventListener('focusout', () => {\n        //     progress_message_container.style.display = 'none'\n        // })\n        water_button.addEventListener('click', () => {\n            src_main_events.on_request_water_plant.emit();\n            //this.game.waterCurrentPlant()\n        });\n        this.renderer.ui.appendChild(water_button);\n        this.renderer.ui.appendChild(back_button);\n        this.renderer.ui.appendChild(progress_message_container);\n    }\n    initMainMenu(is_new_game) {\n        //Main menu\n        //Play button\n        this.play_button = this.createViewButton(is_new_game ? 'New Game' : 'My Plant', 'plant', 'menu-button', 1, () => {\n            src_main_events.on_request_fast_forward.emit();\n            //this.game.fastForwardBySeconds(this.game.getTimeAway())\n        });\n        //Collection button\n        const collection_button = this.createLinkButton('Collection', 'collection', 'menu-button', 2);\n        //Help button\n        const help_button = this.createLinkButton('Help', 'help', 'menu-button', 3);\n        //Options button\n        const options_button = this.createLinkButton('Options', 'options', 'menu-button', 4);\n        this.main_menu = this.createMenu();\n        this.main_menu.appendChild(this.play_button);\n        this.main_menu.appendChild(collection_button);\n        this.main_menu.appendChild(help_button);\n        this.main_menu.appendChild(options_button);\n        this.renderer.addMenu(this.main_menu, 'main');\n    }\n    initOptionsMenu() {\n        //Options menu\n        const options_menu = this.createMenu();\n        const pace_selector = document.createElement('div');\n        const pace_selector_label = document.createElement('p');\n        const pace_selector_dropdown = document.createElement('select');\n        // Make dropdown navigatable by arrow keys\n        this.addTabbableElement(pace_selector_dropdown, 1);\n        pace_selector.classList.add('pace-selector');\n        pace_selector_label.innerHTML = 'Pace: ';\n        for (const pace_key in src_const.paces) {\n            const option = document.createElement('option');\n            option.value = pace_key;\n            option.innerHTML = pace_key;\n            let should_be_selected = parseFloat(pace_key) == 1 / src_globals.seconds_per_tick;\n            if (should_be_selected) {\n                option.selected = true;\n            }\n            pace_selector_dropdown.appendChild(option);\n        }\n        src_main_events.after_data_reset.on(() => {\n            pace_selector_dropdown.value = \"1\";\n        });\n        pace_selector.appendChild(pace_selector_label);\n        pace_selector.appendChild(pace_selector_dropdown);\n        const options_back = this.createLinkButton('Back', 'main', 'menu-button', 2);\n        const reset_button = this.createButton('Reset Game', 'menu-button', 3);\n        options_menu.appendChild(pace_selector);\n        options_menu.appendChild(options_back);\n        options_menu.appendChild(reset_button);\n        //Options menu\n        pace_selector_dropdown.addEventListener('change', (e) => {\n            src_globals.seconds_per_tick = 1 / parseFloat(e.target.value);\n            src_main_events.on_request_data_save.emit();\n        });\n        reset_button.addEventListener('click', () => {\n            src_main_events.on_request_data_reset.emit();\n        });\n        this.renderer.addMenu(options_menu, 'options');\n    }\n    initCollectionMenu(plant_templates, unlocked_plants, grown_plants) {\n        // Collection menu\n        const collection_menu = this.createMenu('menu-non-centered');\n        const collection_back = this.createLinkButton('Back', 'main', 'menu-button', 1);\n        collection_menu.appendChild(collection_back);\n        let button_index = 1;\n        for (const template_id in plant_templates) {\n            button_index++;\n            const plant_button = this.createButton('', 'menu-button', button_index);\n            plant_button.classList.add('plant-button');\n            // const plant = await Plant.fromTemplate(template_id, template_id, this.cache)\n            const plant_template = plant_templates[template_id];\n            const img_element = document.createElement('img');\n            img_element.classList.add('collection-image');\n            this.collection_images[template_id] = img_element;\n            plant_button.appendChild(img_element);\n            const is_plant_unlocked = unlocked_plants.includes(plant_template.plant_id);\n            const is_plant_grown = grown_plants.includes(plant_template.plant_id);\n            this.updateCollectionImage(plant_template, is_plant_unlocked, is_plant_grown);\n            collection_menu.appendChild(plant_button);\n        }\n        src_main_events.after_data_reset.on(() => {\n            this.resetCollectionImages(plant_templates);\n        });\n        this.renderer.addMenu(collection_menu, 'collection');\n    }\n    initPlantEntryMenu() {\n        //Plant Entry\n        const plant_menu = this.createMenu();\n        const plant_back = this.createLinkButton('Back', 'collection', 'menu-button', 1);\n        this.plant_image.classList.add('plant-entry-image');\n        const plant_button = this.createButton('Plant', 'menu-button', 2);\n        const stats = document.createElement('ul');\n        stats.appendChild(this.plant_stages);\n        stats.appendChild(this.plant_time_to_grow);\n        stats.appendChild(this.plant_water_frequency);\n        const info = document.createElement('div');\n        info.classList.add('plant-entry-info');\n        info.appendChild(this.plant_description);\n        info.appendChild(stats);\n        plant_menu.appendChild(plant_back);\n        plant_menu.appendChild(this.plant_image);\n        plant_menu.appendChild(this.plant_name);\n        plant_menu.appendChild(info);\n        plant_menu.appendChild(plant_button);\n        plant_button.addEventListener('click', () => {\n            src_main_events.on_request_plant_new_plant.emit(this.current_plant_in_menu.plant_id);\n            //this.game.plantNewPlant(this.current_plant_in_menu.plant_id);\n        });\n        this.renderer.addMenu(plant_menu, 'plant');\n    }\n    initHelpMenu() {\n        const help_menu = this.createMenu('menu-non-centered');\n        const back_button = this.createLinkButton('Back', 'main', null, 1);\n        const text_element = document.createElement('p');\n        text_element.innerHTML = `Welcome to My Pixel Plant. This is a small relaxing game where the sole\n        purpose is to just water your plant and watch it grow.<br><br>\n        \n        Each plant has several stages of growth, each of varying lengths. <br><br>\n        \n        A plant has a water level - which indicates how much water the plant has. The water\n        levels are split into water level stages, and the less water a plant has, the slower it will grow. The water level\n        stages are divided by dark vertical lines that you can see on your water level bar. <br><br>\n        \n        Whenever you grow a plant, a new plant gets unlocked. Each newly unlocked plant takes longer and longer to grow. <br><br>\n        \n        The Collection is a place where you can view all of your unlocked plant types and some information about them, such as how long they take to grow, how many stages\n        they have, and how frequently they have to be watered. Currently there are 4 plant types in the game. <br><br>\n        \n        Good luck with your plants and I hope you'll have fun playing this little game!\n        `;\n        help_menu.appendChild(back_button);\n        help_menu.appendChild(text_element);\n        this.renderer.addMenu(help_menu, 'help');\n    }\n    initUi(plant_templates, unlocked_plants, grown_plants, is_new_game) {\n        return UIManager_awaiter(this, void 0, void 0, function* () {\n            this.initGameUI();\n            this.initMainMenu(is_new_game);\n            this.initOptionsMenu();\n            this.initPlantEntryMenu();\n            this.initCollectionMenu(plant_templates, unlocked_plants, grown_plants);\n            this.initHelpMenu();\n        });\n    }\n    setPlayButtonText(str) {\n        this.play_button.innerHTML = str;\n    }\n    addTabbableElement(element, index) {\n        element.tabIndex = index;\n        this.tabbable_elements.push(element);\n    }\n    createButton(text, class_name = null, index = null, on_click = null) {\n        const btn = this.button.cloneNode();\n        btn.classList.add(class_name);\n        btn.innerHTML = text;\n        if (index) {\n            this.addTabbableElement(btn, index);\n        }\n        btn.addEventListener('click', () => {\n            if (on_click) {\n                on_click();\n            }\n        });\n        return btn;\n    }\n    createLinkButton(text = \"\", link_to = \"\", class_name = null, index = null, on_click = null) {\n        const btn = this.createButton(text, class_name, index);\n        btn.addEventListener('click', () => {\n            src_main_events.on_request_show_menu.emit(link_to);\n            if (on_click) {\n                on_click();\n            }\n        });\n        return btn;\n    }\n    createViewButton(text = \"\", link_to, class_name = \"\", index = null, on_click = null) {\n        const btn = this.createButton(text, class_name, index);\n        btn.addEventListener('click', () => {\n            src_main_events.on_request_set_view.emit(link_to);\n            if (on_click) {\n                on_click();\n            }\n        });\n        return btn;\n    }\n    createMenu(class_name = null) {\n        const menu = this.menu.cloneNode();\n        menu.classList.add(class_name);\n        return menu;\n    }\n    showPlantMenu(plant_template, is_plant_grown) {\n        this.plant_image.src = is_plant_grown ? getPlantTemplateFullyGrownImageURL(plant_template) : plant_template.stages[0].image_url;\n        this.plant_name.innerHTML = plant_template.name;\n        this.plant_description.innerHTML = plant_template.description;\n        this.plant_stages.innerHTML = \"<b>Stages: </b>\" + plant_template.stages.length;\n        const time_to_grow_seconds = templateTimeToGrow(plant_template, src_globals.seconds_per_tick);\n        const time_to_grow_str = humanReadableTimeFromSeconds(time_to_grow_seconds);\n        this.plant_time_to_grow.innerHTML = \"<b>Time to grow at max water level: </b>\" + time_to_grow_str;\n        const water_frequency_seconds = templateWateringFrequency(plant_template, src_globals.seconds_per_tick);\n        const water_frequency_str = humanReadableTimeFromSeconds(water_frequency_seconds);\n        this.plant_water_frequency.innerHTML = \"<b>Must be watered at least every: </b>\" + water_frequency_str;\n        this.current_plant_in_menu = plant_template;\n        this.renderer.showMenu('plant');\n    }\n    displayProgressMessage(plant, plant_templates, ff = true, growth_before = null, growth_after = null, seconds_elapsed = null) {\n        let show_plant_button = false;\n        let message = \"\";\n        const time = secondsToTime(seconds_elapsed);\n        let has_time = time.m > 0;\n        if (has_time && ff) {\n            const growth_difference = growth_after - growth_before;\n            let growth_percent = growth_difference / plant.maxGrowth() * 100;\n            if (plant.isFullyGrown()) {\n                growth_percent = true;\n            }\n            message = this.progressMessageText(time, growth_percent);\n        }\n        else if (!ff) {\n            message = this.progressMessageText({ h: 0, m: 0 }, true);\n        }\n        else {\n            return;\n        }\n        const unlock = getTemplateUnlock(plant.plant_id, plant_templates);\n        if (plant.isFullyGrown() && unlock) {\n            message += '<br><b>You have unlocked a new plant - ' + unlock.name + '. Would you like to plant it?';\n            src_globals.recently_unlocked = unlock.plant_id;\n            show_plant_button = true;\n        }\n        if (show_plant_button) {\n            this.progress_message_plant.style.display = 'flex';\n        }\n        else {\n            this.progress_message_plant.style.display = 'none';\n        }\n        this.progress_message.innerHTML = message;\n        this.progress_message_container.style.display = 'flex';\n        this.progress_message_container.focus();\n    }\n    /**\n     * If you want to indicate that the plant has fully grown, pass 'true' for `growth_percentage`\n     */\n    progressMessageText(time, growth_percentage) {\n        const away_str = time.h > 0 || time.m > 0 ? 'You were away for' : '';\n        const hrs_str = time.h == 1 ? '1 hour' : time.h > 0 ? time.h + ' hours' : '';\n        const mins_str = time.m == 1 ? '1 minute' : time.m > 0 ? time.m + ' minutes' : '';\n        const and_str = time.h > 0 && time.m > 0 ? 'and' : '';\n        const growth_str = typeof growth_percentage === 'boolean' ? 'fully grown' : 'grown by ' + growth_percentage.toFixed(2) + ' %';\n        return `${away_str} ${hrs_str} ${and_str} ${mins_str} ${and_str} your plant has ${growth_str}`;\n    }\n    calculatePositions(plant) {\n        this.water_button.style.top = plant.position.y * src_const.scale + 200 + 'px';\n        this.water_button.style.left = window.innerWidth / 2 + 'px';\n    }\n    updateCollectionImage(plant_template, is_plant_unlocked, is_plant_grown) {\n        const img_element = this.collection_images[plant_template.plant_id];\n        const plant_button = img_element.closest('button');\n        if (is_plant_unlocked) {\n            let stage = 0;\n            if (is_plant_grown) {\n                stage = getTemplateMaxStageIndex(plant_template);\n            }\n            //const image = this.cache.get('image_blobs/' + plant_template.plant_id + '/' + max_stage)\n            const image_url = plant_template.stages[stage].image_url; //URL.createObjectURL(image);\n            img_element.src = image_url;\n            //Check if text has already been added to the button\n            if (!plant_button.querySelector('p')) {\n                const text = document.createElement('p');\n                text.innerHTML = plant_template.name;\n                plant_button.appendChild(text);\n                //Additionally we can add the event lisetener, because this above if statement\n                //will only be true once, when the plant isn't unlocked and there is no text\n                plant_button.addEventListener('click', () => {\n                    this.showPlantMenu(plant_template, is_plant_grown);\n                });\n            }\n        }\n        else {\n            img_element.src = 'images/question-mark.jpeg';\n        }\n    }\n    resetCollectionImages(plant_templates) {\n        for (const template_id in plant_templates) {\n            if (template_id != 'basic_plant') {\n                this.updateCollectionImage(plant_templates[template_id], false, false);\n            }\n        }\n    }\n}\n\n;// CONCATENATED MODULE: ./src/SaveManager.ts\nvar SaveManager_awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\n\n\nclass SaveManager {\n    constructor(storage, cache) {\n        this.storage = storage;\n        this.cache = cache;\n    }\n    saveData(data) {\n        //If custom data object was passed, save that\n        // if(data) {\n        //     this.storage.set('data', data)\n        //     return;\n        // }\n        //Otherwise get current plants and save them\n        this.updateCachedData(data);\n        this.setData(this.data);\n    }\n    updateCachedData(data) {\n        if (data.seconds_per_tick != undefined) {\n            this.data.pace = 1 / data.seconds_per_tick;\n        }\n        if (data.plant != undefined) {\n            this.data.plant = data.plant.toJSON();\n        }\n        if (data.new_game !== undefined) {\n            this.data.new_game = data.new_game;\n        }\n        if (data.unlocked_plants !== undefined) {\n            this.data.unlocked_plants = data.unlocked_plants;\n        }\n        if (data.grown_plants !== undefined) {\n            this.data.grown_plants = data.grown_plants;\n        }\n        this.data.leave_time = new Date().getTime();\n    }\n    setCachedData(data) {\n        this.data = data;\n    }\n    getDefaultData() {\n        return SaveManager_awaiter(this, void 0, void 0, function* () {\n            const basic_plant = yield Plant.fromTemplate(0, 'basic_plant', this.cache);\n            return {\n                pace: 1,\n                max_id: 1,\n                leave_time: null,\n                unlocked_plants: [\"basic_plant\"],\n                grown_plants: [],\n                plant: basic_plant.toJSON(),\n                new_game: true,\n            };\n        });\n    }\n    setDataToDefaults() {\n        return SaveManager_awaiter(this, void 0, void 0, function* () {\n            const data = yield this.getDefaultData();\n            this.setData(data);\n            src_main_events.after_data_reset.emit();\n        });\n    }\n    setData(data) {\n        this.setCachedData(data);\n        this.storage.set('data', data);\n    }\n    resetData() {\n        return SaveManager_awaiter(this, void 0, void 0, function* () {\n            yield this.setDataToDefaults();\n        });\n    }\n    getData() {\n        if (!this.storage.has('data')) {\n            throw new Error('Could not retrieve save data: no data is set');\n        }\n        return this.storage.get('data');\n    }\n    setDataIfNull() {\n        return SaveManager_awaiter(this, void 0, void 0, function* () {\n            if (!this.storage.has('data')) {\n                yield this.setDataToDefaults();\n            }\n            else {\n                const default_data = yield this.getDefaultData();\n                this.data = Object.assign(Object.assign({}, default_data), this.getData());\n            }\n        });\n    }\n    /**\n     * Returns how long the user was away (not in-game or window not focused)\n     * @returns\n     */\n    getTimeAway() {\n        let current_time_ms = new Date().getTime();\n        let time_difference_ms = current_time_ms - this.data.leave_time;\n        return this.data.leave_time ? (time_difference_ms) / 1000 : null;\n    }\n}\n\n;// CONCATENATED MODULE: ./src/Game.ts\nvar Game_awaiter = (undefined && undefined.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\n\n\n\n\n\n\n\n\n\n\n\nclass Game {\n    constructor() {\n        this.renderer = new Renderer('canvas', 'ui', 'menus');\n        this.cache = new MyCache();\n        this.storage = new MyStorage();\n        this.data = new SaveManager(this.storage, this.cache);\n        this.ui = new UIManager(this.renderer);\n        this.image_loader = new ImageLoader(this.cache);\n        this.first_init = false; //Whether this the game has been initialized at least once\n        this.last_frame_time = 0;\n        this.delta = 0;\n        this.delta_sum = 0;\n        this.plant_templates = {};\n        this.plants = {};\n        this.loading = true;\n        this.current_view = null;\n        src_main_events.on_request_data_reset.on(this.onRequestDataReset.bind(this));\n        src_main_events.on_request_data_save.on(this.onRequestDataSave.bind(this));\n        src_main_events.on_request_show_menu.on(this.onRequestShowMenu.bind(this));\n        src_main_events.on_request_set_view.on(this.onRequestSetView.bind(this));\n        src_main_events.on_request_fast_forward.on(this.onRequestFastForward.bind(this));\n        src_main_events.on_request_plant_new_plant.on(this.onRequestPlantNewPlant.bind(this));\n        src_main_events.on_request_water_plant.on(this.onRequestWaterPlant.bind(this));\n        src_main_events.after_data_reset.on(this.afterDataReset.bind(this));\n        window.addEventListener('focus', () => {\n            if (this.current_view == 'plant' && !this.data.data.new_game) {\n                this.fastForwardBySeconds(this.data.getTimeAway());\n            }\n        });\n        this.renderer.hideUI();\n    }\n    onRequestDataReset() {\n        return Game_awaiter(this, void 0, void 0, function* () {\n            const confirm_reset = confirm('Are you sure you want to reset all data? Plant data and collection will be lost');\n            if (!confirm_reset)\n                return;\n            yield this.data.resetData();\n            yield this.init();\n        });\n    }\n    afterDataReset() {\n        if (this.ui.play_button) {\n            this.ui.setPlayButtonText('New Game');\n        }\n    }\n    onRequestDataSave() {\n        this.data.saveData({\n            seconds_per_tick: src_globals.seconds_per_tick,\n            plant: this.plant\n        });\n    }\n    onRequestShowMenu(menu_id) {\n        this.setView(null);\n        this.renderer.showMenu(menu_id);\n    }\n    onRequestSetView(view_id) {\n        this.setView(view_id);\n    }\n    onRequestFastForward() {\n        this.fastForwardBySeconds(this.data.getTimeAway());\n    }\n    onRequestWaterPlant() {\n        this.waterCurrentPlant();\n    }\n    onRequestPlantNewPlant(template_id) {\n        this.plantNewPlant(template_id);\n    }\n    init() {\n        return Game_awaiter(this, void 0, void 0, function* () {\n            this.setLoading(true);\n            yield this.initTemplates();\n            yield this.initImages();\n            yield this.data.setDataIfNull();\n            this.initTemplateImageURLs();\n            src_globals.seconds_per_tick = 1 / this.data.data.pace;\n            window.addEventListener('resize', () => {\n                this.calculatePositions();\n            });\n            console.log(this.data.data);\n            if (!this.first_init) {\n                yield this.ui.initUi(this.plant_templates, this.data.data.unlocked_plants, this.data.data.grown_plants, this.data.data.new_game);\n                this.first_init = true;\n            }\n            yield this.initPlants();\n            this.calculatePositions();\n            this.setLoading(false);\n            this.renderer.showMenu('main');\n        });\n    }\n    initImages() {\n        return Game_awaiter(this, void 0, void 0, function* () {\n            for (const template_id in this.plant_templates) {\n                const template = this.plant_templates[template_id];\n                for (let i = 0; i < template.stages.length; i++) {\n                    yield this.image_loader.loadTemplateImageIfNull(template.plant_id, i);\n                }\n            }\n        });\n    }\n    initPlants() {\n        return Game_awaiter(this, void 0, void 0, function* () {\n            const plant = yield Plant.fromJSON(this.data.data.plant, this.cache);\n            this.setPlant(plant);\n        });\n    }\n    initTemplates() {\n        return Game_awaiter(this, void 0, void 0, function* () {\n            for (const template_id of src_const.plant_template_ids) {\n                const res = yield fetch('plant_templates/' + template_id + '.json');\n                const json = yield res.json();\n                this.plant_templates[template_id] = json;\n            }\n        });\n    }\n    initTemplateImageURLs() {\n        for (const template_id in this.plant_templates) {\n            const template = this.plant_templates[template_id];\n            for (const i in template.stages) {\n                const image = this.cache.get('image_blobs/' + template.plant_id + '/' + i);\n                template.stages[i].image_url = URL.createObjectURL(image);\n            }\n        }\n    }\n    onPlantFullyGrown(plant) {\n        this.ui.displayProgressMessage(this.plant, this.plant_templates, false);\n        this.data.saveData({\n            plant: this.plant,\n            unlocked_plants: [...this.data.data.unlocked_plants, plant.unlocks],\n            grown_plants: [...this.data.data.grown_plants, plant.plant_id]\n        });\n        if (plant.unlocks) {\n            const unlocked_template = this.plant_templates[plant.unlocks];\n            this.ui.updateCollectionImage(unlocked_template, true, false);\n        }\n        this.ui.updateCollectionImage(this.plant_templates[plant.plant_id], true, true);\n    }\n    fastForwardBySeconds(seconds) {\n        if (this.data.data.new_game) {\n            return;\n        }\n        if (!seconds) {\n            return;\n        }\n        const growth_before = this.plant.growth;\n        const ticks = this.getTicksBySeconds(seconds);\n        this.plant.fastForward(ticks);\n        const growth_after = this.plant.growth;\n        this.ui.displayProgressMessage(this.plant, this.plant_templates, true, growth_before, growth_after, seconds);\n    }\n    getTicksBySeconds(seconds) {\n        return seconds / src_globals.seconds_per_tick;\n    }\n    setView(view_name) {\n        this.current_view = view_name;\n        if (view_name) {\n            this.renderer.hideMenu();\n        }\n        if (view_name == 'plant') {\n            if (this.data.data.new_game == true) {\n                this.data.saveData({\n                    new_game: false\n                });\n                this.ui.setPlayButtonText('My Plant');\n            }\n        }\n    }\n    calculatePositions() {\n        this.plant.setPosition(getViewportCenter());\n        this.ui.calculatePositions(this.plant);\n    }\n    setLoading(loading) {\n        this.loading = loading;\n        if (this.loading) {\n            this.renderer.ui.style.display = 'none';\n            if (this.renderer.menu) {\n                this.renderer.currentMenu().style.display = 'none';\n            }\n            document.getElementById('loading').style.display = 'flex';\n        }\n        else {\n            if (this.renderer.menu) {\n                this.renderer.currentMenu().style.display = 'block';\n            }\n            else {\n                this.renderer.ui.style.display = 'block';\n            }\n            document.getElementById('loading').style.display = 'none';\n        }\n    }\n    start() {\n        window.requestAnimationFrame(this.gameLoop.bind(this));\n    }\n    tick() {\n        this.data.saveData({\n            plant: this.plant\n        });\n        this.plant.tick();\n    }\n    draw() {\n        this.renderer.clear();\n        if (!this.loading && !this.renderer.menu && this.current_view == 'plant') {\n            this.renderer.drawPlant(this.plant);\n        }\n    }\n    waterCurrentPlant() {\n        this.plant.water_level.top();\n        this.plant.updateWaterLevelBar();\n    }\n    gameLoop() {\n        this.calculateDeltaSum();\n        if (this.delta_sum > src_globals.seconds_per_tick && !this.loading && this.current_view == 'plant') {\n            this.tick();\n            this.delta_sum = 0;\n        }\n        this.draw();\n        window.requestAnimationFrame(this.gameLoop.bind(this));\n    }\n    calculateDeltaSum() {\n        const current_time = new Date().getTime();\n        this.delta = (current_time - this.last_frame_time) / 1000;\n        this.last_frame_time = new Date().getTime();\n        this.delta_sum += this.delta;\n    }\n    // createPlant(plant: Plant) {\n    //     this.plants[plant.id] = plant;\n    // }\n    plantNewPlant(template_id) {\n        return Game_awaiter(this, void 0, void 0, function* () {\n            const plant = yield Plant.fromTemplate('my_plant', template_id, this.cache);\n            this.setPlant(plant);\n            this.setView('plant');\n        });\n    }\n    setPlant(plant) {\n        this.plant = plant;\n        this.plant.onFullyGrown(this.onPlantFullyGrown.bind(this));\n    }\n    unlockAll() {\n        this.data.saveData({\n            unlocked_plants: [...src_const.plant_template_ids]\n        });\n        alert('All plants have been unlocked, please refresh the page');\n    }\n}\n\n;// CONCATENATED MODULE: ./src/index.ts\n\nconst game = new Game();\ngame.init().then(() => {\n    game.start();\n});\nwindow.game = game;\n//# sourceURL=[module]\n//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiNjgwLmpzIiwibWFwcGluZ3MiOiI7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUNoQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUNYQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQy9GQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FDakNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQ25CQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUNoQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUNMQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUNoQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FDUEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQ1pBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUNsRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FDdk1BO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FDcEhBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FDakJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUNaQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUNKQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7OztBQ3ZjQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUN2R0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUN2UUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vLy4vc3JjL2NvbnN0LnRzPzE0ZGEiLCJ3ZWJwYWNrOi8vLy4vc3JjL1ZlY3Rvci50cz82OWY1Iiwid2VicGFjazovLy8uL3NyYy91dGlsLnRzPzk4ODciLCJ3ZWJwYWNrOi8vLy4vc3JjL0ltYWdlTG9hZGVyLnRzPzRlNDUiLCJ3ZWJwYWNrOi8vLy4vc3JjL015Q2FjaGUudHM/OTQzZSIsIndlYnBhY2s6Ly8vLi9zcmMvTXlTdG9yYWdlLnRzPzQxYjAiLCJ3ZWJwYWNrOi8vLy4vc3JjL0dhbWVPYmplY3QudHM/YzI2NyIsIndlYnBhY2s6Ly8vLi9zcmMvUmVjdC50cz9jMjE3Iiwid2VicGFjazovLy8uL3NyYy9Qcm9ncmVzc0Jhci50cz9hNzExIiwid2VicGFjazovLy8uL3NyYy9TcHJpdGUudHM/MTczMSIsIndlYnBhY2s6Ly8vLi9zcmMvV2F0ZXJMZXZlbC50cz85MmQ4Iiwid2VicGFjazovLy8uL3NyYy9QbGFudC50cz8yMWVlIiwid2VicGFjazovLy8uL3NyYy9SZW5kZXJlci50cz9iZmZkIiwid2VicGFjazovLy8uL3NyYy9NeUV2ZW50LnRzP2FmMGEiLCJ3ZWJwYWNrOi8vLy4vc3JjL21haW5fZXZlbnRzLnRzP2IzYTAiLCJ3ZWJwYWNrOi8vLy4vc3JjL2dsb2JhbHMudHM/OGMyMiIsIndlYnBhY2s6Ly8vLi9zcmMvVUlNYW5hZ2VyLnRzP2RlOTIiLCJ3ZWJwYWNrOi8vLy4vc3JjL1NhdmVNYW5hZ2VyLnRzP2NmODgiLCJ3ZWJwYWNrOi8vLy4vc3JjL0dhbWUudHM/ZjBlZiIsIndlYnBhY2s6Ly8vLi9zcmMvaW5kZXgudHM/ZTk0ZSJdLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBjb25zdGFudHMgPSB7XG4gICAgc2NhbGU6IDgsXG4gICAgcGFjZXM6IHtcbiAgICAgICAgXCI0XCI6IDQsXG4gICAgICAgIFwiMlwiOiAyLFxuICAgICAgICBcIjFcIjogMSxcbiAgICAgICAgXCIwLjVcIjogMC41LFxuICAgICAgICBcIjAuMjVcIjogMC4yNVxuICAgIH0sXG4gICAgcGxhbnRfdGVtcGxhdGVfaWRzOiBbXG4gICAgICAgIFwiYmFzaWNfcGxhbnRcIixcbiAgICAgICAgXCJ5ZWxsb3dfZGlwXCIsXG4gICAgICAgIFwiYmx1ZV9oYXplXCIsXG4gICAgICAgIFwicmVkX3F1YXJ0elwiXG4gICAgXVxufTtcbmV4cG9ydCBkZWZhdWx0IGNvbnN0YW50cztcbiIsImV4cG9ydCBkZWZhdWx0IGNsYXNzIFZlY3RvciB7XG4gICAgY29uc3RydWN0b3IoeCwgeSkge1xuICAgICAgICB0aGlzLnggPSB4O1xuICAgICAgICB0aGlzLnkgPSB5O1xuICAgIH1cbiAgICBhZGQodikge1xuICAgICAgICByZXR1cm4gbmV3IFZlY3Rvcih0aGlzLnggKyB2LngsIHRoaXMueSArIHYueSk7XG4gICAgfVxuICAgIGRpdmlkZShuKSB7XG4gICAgICAgIHJldHVybiBuZXcgVmVjdG9yKHRoaXMueCAvIG4sIHRoaXMueSAvIG4pO1xuICAgIH1cbn1cbiIsImltcG9ydCBjb25zdGFudHMgZnJvbSAnLi9jb25zdCc7XG5pbXBvcnQgVmVjdG9yIGZyb20gJy4vVmVjdG9yJztcbmV4cG9ydCBmdW5jdGlvbiByYW5nZU92ZXJsYXAoeDEsIHgyLCB5MSwgeTIpIHtcbiAgICByZXR1cm4gTWF0aC5tYXgoMCwgTWF0aC5taW4oeDIsIHkyKSAtIE1hdGgubWF4KHgxLCB5MSkgKyAxKTtcbn1cbmV4cG9ydCBmdW5jdGlvbiBzZWNvbmRzVG9UaW1lKHNlY3MpIHtcbiAgICB2YXIgaG91cnMgPSBNYXRoLmZsb29yKHNlY3MgLyAoNjAgKiA2MCkpO1xuICAgIHZhciBkaXZpc29yX2Zvcl9taW51dGVzID0gc2VjcyAlICg2MCAqIDYwKTtcbiAgICB2YXIgbWludXRlcyA9IE1hdGguZmxvb3IoZGl2aXNvcl9mb3JfbWludXRlcyAvIDYwKTtcbiAgICB2YXIgZGl2aXNvcl9mb3Jfc2Vjb25kcyA9IGRpdmlzb3JfZm9yX21pbnV0ZXMgJSA2MDtcbiAgICB2YXIgc2Vjb25kcyA9IE1hdGguY2VpbChkaXZpc29yX2Zvcl9zZWNvbmRzKTtcbiAgICB2YXIgb2JqID0ge1xuICAgICAgICBcImhcIjogaG91cnMsXG4gICAgICAgIFwibVwiOiBtaW51dGVzLFxuICAgICAgICBcInNcIjogc2Vjb25kc1xuICAgIH07XG4gICAgcmV0dXJuIG9iajtcbn1cbmV4cG9ydCBmdW5jdGlvbiBodW1hblJlYWRhYmxlVGltZSh0aW1lKSB7XG4gICAgY29uc3QgaG91cnNfc3RyID0gdGltZS5oID4gMCA/IGAke3RpbWUuaH0gJHt0aW1lLmggPT0gMSA/ICdob3VyJyA6ICdob3Vycyd9YCA6IG51bGw7XG4gICAgY29uc3QgbWluc19zdHIgPSB0aW1lLm0gPiAwID8gYCR7dGltZS5tfSAke3RpbWUubSA9PSAxID8gJ21pbnV0ZScgOiAnbWludXRlcyd9YCA6IG51bGw7XG4gICAgY29uc3Qgc2Vjb25kc19zdHIgPSB0aW1lLnMgPiAwID8gYCR7dGltZS5zfSAke3RpbWUucyA9PSAxID8gJ3NlY29uZCcgOiAnc2Vjb25kcyd9YCA6IG51bGw7XG4gICAgY29uc3QgYXJyID0gW2hvdXJzX3N0ciwgbWluc19zdHIsIHNlY29uZHNfc3RyXS5maWx0ZXIoc3RyID0+IHN0ciAhPSBudWxsKTtcbiAgICByZXR1cm4gYXJyLmpvaW4oJywgJyk7XG59XG5leHBvcnQgZnVuY3Rpb24gaHVtYW5SZWFkYWJsZVRpbWVGcm9tU2Vjb25kcyhzZWNvbmRzKSB7XG4gICAgY29uc3QgdGltZSA9IHNlY29uZHNUb1RpbWUoc2Vjb25kcyk7XG4gICAgcmV0dXJuIGh1bWFuUmVhZGFibGVUaW1lKHRpbWUpO1xufVxuZXhwb3J0IGZ1bmN0aW9uIGdldFZpZXdwb3J0Q2VudGVyKCkge1xuICAgIHJldHVybiBuZXcgVmVjdG9yKHdpbmRvdy5pbm5lcldpZHRoIC8gMiAvIGNvbnN0YW50cy5zY2FsZSwgd2luZG93LmlubmVySGVpZ2h0IC8gMiAvIGNvbnN0YW50cy5zY2FsZSk7XG59XG5leHBvcnQgZnVuY3Rpb24gZ2V0VGVtcGxhdGVNYXhTdGFnZUluZGV4KHRlbXBsYXRlKSB7XG4gICAgcmV0dXJuIHRlbXBsYXRlLnN0YWdlcy5sZW5ndGggLSAxO1xufVxuZXhwb3J0IGZ1bmN0aW9uIGdldFBsYW50SW1hZ2VJRChwbGFudF9pZCwgc3RhZ2UpIHtcbiAgICByZXR1cm4gJ2ltYWdlcy8nICsgcGxhbnRfaWQgKyAnLycgKyBzdGFnZTtcbn1cbmV4cG9ydCBmdW5jdGlvbiBnZXRQbGFudEltYWdlQmxvYmxJRChwbGFudF9pZCwgc3RhZ2UpIHtcbiAgICByZXR1cm4gJ2ltYWdlX2Jsb2JzLycgKyBwbGFudF9pZCArICcvJyArIHN0YWdlO1xufVxuZXhwb3J0IGZ1bmN0aW9uIGdldFRlbXBsYXRlUmVzb3VyY2VJRCh0ZW1wbGF0ZV9pZCkge1xuICAgIHJldHVybiAndGVtcGxhdGVzLycgKyB0ZW1wbGF0ZV9pZDtcbn1cbmV4cG9ydCBmdW5jdGlvbiBnZXRQbGFudFRlbXBsYXRlRnVsbHlHcm93bkltYWdlVVJMKHBsYW50X3RlbXBsYXRlKSB7XG4gICAgY29uc3QgbWF4X3N0YWdlID0gcGxhbnRfdGVtcGxhdGUuc3RhZ2VzLmxlbmd0aCAtIDE7XG4gICAgcmV0dXJuIHBsYW50X3RlbXBsYXRlLnN0YWdlc1ttYXhfc3RhZ2VdLmltYWdlX3VybDtcbn1cbmV4cG9ydCBmdW5jdGlvbiBnZXRUZW1wbGF0ZVVubG9jayh0ZW1wbGF0ZV9pZCwgYWxsX3RlbXBsYXRlcykge1xuICAgIGNvbnN0IHVubG9ja19pZCA9IGFsbF90ZW1wbGF0ZXNbdGVtcGxhdGVfaWRdLnVubG9ja3M7XG4gICAgcmV0dXJuIGFsbF90ZW1wbGF0ZXNbdW5sb2NrX2lkXTtcbn1cbi8qKlxuICogR2V0IHRoZSBtYXhpbXVtIHVuaXRzIG9mIGdyb3d0aCBhIHBsYW50IGNhbiBncm93IHRvXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRUZW1wbGF0ZU1heEdyb3d0aChwbGFudF90ZW1wbGF0ZSkge1xuICAgIGNvbnN0IG1heF9zdGFnZV9pbmRleCA9IGdldFRlbXBsYXRlTWF4U3RhZ2VJbmRleChwbGFudF90ZW1wbGF0ZSk7XG4gICAgcmV0dXJuIHBsYW50X3RlbXBsYXRlLnN0YWdlc1ttYXhfc3RhZ2VfaW5kZXhdLmF0X2dyb3d0aCAqIHBsYW50X3RlbXBsYXRlLm11bHRpcGxpZXI7XG59XG4vKipcbiAqIEdldCB0aGUgcGxhbnRzIG1heCB3YXRlciBpbmRleFxuICogQHBhcmFtIHBsYW50X3RlbXBsYXRlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRUZW1wbGF0ZU1heFdhdGVySW5kZXgocGxhbnRfdGVtcGxhdGUpIHtcbiAgICByZXR1cm4gcGxhbnRfdGVtcGxhdGUud2F0ZXJfbGV2ZWwuc3RhZ2VzLmxlbmd0aCAtIDE7XG59XG4vKipcbiAqIEdldCBwbGFudCdzIG1heCB3YXRlciBsZXZlbFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0VGVtcGxhdGVNYXhXYXRlclN0YWdlKHBsYW50X3RlbXBsYXRlKSB7XG4gICAgY29uc3QgbWF4X2luZGV4ID0gZ2V0VGVtcGxhdGVNYXhXYXRlckluZGV4KHBsYW50X3RlbXBsYXRlKTtcbiAgICByZXR1cm4gcGxhbnRfdGVtcGxhdGUud2F0ZXJfbGV2ZWwuc3RhZ2VzW21heF9pbmRleF07XG59XG4vKipcbiAqIEdldCB0aGUgZ3Jvd3RoIHJhdGUgb2YgYSBwbGFudCBhdCBtYXggd2F0ZXIgbGV2ZWxcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFRlbXBsYXRlTWF4R3Jvd3RoUmF0ZShwbGFudF90ZW1wbGF0ZSkge1xuICAgIGNvbnN0IG1heF93YXRlcl9sZXZlbCA9IGdldFRlbXBsYXRlTWF4V2F0ZXJTdGFnZShwbGFudF90ZW1wbGF0ZSk7XG4gICAgcmV0dXJuIG1heF93YXRlcl9sZXZlbC5ncm93dGhfcmF0ZSAqIHBsYW50X3RlbXBsYXRlLm11bHRpcGxpZXI7XG59XG4vKipcbiAqIFRpbWUgaXQgdGFrZXMgdG8gZ3JvdyBhIHBsYW50IGlmIGl0cyBpcyBhdCBtYXggd2F0ZXIgc3RhZ2VcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHRlbXBsYXRlVGltZVRvR3JvdyhwbGFudF90ZW1wbGF0ZSwgc2Vjb25kc19wZXJfdGljaykge1xuICAgIGNvbnN0IG1heF9ncm93dGggPSBnZXRUZW1wbGF0ZU1heEdyb3d0aChwbGFudF90ZW1wbGF0ZSk7XG4gICAgY29uc3QgbWF4X2dyb3d0aF9yYXRlID0gZ2V0VGVtcGxhdGVNYXhHcm93dGhSYXRlKHBsYW50X3RlbXBsYXRlKTtcbiAgICByZXR1cm4gbWF4X2dyb3d0aCAqIHBsYW50X3RlbXBsYXRlLm11bHRpcGxpZXIgLyBtYXhfZ3Jvd3RoX3JhdGUgKiBzZWNvbmRzX3Blcl90aWNrO1xufVxuLyoqXG4gKiBIb3cgb2Z0ZW4gYSBwbGFudCdzIHdhdGVyIGxldmVsIHJ1bnMgb3V0LCBpbiBzZWNvbmRzXG4gKlxuICovXG5leHBvcnQgZnVuY3Rpb24gdGVtcGxhdGVXYXRlcmluZ0ZyZXF1ZW5jeShwbGFudF90ZW1wbGF0ZSwgc2Vjb25kc19wZXJfdGljaykge1xuICAgIGNvbnN0IHdhdGVyX2RlY3JlYXNlX3JhdGUgPSBwbGFudF90ZW1wbGF0ZS53YXRlcl9sZXZlbC5kZWNyZWFzZV9yYXRlICogcGxhbnRfdGVtcGxhdGUubXVsdGlwbGllcjtcbiAgICByZXR1cm4gMTAwIC8gd2F0ZXJfZGVjcmVhc2VfcmF0ZSAqIHNlY29uZHNfcGVyX3RpY2s7XG59XG4iLCJ2YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICBmdW5jdGlvbiBhZG9wdCh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBQID8gdmFsdWUgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHZhbHVlKTsgfSk7IH1cbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBhZG9wdChyZXN1bHQudmFsdWUpLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xuICAgIH0pO1xufTtcbmltcG9ydCB7IGdldFBsYW50SW1hZ2VCbG9ibElELCBnZXRQbGFudEltYWdlSUQgfSBmcm9tICcuL3V0aWwnO1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSW1hZ2VMb2FkZXIge1xuICAgIGNvbnN0cnVjdG9yKGNhY2hlKSB7XG4gICAgICAgIHRoaXMuY2FjaGUgPSBjYWNoZTtcbiAgICB9XG4gICAgbG9hZFRlbXBsYXRlSW1hZ2VJZk51bGwocGxhbnRfaWQsIHN0YWdlKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCByZXNfaWQgPSBnZXRQbGFudEltYWdlSUQocGxhbnRfaWQsIHN0YWdlKTtcbiAgICAgICAgICAgIGlmICghdGhpcy5jYWNoZS5oYXMocmVzX2lkKSkge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGltZ191cmwgPSAnLi9pbWFnZXMvJyArIHBsYW50X2lkICsgJy8nICsgcGxhbnRfaWQgKyAnXycgKyBzdGFnZSArICcucG5nJztcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW1nX3JlcyA9IHlpZWxkIGZldGNoKGltZ191cmwpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbWdfZGF0YSA9IHlpZWxkIGltZ19yZXMuYmxvYigpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbWFnZSA9IHlpZWxkIGNyZWF0ZUltYWdlQml0bWFwKGltZ19kYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYmxvYl9pZCA9IGdldFBsYW50SW1hZ2VCbG9ibElEKHBsYW50X2lkLCBzdGFnZSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2FjaGUuc2V0KHJlc19pZCwgaW1hZ2UpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNhY2hlLnNldChibG9iX2lkLCBpbWdfZGF0YSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGxvYWQgaW1hZ2U6ICcgKyBlLm1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxufVxuIiwiZXhwb3J0IGRlZmF1bHQgY2xhc3MgTXlDYWNoZSB7XG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMuaXRlbXMgPSB7fTtcbiAgICB9XG4gICAgc2V0KGlkLCB2YWx1ZSkge1xuICAgICAgICBpZiAoaWQgaW4gdGhpcy5pdGVtcykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYWNoZTogQ291bGQgbm90IHN0b3JlIGl0ZW0gYnkgaWQgJyArIGlkICsgJzogaWQgYWxyZWFkeSB0YWtlbicpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuaXRlbXNbaWRdID0gdmFsdWU7XG4gICAgfVxuICAgIGdldChpZCkge1xuICAgICAgICBpZiAoIShpZCBpbiB0aGlzLml0ZW1zKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYWNoZTogQ291bGQgbm90IGZpbmQgaXRlbSBieSBpZCAnICsgaWQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLml0ZW1zW2lkXTtcbiAgICB9XG4gICAgaGFzKGlkKSB7XG4gICAgICAgIHJldHVybiAoaWQgaW4gdGhpcy5pdGVtcyk7XG4gICAgfVxufVxuIiwiZXhwb3J0IGRlZmF1bHQgY2xhc3MgTXlTdG9yYWdlIHtcbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5wcmVmaXggPSAncGl4ZWwtcGxhbnQ6JztcbiAgICB9XG4gICAgZ2V0KGtleSkge1xuICAgICAgICByZXR1cm4gSlNPTi5wYXJzZShsb2NhbFN0b3JhZ2UuZ2V0SXRlbSh0aGlzLnByZWZpeCArIGtleSkpO1xuICAgIH1cbiAgICBzZXQoa2V5LCB2YWx1ZSkge1xuICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSh0aGlzLnByZWZpeCArIGtleSwgSlNPTi5zdHJpbmdpZnkodmFsdWUpKTtcbiAgICB9XG4gICAgaGFzKGtleSkge1xuICAgICAgICByZXR1cm4gISFsb2NhbFN0b3JhZ2UuZ2V0SXRlbSh0aGlzLnByZWZpeCArIGtleSk7XG4gICAgfVxuICAgIHJlbW92ZShrZXkpIHtcbiAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oa2V5KTtcbiAgICB9XG59XG4iLCJpbXBvcnQgVmVjdG9yIGZyb20gJy4vVmVjdG9yJztcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEdhbWVPYmplY3Qge1xuICAgIGNvbnN0cnVjdG9yKHBvc2l0aW9uID0gbmV3IFZlY3RvcigwLCAwKSkge1xuICAgICAgICB0aGlzLnBvc2l0aW9uID0gcG9zaXRpb247XG4gICAgfVxufVxuIiwiaW1wb3J0IFZlY3RvciBmcm9tICcuL1ZlY3Rvcic7XG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSZWN0IHtcbiAgICBjb25zdHJ1Y3Rvcihwb3NpdGlvbiA9IG5ldyBWZWN0b3IoMCwgMCksIHNpemUgPSBuZXcgVmVjdG9yKDAsIDApKSB7XG4gICAgICAgIHRoaXMuc2l6ZSA9IHNpemU7XG4gICAgICAgIHRoaXMucG9zaXRpb24gPSBwb3NpdGlvbjtcbiAgICB9XG4gICAgY2FsY3VsYXRlQm91bmRzKCkge1xuICAgICAgICB0aGlzLmxlZnQgPSB0aGlzLnBvc2l0aW9uLnggLSB0aGlzLnNpemUueCAvIDI7XG4gICAgICAgIHRoaXMucmlnaHQgPSB0aGlzLnBvc2l0aW9uLnggKyB0aGlzLnNpemUueCAvIDI7XG4gICAgICAgIHRoaXMudG9wID0gdGhpcy5wb3NpdGlvbi55IC0gdGhpcy5zaXplLnkgLyAyO1xuICAgICAgICB0aGlzLmJvdHRvbSA9IHRoaXMucG9zaXRpb24ueSAtIHRoaXMuc2l6ZS55IC8gMjtcbiAgICB9XG4gICAgc2V0UG9zaXRpb24odikge1xuICAgICAgICB0aGlzLnBvc2l0aW9uID0gdjtcbiAgICAgICAgdGhpcy5jYWxjdWxhdGVCb3VuZHMoKTtcbiAgICB9XG59XG4iLCJpbXBvcnQgUmVjdCBmcm9tICcuL1JlY3QnO1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUHJvZ3Jlc3NCYXIgZXh0ZW5kcyBSZWN0IHtcbiAgICBjb25zdHJ1Y3RvcihyZWN0LCBvcHRpb25zKSB7XG4gICAgICAgIHN1cGVyKHJlY3QucG9zaXRpb24sIHJlY3Quc2l6ZSk7XG4gICAgICAgIE9iamVjdC5hc3NpZ24odGhpcywgb3B0aW9ucyk7XG4gICAgfVxufVxuLy9leHBvcnQgZGVmYXVsdCBQcm9ncmVzc0JhclxuIiwiaW1wb3J0IEdhbWVPYmplY3QgZnJvbSAnLi9HYW1lT2JqZWN0JztcbmltcG9ydCBWZWN0b3IgZnJvbSAnLi9WZWN0b3InO1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU3ByaXRlIGV4dGVuZHMgR2FtZU9iamVjdCB7XG4gICAgY29uc3RydWN0b3IoaW1hZ2UsIHBvc2l0aW9uKSB7XG4gICAgICAgIHN1cGVyKHBvc2l0aW9uKTtcbiAgICAgICAgdGhpcy5pbWFnZSA9IGltYWdlO1xuICAgICAgICB0aGlzLndpZHRoID0gaW1hZ2Uud2lkdGg7XG4gICAgICAgIHRoaXMuaGVpZ2h0ID0gaW1hZ2UuaGVpZ2h0O1xuICAgIH1cbiAgICBnZXRDZW50ZXIoc2NhbGUgPSAxKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnBvc2l0aW9uLmRpdmlkZShzY2FsZSkuYWRkKG5ldyBWZWN0b3IoLXRoaXMud2lkdGggLyAyLCAtdGhpcy5oZWlnaHQgLyAyKSk7XG4gICAgfVxufVxuIiwiZXhwb3J0IGRlZmF1bHQgY2xhc3MgV2F0ZXJMZXZlbCB7XG4gICAgY29uc3RydWN0b3IoZGVjcmVhc2VfcmF0ZSA9IDAuNSwgc3RhZ2VzID0gW10pIHtcbiAgICAgICAgdGhpcy5zdGFnZXMgPSBzdGFnZXM7XG4gICAgICAgIHRoaXMuY3VycmVudCA9IDEwMDtcbiAgICAgICAgdGhpcy5kZWNyZWFzZV9yYXRlID0gZGVjcmVhc2VfcmF0ZTtcbiAgICAgICAgdGhpcy52YWxpZGF0ZVN0YWdlcygpO1xuICAgICAgICB0aGlzLmNhbGNDdXJyZW50U3RhZ2UoKTtcbiAgICB9XG4gICAgdmFsaWRhdGVTdGFnZXMoKSB7XG4gICAgICAgIGZvciAobGV0IGEgPSAwOyBhIDwgdGhpcy5zdGFnZXMubGVuZ3RoOyBhKyspIHtcbiAgICAgICAgICAgIGNvbnN0IHN0YWdlX2EgPSB0aGlzLnN0YWdlc1thIC0gMV07XG4gICAgICAgICAgICBjb25zdCBzdGFnZV9iID0gdGhpcy5zdGFnZXNbYV07XG4gICAgICAgICAgICBjb25zdCBzdGFnZV9jID0gdGhpcy5zdGFnZXNbYSArIDFdO1xuICAgICAgICAgICAgbGV0IHZhbGlkO1xuICAgICAgICAgICAgaWYgKHRoaXMuc3RhZ2VzLmxlbmd0aCA9PSAxKSB7XG4gICAgICAgICAgICAgICAgdmFsaWQgPSBzdGFnZV9iLmZyb20gPT0gMCAmJiBzdGFnZV9iLnRvID09IDEwMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKGEgPT0gMCkge1xuICAgICAgICAgICAgICAgIHZhbGlkID0gc3RhZ2VfYi5mcm9tID09IDAgJiYgc3RhZ2VfYi50byA9PSBzdGFnZV9jLmZyb207XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChhICE9IHRoaXMuc3RhZ2VzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgICAgICB2YWxpZCA9IHN0YWdlX2EudG8gPT0gc3RhZ2VfYi5mcm9tICYmIHN0YWdlX2IudG8gPT0gc3RhZ2VfYy5mcm9tO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFsaWQgPSBzdGFnZV9iLmZyb20gPT0gc3RhZ2VfYS50byAmJiBzdGFnZV9iLnRvID09IDEwMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghdmFsaWQpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgd2F0ZXIgbGV2ZWwnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBjYWxjQ3VycmVudFN0YWdlKCkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc3RhZ2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBzdGFnZSA9IHRoaXMuc3RhZ2VzW2ldO1xuICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudCA8PSBzdGFnZS50byAmJiB0aGlzLmN1cnJlbnQgPj0gc3RhZ2UuZnJvbSkge1xuICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudF9zdGFnZSA9IGk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRXJyb3IgY2FsY3VsYXRpbmcgd2F0ZXIgY3VycmVudCBzdGFnZScpO1xuICAgIH1cbiAgICBnZXRDdXJyZW50U3RhZ2UoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YWdlc1t0aGlzLmN1cnJlbnRfc3RhZ2VdO1xuICAgIH1cbiAgICBkZWNyZWFzZUJ5VGlja3ModGlja3MpIHtcbiAgICAgICAgdGhpcy5jdXJyZW50ID0gTWF0aC5tYXgoMCwgdGhpcy5jdXJyZW50IC0gdGhpcy5kZWNyZWFzZV9yYXRlICogdGlja3MpO1xuICAgICAgICB0aGlzLmNhbGNDdXJyZW50U3RhZ2UoKTtcbiAgICB9XG4gICAgZGVjcmVhc2UoKSB7XG4gICAgICAgIHRoaXMuZGVjcmVhc2VCeVRpY2tzKDEpO1xuICAgIH1cbiAgICBzZXQoY3VycmVudCkge1xuICAgICAgICB0aGlzLmN1cnJlbnQgPSBjdXJyZW50O1xuICAgICAgICB0aGlzLmNhbGNDdXJyZW50U3RhZ2UoKTtcbiAgICB9XG4gICAgdG9wKCkge1xuICAgICAgICB0aGlzLnNldCgxMDApO1xuICAgIH1cbiAgICBzdGF0aWMgZnJvbVRlbXBsYXRlKHRlbXBsYXRlKSB7XG4gICAgICAgIGNvbnN0IHN0YWdlcyA9IFtdO1xuICAgICAgICBjb25zdCBtdWx0aXBsaWVyID0gdGVtcGxhdGUubXVsdGlwbGllcjtcbiAgICAgICAgdGVtcGxhdGUud2F0ZXJfbGV2ZWwuc3RhZ2VzLmZvckVhY2goKHN0YWdlKSA9PiB7XG4gICAgICAgICAgICBzdGFnZXMucHVzaChPYmplY3QuYXNzaWduKE9iamVjdC5hc3NpZ24oe30sIHN0YWdlKSwgeyBncm93dGhfcmF0ZTogc3RhZ2UuZ3Jvd3RoX3JhdGUgKiBtdWx0aXBsaWVyIH0pKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBuZXcgV2F0ZXJMZXZlbCh0ZW1wbGF0ZS53YXRlcl9sZXZlbC5kZWNyZWFzZV9yYXRlICogbXVsdGlwbGllciwgc3RhZ2VzKTtcbiAgICB9XG59XG4iLCJ2YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICBmdW5jdGlvbiBhZG9wdCh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBQID8gdmFsdWUgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHZhbHVlKTsgfSk7IH1cbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBhZG9wdChyZXN1bHQudmFsdWUpLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xuICAgIH0pO1xufTtcbmltcG9ydCBWZWN0b3IgZnJvbSAnLi9WZWN0b3InO1xuaW1wb3J0IEdhbWVPYmplY3QgZnJvbSAnLi9HYW1lT2JqZWN0JztcbmltcG9ydCBQcm9ncmVzc0JhciBmcm9tICcuL1Byb2dyZXNzQmFyJztcbmltcG9ydCBTcHJpdGUgZnJvbSAnLi9TcHJpdGUnO1xuaW1wb3J0IFdhdGVyTGV2ZWwgZnJvbSAnLi9XYXRlckxldmVsJztcbmltcG9ydCBSZWN0IGZyb20gJy4vUmVjdCc7XG5pbXBvcnQgeyBnZXRQbGFudEltYWdlSUQsIGdldFRlbXBsYXRlUmVzb3VyY2VJRCwgZ2V0Vmlld3BvcnRDZW50ZXIsIHJhbmdlT3ZlcmxhcCB9IGZyb20gJy4vdXRpbCc7XG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQbGFudCBleHRlbmRzIEdhbWVPYmplY3Qge1xuICAgIGNvbnN0cnVjdG9yKGlkLCBvcHRpb25zKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMud2F0ZXJfbGV2ZWwgPSBuZXcgV2F0ZXJMZXZlbCgwLjUsIFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBmcm9tOiAwLFxuICAgICAgICAgICAgICAgIHRvOiAxMDAsXG4gICAgICAgICAgICAgICAgZ3Jvd3RoX3JhdGU6IDRcbiAgICAgICAgICAgIH0sXG4gICAgICAgIF0pO1xuICAgICAgICB0aGlzLmN1cnJlbnRfc3RhZ2UgPSAwO1xuICAgICAgICB0aGlzLmdyb3d0aCA9IDA7XG4gICAgICAgIHRoaXMucG9zaXRpb24gPSBuZXcgVmVjdG9yKDAsIDApO1xuICAgICAgICB0aGlzLnNpemUgPSBuZXcgVmVjdG9yKDE2LCAzMik7XG4gICAgICAgIHRoaXMuaWQgPSBpZDtcbiAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLCBvcHRpb25zKTtcbiAgICAgICAgdGhpcy5pbml0V2F0ZXJMZXZlbEJhcigpO1xuICAgICAgICB0aGlzLnNldFBvc2l0aW9uKGdldFZpZXdwb3J0Q2VudGVyKCkpO1xuICAgIH1cbiAgICBpbml0V2F0ZXJMZXZlbEJhcigpIHtcbiAgICAgICAgY29uc3QgZGl2aWRlcnMgPSB0aGlzLndhdGVyX2xldmVsLnN0YWdlcy5tYXAoc3RhZ2UgPT4gc3RhZ2UudG8pO1xuICAgICAgICBkaXZpZGVycy5wb3AoKTtcbiAgICAgICAgdGhpcy53YXRlcl9sZXZlbF9iYXIgPSBuZXcgUHJvZ3Jlc3NCYXIobmV3IFJlY3QobmV3IFZlY3RvcigwLCAwKSwgbmV3IFZlY3RvcigyMCwgMikpLCB7XG4gICAgICAgICAgICBiZ19jb2xvcjogJyMwMDA4RkY0MicsXG4gICAgICAgICAgICBjb2xvcjogJyMwMDA4RkZBRCcsXG4gICAgICAgICAgICBkaXZpZGVyX2NvbG9yOiAnZGFya2JsdWUnLFxuICAgICAgICAgICAgZGlyZWN0aW9uOiAncmlnaHQnLFxuICAgICAgICAgICAgY3VycmVudDogMCxcbiAgICAgICAgICAgIGRpdmlkZXJzXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLndhdGVyX2xldmVsX2Jhci5jdXJyZW50ID0gdGhpcy53YXRlcl9sZXZlbC5jdXJyZW50O1xuICAgIH1cbiAgICBtYXhHcm93dGgoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YWdlc1t0aGlzLnN0YWdlcy5sZW5ndGggLSAxXS5hdF9ncm93dGg7XG4gICAgfVxuICAgIGlzRnVsbHlHcm93bigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ3Jvd3RoID4gdGhpcy5tYXhHcm93dGgoKTtcbiAgICB9XG4gICAgdG9KU09OKCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgaWQ6IHRoaXMuaWQsXG4gICAgICAgICAgICBwbGFudF9pZDogdGhpcy5wbGFudF9pZCxcbiAgICAgICAgICAgIG5hbWU6IHRoaXMubmFtZSxcbiAgICAgICAgICAgIHdhdGVyX2xldmVsX2N1cnJlbnQ6IHRoaXMud2F0ZXJfbGV2ZWwuY3VycmVudCxcbiAgICAgICAgICAgIGdyb3d0aDogdGhpcy5ncm93dGgsXG4gICAgICAgICAgICBmdWxseV9ncm93bl9jYWxsZWQ6IHRoaXMuZnVsbHlfZ3Jvd25fY2FsbGVkXG4gICAgICAgIH07XG4gICAgfVxuICAgIG9uRnVsbHlHcm93bihjYWxsYmFjaykge1xuICAgICAgICB0aGlzLmZ1bGx5X2dyb3duX2NiID0gY2FsbGJhY2s7XG4gICAgfVxuICAgIHN0YXRpYyBmcm9tSlNPTihqc29uLCBjYWNoZSkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgcGxhbnQgPSB5aWVsZCBQbGFudC5mcm9tVGVtcGxhdGUoanNvbi5pZCwganNvbi5wbGFudF9pZCwgY2FjaGUpO1xuICAgICAgICAgICAgcGxhbnQubmFtZSA9IGpzb24ubmFtZTtcbiAgICAgICAgICAgIHBsYW50LndhdGVyX2xldmVsLnNldChqc29uLndhdGVyX2xldmVsX2N1cnJlbnQpO1xuICAgICAgICAgICAgcGxhbnQuc2V0R3Jvd3RoKGpzb24uZ3Jvd3RoKTtcbiAgICAgICAgICAgIHBsYW50LmZ1bGx5X2dyb3duX2NhbGxlZCA9IGpzb24uZnVsbHlfZ3Jvd25fY2FsbGVkO1xuICAgICAgICAgICAgcmV0dXJuIHBsYW50O1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgc3RhdGljIHN0YWdlc0Zyb21UZW1wbGF0ZSh0ZW1wbGF0ZSwgY2FjaGUpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IHBsYW50X3N0YWdlcyA9IFtdO1xuICAgICAgICAgICAgY29uc3QgbXVsdGlwbGllciA9IHRlbXBsYXRlLm11bHRpcGxpZXI7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRlbXBsYXRlLnN0YWdlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlc19pZCA9IGdldFBsYW50SW1hZ2VJRCh0ZW1wbGF0ZS5wbGFudF9pZCwgaSk7XG4gICAgICAgICAgICAgICAgY29uc3QgaW1hZ2UgPSBjYWNoZS5nZXQocmVzX2lkKTtcbiAgICAgICAgICAgICAgICAvL1BsYW50IGRhdGFcbiAgICAgICAgICAgICAgICBjb25zdCBzcHJpdGUgPSBuZXcgU3ByaXRlKGltYWdlKTtcbiAgICAgICAgICAgICAgICBjb25zdCBhdF9ncm93dGggPSB0ZW1wbGF0ZS5zdGFnZXNbaV0uYXRfZ3Jvd3RoICogbXVsdGlwbGllcjtcbiAgICAgICAgICAgICAgICBwbGFudF9zdGFnZXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIHNwcml0ZSxcbiAgICAgICAgICAgICAgICAgICAgYXRfZ3Jvd3RoXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcGxhbnRfc3RhZ2VzO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgc3RhdGljIGZyb21UZW1wbGF0ZShpZCwgdGVtcGxhdGVfaWQsIGNhY2hlKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCByZXNfaWQgPSBnZXRUZW1wbGF0ZVJlc291cmNlSUQodGVtcGxhdGVfaWQpO1xuICAgICAgICAgICAgaWYgKCFjYWNoZS5oYXMocmVzX2lkKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRlbXBsYXRlX3JlcyA9IHlpZWxkIGZldGNoKCcuL3BsYW50X3RlbXBsYXRlcy8nICsgdGVtcGxhdGVfaWQgKyAnLmpzb24nKTtcbiAgICAgICAgICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IHlpZWxkIHRlbXBsYXRlX3Jlcy5qc29uKCk7XG4gICAgICAgICAgICAgICAgY2FjaGUuc2V0KHJlc19pZCwgdGVtcGxhdGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBjYWNoZS5nZXQocmVzX2lkKTtcbiAgICAgICAgICAgIGNvbnN0IHN0YWdlcyA9IHlpZWxkIFBsYW50LnN0YWdlc0Zyb21UZW1wbGF0ZSh0ZW1wbGF0ZSwgY2FjaGUpO1xuICAgICAgICAgICAgY29uc3Qgd2F0ZXJfbGV2ZWwgPSBXYXRlckxldmVsLmZyb21UZW1wbGF0ZSh0ZW1wbGF0ZSk7XG4gICAgICAgICAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgICAgICAgICAgIHBsYW50X2lkOiB0ZW1wbGF0ZS5wbGFudF9pZCxcbiAgICAgICAgICAgICAgICB3YXRlcl9sZXZlbCxcbiAgICAgICAgICAgICAgICBuYW1lOiAnTXkgUGxhbnQnLFxuICAgICAgICAgICAgICAgIHN0YWdlcyxcbiAgICAgICAgICAgICAgICB1bmxvY2tzOiB0ZW1wbGF0ZS51bmxvY2tzXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBQbGFudChpZCwgb3B0aW9ucyk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBjYWxjdWxhdGVDdXJyZW50U3RhZ2UoKSB7XG4gICAgICAgIGNvbnN0IHN0YWdlX2luZGV4ZXMgPSB0aGlzLnN0YWdlcy5tYXAoKHN0YWdlLCBpbmRleCkgPT4gaW5kZXgpO1xuICAgICAgICB2YXIgY3Vycl9zdGFnZV9pbmRleCA9IHN0YWdlX2luZGV4ZXMucmVkdWNlKChhLCBpKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwcmV2X3N0YWdlID0gdGhpcy5zdGFnZXNbYV07XG4gICAgICAgICAgICBjb25zdCBjdXJyX3N0YWdlID0gdGhpcy5zdGFnZXNbaV07XG4gICAgICAgICAgICBsZXQgaXNfZ3Jvd3RoX2luX2N1cnJfc3RhZ2UgPSBjdXJyX3N0YWdlLmF0X2dyb3d0aCA+IHByZXZfc3RhZ2UuYXRfZ3Jvd3RoICYmIHRoaXMuZ3Jvd3RoID4gY3Vycl9zdGFnZS5hdF9ncm93dGg7XG4gICAgICAgICAgICBpZiAoaXNfZ3Jvd3RoX2luX2N1cnJfc3RhZ2UpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gaTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBhO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5jdXJyZW50X3N0YWdlID0gY3Vycl9zdGFnZV9pbmRleDtcbiAgICB9XG4gICAgZ3Jvd0J5KGFkZGVkX2dyb3d0aCkge1xuICAgICAgICB0aGlzLmdyb3d0aCArPSBhZGRlZF9ncm93dGg7XG4gICAgICAgIHRoaXMuY2FsY3VsYXRlQ3VycmVudFN0YWdlKCk7XG4gICAgICAgIGlmICh0aGlzLmlzRnVsbHlHcm93bigpICYmIHRoaXMuZnVsbHlfZ3Jvd25fY2IgJiYgIXRoaXMuZnVsbHlfZ3Jvd25fY2FsbGVkKSB7XG4gICAgICAgICAgICB0aGlzLmZ1bGx5X2dyb3duX2NiKHRoaXMpO1xuICAgICAgICAgICAgdGhpcy5mdWxseV9ncm93bl9jYWxsZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuICAgIC8qKlxuICAgICAqIEdyb3dzIHBsYW50IGJ5IDEgdGlja1xuICAgICAqL1xuICAgIGdyb3coKSB7XG4gICAgICAgIGxldCBncm93dGhfcmF0ZSA9IDA7XG4gICAgICAgIGlmICh0aGlzLndhdGVyX2xldmVsLmN1cnJlbnQgPiAwKSB7XG4gICAgICAgICAgICBncm93dGhfcmF0ZSA9IHRoaXMud2F0ZXJfbGV2ZWwuZ2V0Q3VycmVudFN0YWdlKCkuZ3Jvd3RoX3JhdGU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5ncm93QnkoZ3Jvd3RoX3JhdGUpO1xuICAgIH1cbiAgICBzZXRHcm93dGgoZ3Jvd3RoKSB7XG4gICAgICAgIHRoaXMuZ3Jvd3RoID0gZ3Jvd3RoO1xuICAgICAgICB0aGlzLmNhbGN1bGF0ZUN1cnJlbnRTdGFnZSgpO1xuICAgIH1cbiAgICBnZXRDdXJyZW50U3RhZ2UoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnN0YWdlc1t0aGlzLmN1cnJlbnRfc3RhZ2VdO1xuICAgIH1cbiAgICBmYXN0Rm9yd2FyZCh0aWNrcykge1xuICAgICAgICBjb25zdCB3YXRlcl9lbmQgPSB0aGlzLndhdGVyX2xldmVsLmN1cnJlbnQ7XG4gICAgICAgIHRoaXMud2F0ZXJfbGV2ZWwuZGVjcmVhc2VCeVRpY2tzKHRpY2tzKTtcbiAgICAgICAgY29uc3Qgd2F0ZXJfc3RhcnQgPSB0aGlzLndhdGVyX2xldmVsLmN1cnJlbnQ7XG4gICAgICAgIGxldCBhZGRlZF9ncm93dGggPSAwO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMud2F0ZXJfbGV2ZWwuc3RhZ2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCB3YXRlcl9zdGFnZSA9IHRoaXMud2F0ZXJfbGV2ZWwuc3RhZ2VzW2ldO1xuICAgICAgICAgICAgY29uc3QgZ3Jvd3RfcmF0ZSA9IHdhdGVyX3N0YWdlLmdyb3d0aF9yYXRlO1xuICAgICAgICAgICAgY29uc3Qgb3ZlcmxhcCA9IHJhbmdlT3ZlcmxhcCh3YXRlcl9zdGFydCwgd2F0ZXJfZW5kLCB3YXRlcl9zdGFnZS5mcm9tLCB3YXRlcl9zdGFnZS50byk7XG4gICAgICAgICAgICBhZGRlZF9ncm93dGggKz0gKG92ZXJsYXAgLyB0aGlzLndhdGVyX2xldmVsLmRlY3JlYXNlX3JhdGUpICogZ3Jvd3RfcmF0ZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmdyb3dCeShhZGRlZF9ncm93dGgpO1xuICAgIH1cbiAgICB0aWNrKCkge1xuICAgICAgICB0aGlzLmdyb3coKTtcbiAgICAgICAgLy90aGlzLndhdGVyX2xldmVsLmRlY3JlYXNlKCk7XG4gICAgICAgIHRoaXMuZGVjcmVhc2VXYXRlckxldmVsKCk7XG4gICAgfVxuICAgIGRlY3JlYXNlV2F0ZXJMZXZlbEJ5VGlja3ModGlja3MpIHtcbiAgICAgICAgdGhpcy53YXRlcl9sZXZlbC5kZWNyZWFzZUJ5VGlja3ModGlja3MpO1xuICAgICAgICB0aGlzLnVwZGF0ZVdhdGVyTGV2ZWxCYXIoKTtcbiAgICB9XG4gICAgZGVjcmVhc2VXYXRlckxldmVsKCkge1xuICAgICAgICB0aGlzLmRlY3JlYXNlV2F0ZXJMZXZlbEJ5VGlja3MoMSk7XG4gICAgfVxuICAgIHVwZGF0ZVdhdGVyTGV2ZWxCYXIoKSB7XG4gICAgICAgIHRoaXMud2F0ZXJfbGV2ZWxfYmFyLmN1cnJlbnQgPSB0aGlzLndhdGVyX2xldmVsLmN1cnJlbnQ7XG4gICAgfVxuICAgIHNldFBvc2l0aW9uKHApIHtcbiAgICAgICAgdGhpcy5wb3NpdGlvbiA9IHA7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zdGFnZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHRoaXMuc3RhZ2VzW2ldLnNwcml0ZS5wb3NpdGlvbiA9IHRoaXMucG9zaXRpb247XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy53YXRlcl9sZXZlbF9iYXIuc2V0UG9zaXRpb24obmV3IFZlY3Rvcih0aGlzLnBvc2l0aW9uLngsIHRoaXMuZ2V0UmVjdCgpLmJvdHRvbSArIDIpKTtcbiAgICB9XG4gICAgZ2V0UmVjdCgpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHRvcDogdGhpcy5wb3NpdGlvbi55IC0gdGhpcy5zaXplLnkgLyAyLFxuICAgICAgICAgICAgYm90dG9tOiB0aGlzLnBvc2l0aW9uLnkgKyB0aGlzLnNpemUueSAvIDIsXG4gICAgICAgICAgICBsZWZ0OiB0aGlzLnBvc2l0aW9uLnggLSB0aGlzLnNpemUueCAvIDIsXG4gICAgICAgICAgICByaWdodDogdGhpcy5wb3NpdGlvbi54ICsgdGhpcy5zaXplLnggLyAyXG4gICAgICAgIH07XG4gICAgfVxufVxuIiwiaW1wb3J0IGNvbnN0YW50cyBmcm9tICcuL2NvbnN0JztcbmltcG9ydCBWZWN0b3IgZnJvbSAnLi9WZWN0b3InO1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUmVuZGVyZXIge1xuICAgIGNvbnN0cnVjdG9yKGNhbnZhc19pZCwgdWlfaWQsIG1lbnVfaWQpIHtcbiAgICAgICAgdGhpcy5zY2FsZSA9IGNvbnN0YW50cy5zY2FsZTtcbiAgICAgICAgdGhpcy5tZW51cyA9IHt9O1xuICAgICAgICB0aGlzLm1lbnUgPSBudWxsO1xuICAgICAgICB0aGlzLmNhbnZhcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNhbnZhc19pZCk7XG4gICAgICAgIHRoaXMudWkgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh1aV9pZCk7XG4gICAgICAgIHRoaXMubWVudV9lbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobWVudV9pZCk7XG4gICAgICAgIGlmICghdGhpcy5jYW52YXMpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ291bGQgbm90IGZpbmQgY2FudmFzIGVsZW1lbnQgYnkgaWQgJyArIGNhbnZhc19pZCk7XG4gICAgICAgIH1cbiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIChlKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNhbGN1bGF0ZUNhbnZhc1NpemUoKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuY3R4ID0gdGhpcy5jYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcbiAgICAgICAgdGhpcy5jYWxjdWxhdGVDYW52YXNTaXplKCk7XG4gICAgfVxuICAgIGNhbGN1bGF0ZUNhbnZhc1NpemUoKSB7XG4gICAgICAgIHRoaXMuY2FudmFzLndpZHRoID0gd2luZG93LmlubmVyV2lkdGg7XG4gICAgICAgIHRoaXMuY2FudmFzLmhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDtcbiAgICAgICAgdGhpcy5jdHguc2NhbGUodGhpcy5zY2FsZSwgdGhpcy5zY2FsZSk7XG4gICAgICAgIHRoaXMuY3R4LmltYWdlU21vb3RoaW5nRW5hYmxlZCA9IGZhbHNlO1xuICAgIH1cbiAgICBjbGVhcigpIHtcbiAgICAgICAgdGhpcy5jdHguY2xlYXJSZWN0KDAsIDAsIHRoaXMuY2FudmFzLndpZHRoLCB0aGlzLmNhbnZhcy5oZWlnaHQpO1xuICAgIH1cbiAgICBzY2FsZWRQb3NpdGlvbihwb3MpIHtcbiAgICAgICAgcmV0dXJuIHBvcy5kaXZpZGUodGhpcy5zY2FsZSk7XG4gICAgfVxuICAgIGRyYXdTcHJpdGUoc3ByaXRlKSB7XG4gICAgICAgIGNvbnN0IHBvcyA9IHNwcml0ZS5wb3NpdGlvbi5hZGQobmV3IFZlY3Rvcigtc3ByaXRlLndpZHRoIC8gMiwgLXNwcml0ZS5oZWlnaHQgLyAyKSk7IC8vc3ByaXRlLmdldENlbnRlcih0aGlzLnNjYWxlKVxuICAgICAgICB0aGlzLmN0eC5kcmF3SW1hZ2Uoc3ByaXRlLmltYWdlLCBwb3MueCwgcG9zLnkpO1xuICAgIH1cbiAgICBkcmF3UmVjdChyZWN0LCBjb2xvcikge1xuICAgICAgICB0aGlzLmN0eC5maWxsU3R5bGUgPSBjb2xvcjtcbiAgICAgICAgdGhpcy5jdHguZmlsbFJlY3QocmVjdC5sZWZ0LCByZWN0LnRvcCwgcmVjdC5zaXplLngsIHJlY3Quc2l6ZS55KTtcbiAgICB9XG4gICAgZHJhd0xpbmUoZnJvbSwgdG8sIGNvbG9yKSB7XG4gICAgICAgIHRoaXMuY3R4LnN0cm9rZVN0eWxlID0gY29sb3I7XG4gICAgICAgIHRoaXMuY3R4LmJlZ2luUGF0aCgpO1xuICAgICAgICB0aGlzLmN0eC5tb3ZlVG8oZnJvbS54LCBmcm9tLnkpO1xuICAgICAgICB0aGlzLmN0eC5saW5lVG8odG8ueCwgdG8ueSk7XG4gICAgICAgIHRoaXMuY3R4LnN0cm9rZSgpO1xuICAgIH1cbiAgICBjdXJyZW50TWVudSgpIHtcbiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRoaXMubWVudSk7XG4gICAgfVxuICAgIGRyYXdQcm9ncmVzc0Jhcihwcm9ncmVzc19iYXIpIHtcbiAgICAgICAgY29uc3QgeyBwb3NpdGlvbiwgc2l6ZSB9ID0gcHJvZ3Jlc3NfYmFyO1xuICAgICAgICBjb25zdCB7IHgsIHkgfSA9IHBvc2l0aW9uO1xuICAgICAgICBjb25zdCB7IHg6IHdpZHRoLCB5OiBoZWlnaHQgfSA9IHNpemU7XG4gICAgICAgIGNvbnN0IGxlZnQgPSB4IC0gd2lkdGggLyAyO1xuICAgICAgICBjb25zdCB0b3AgPSB5IC0gaGVpZ2h0IC8gMjtcbiAgICAgICAgdGhpcy5kcmF3UmVjdChwcm9ncmVzc19iYXIsIHByb2dyZXNzX2Jhci5iZ19jb2xvcik7XG4gICAgICAgIHRoaXMuY3R4LmZpbGxTdHlsZSA9IHByb2dyZXNzX2Jhci5jb2xvcjtcbiAgICAgICAgY29uc3QgbmV3X3JlY3QgPSBzdHJ1Y3R1cmVkQ2xvbmUocHJvZ3Jlc3NfYmFyKTtcbiAgICAgICAgaWYgKHByb2dyZXNzX2Jhci5kaXJlY3Rpb24gPT0gJ3JpZ2h0Jykge1xuICAgICAgICAgICAgbmV3X3JlY3Quc2l6ZS54ID0gcHJvZ3Jlc3NfYmFyLmN1cnJlbnQgLyAxMDAgKiBwcm9ncmVzc19iYXIuc2l6ZS54O1xuICAgICAgICAgICAgdGhpcy5kcmF3UmVjdChuZXdfcmVjdCwgcHJvZ3Jlc3NfYmFyLmNvbG9yKTtcbiAgICAgICAgICAgIGNvbnN0IGJhcl9sZW5ndGggPSBuZXdfcmVjdC5yaWdodCAtIG5ld19yZWN0LmxlZnQ7XG4gICAgICAgICAgICBjb25zdCB5ID0gbmV3X3JlY3QucG9zaXRpb24ueSAtIDE7XG4gICAgICAgICAgICBjb25zdCBlbmRfeSA9IG5ld19yZWN0LmJvdHRvbSArIDI7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGRpdmlkZXIgb2YgcHJvZ3Jlc3NfYmFyLmRpdmlkZXJzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgeCA9IG5ld19yZWN0LnBvc2l0aW9uLnggLSAoYmFyX2xlbmd0aCAvIDIpICsgYmFyX2xlbmd0aCAvIDEwMCAqIGRpdmlkZXI7XG4gICAgICAgICAgICAgICAgY29uc3QgcG9zMSA9IG5ldyBWZWN0b3IoeCwgeSk7XG4gICAgICAgICAgICAgICAgY29uc3QgcG9zMiA9IG5ldyBWZWN0b3IoeCwgZW5kX3kpO1xuICAgICAgICAgICAgICAgIHRoaXMuZHJhd0xpbmUocG9zMSwgcG9zMiwgcHJvZ3Jlc3NfYmFyLmRpdmlkZXJfY29sb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQcm9ncmVzcyBiYXIgcmVuZGVyaW5nIG9ubHkgaW1wbGVtZW50ZWQgZm9yIHJpZ2h0IGRpcmVjdGlvbicpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGRyYXdQbGFudChwbGFudCkge1xuICAgICAgICB0aGlzLmRyYXdTcHJpdGUocGxhbnQuZ2V0Q3VycmVudFN0YWdlKCkuc3ByaXRlKTtcbiAgICAgICAgdGhpcy5kcmF3UHJvZ3Jlc3NCYXIocGxhbnQud2F0ZXJfbGV2ZWxfYmFyKTtcbiAgICAgICAgLy90aGlzLmRyYXdTcHJpdGVcbiAgICB9XG4gICAgYWRkTWVudShtZW51LCBtZW51X2lkKSB7XG4gICAgICAgIGlmIChtZW51X2lkKSB7XG4gICAgICAgICAgICBtZW51LmlkID0gbWVudV9pZCArICctbWVudSc7XG4gICAgICAgIH1cbiAgICAgICAgbWVudS5jbGFzc0xpc3QuYWRkKCdtZW51Jyk7XG4gICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZW51cycpLmFwcGVuZENoaWxkKG1lbnUpO1xuICAgICAgICB0aGlzLm1lbnVzW21lbnVfaWRdID0gbWVudTtcbiAgICB9XG4gICAgc2hvd01lbnUobWVudV9pZCkge1xuICAgICAgICB0aGlzLnVpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgICAgIHRoaXMubWVudV9lbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7XG4gICAgICAgIHRoaXMuaGlkZU1lbnUoKTtcbiAgICAgICAgY29uc3QgbWVudSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKG1lbnVfaWQgKyAnLW1lbnUnKTtcbiAgICAgICAgaWYgKCFtZW51KSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kIG1lbnUgd2l0aCBJRCAnICsgbWVudV9pZCk7XG4gICAgICAgIH1cbiAgICAgICAgbWVudS5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnO1xuICAgICAgICB0aGlzLm1lbnVfZWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnO1xuICAgICAgICB0aGlzLmhpZGVVSSgpO1xuICAgICAgICAvL3RoaXMubWVudV9lbGVtZW50LnJlcGxhY2VXaXRoKHRoaXMubWVudSlcbiAgICB9XG4gICAgaGlkZVVJKCkge1xuICAgICAgICB0aGlzLnVpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgICAgIHRoaXMuY2FudmFzLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgfVxuICAgIHNob3dVSSgpIHtcbiAgICAgICAgdGhpcy51aS5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICAgICAgdGhpcy5jYW52YXMuc3R5bGUuZGlzcGxheSA9ICdmbGV4JztcbiAgICB9XG4gICAgaGlkZU1lbnUoKSB7XG4gICAgICAgIE9iamVjdC5rZXlzKHRoaXMubWVudXMpLmZvckVhY2gobWVudV9pZCA9PiB7XG4gICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChtZW51X2lkICsgJy1tZW51Jykuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMubWVudV9lbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgICAgIHRoaXMuc2hvd1VJKCk7XG4gICAgfVxufVxuIiwiZXhwb3J0IGRlZmF1bHQgY2xhc3MgTXlFdmVudCB7XG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMubWF4X2lkID0gMDtcbiAgICAgICAgdGhpcy5jYWxsYmFja3MgPSB7fTtcbiAgICB9XG4gICAgb24oY2IpIHtcbiAgICAgICAgdGhpcy5jYWxsYmFja3NbdGhpcy5tYXhfaWQrK10gPSBjYjtcbiAgICAgICAgcmV0dXJuIHRoaXMubWF4X2lkO1xuICAgIH1cbiAgICBvZmYoaWQpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMuY2FsbGJhY2tzW2lkXTtcbiAgICB9XG4gICAgZW1pdCguLi5hcmdzKSB7XG4gICAgICAgIGZvciAoY29uc3Qga2V5IGluIHRoaXMuY2FsbGJhY2tzKSB7XG4gICAgICAgICAgICB0aGlzLmNhbGxiYWNrc1trZXldKC4uLmFyZ3MpO1xuICAgICAgICB9XG4gICAgfVxufVxuIiwiaW1wb3J0IE15RXZlbnQgZnJvbSAnLi9NeUV2ZW50JztcbmNvbnN0IG1haW5fZXZlbnRzID0ge1xuICAgIG9uX3JlcXVlc3RfcGxhbnRfbmV3X3BsYW50OiBuZXcgTXlFdmVudCgpLFxuICAgIG9uX3JlcXVlc3Rfd2F0ZXJfcGxhbnQ6IG5ldyBNeUV2ZW50KCksXG4gICAgb25fcmVxdWVzdF9mYXN0X2ZvcndhcmQ6IG5ldyBNeUV2ZW50KCksXG4gICAgb25fcmVxdWVzdF9zaG93X21lbnU6IG5ldyBNeUV2ZW50KCksXG4gICAgb25fcmVxdWVzdF9zZXRfdmlldzogbmV3IE15RXZlbnQoKSxcbiAgICBvbl9yZXF1ZXN0X2RhdGFfcmVzZXQ6IG5ldyBNeUV2ZW50KCksXG4gICAgb25fcmVxdWVzdF9kYXRhX3NhdmU6IG5ldyBNeUV2ZW50KCksXG4gICAgYWZ0ZXJfZGF0YV9yZXNldDogbmV3IE15RXZlbnQoKSxcbiAgICBvbl9mYXN0X2ZvcndhcmQ6IG5ldyBNeUV2ZW50KClcbn07XG5leHBvcnQgZGVmYXVsdCBtYWluX2V2ZW50cztcbiIsImNvbnN0IGdsb2JhbHMgPSB7XG4gICAgc2Vjb25kc19wZXJfdGljazogMSxcbiAgICByZWNlbnRseV91bmxvY2tlZDogJ2Jhc2ljX3BsYW50J1xufTtcbmV4cG9ydCBkZWZhdWx0IGdsb2JhbHM7XG4iLCJ2YXIgX19hd2FpdGVyID0gKHRoaXMgJiYgdGhpcy5fX2F3YWl0ZXIpIHx8IGZ1bmN0aW9uICh0aGlzQXJnLCBfYXJndW1lbnRzLCBQLCBnZW5lcmF0b3IpIHtcbiAgICBmdW5jdGlvbiBhZG9wdCh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBQID8gdmFsdWUgOiBuZXcgUChmdW5jdGlvbiAocmVzb2x2ZSkgeyByZXNvbHZlKHZhbHVlKTsgfSk7IH1cbiAgICByZXR1cm4gbmV3IChQIHx8IChQID0gUHJvbWlzZSkpKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgZnVuY3Rpb24gZnVsZmlsbGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yLm5leHQodmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiByZWplY3RlZCh2YWx1ZSkgeyB0cnkgeyBzdGVwKGdlbmVyYXRvcltcInRocm93XCJdKHZhbHVlKSk7IH0gY2F0Y2ggKGUpIHsgcmVqZWN0KGUpOyB9IH1cbiAgICAgICAgZnVuY3Rpb24gc3RlcChyZXN1bHQpIHsgcmVzdWx0LmRvbmUgPyByZXNvbHZlKHJlc3VsdC52YWx1ZSkgOiBhZG9wdChyZXN1bHQudmFsdWUpLnRoZW4oZnVsZmlsbGVkLCByZWplY3RlZCk7IH1cbiAgICAgICAgc3RlcCgoZ2VuZXJhdG9yID0gZ2VuZXJhdG9yLmFwcGx5KHRoaXNBcmcsIF9hcmd1bWVudHMgfHwgW10pKS5uZXh0KCkpO1xuICAgIH0pO1xufTtcbmltcG9ydCBjb25zdGFudHMgZnJvbSAnLi9jb25zdCc7XG5pbXBvcnQgeyBnZXRQbGFudFRlbXBsYXRlRnVsbHlHcm93bkltYWdlVVJMLCBnZXRUZW1wbGF0ZU1heFN0YWdlSW5kZXgsIGdldFRlbXBsYXRlVW5sb2NrLCBodW1hblJlYWRhYmxlVGltZUZyb21TZWNvbmRzLCBzZWNvbmRzVG9UaW1lLCB0ZW1wbGF0ZVRpbWVUb0dyb3csIHRlbXBsYXRlV2F0ZXJpbmdGcmVxdWVuY3kgfSBmcm9tICcuL3V0aWwnO1xuaW1wb3J0IG1haW5fZXZlbnRzIGZyb20gJy4vbWFpbl9ldmVudHMnO1xuaW1wb3J0IGdsb2JhbHMgZnJvbSAnLi9nbG9iYWxzJztcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFVJTWFuYWdlciB7XG4gICAgY29uc3RydWN0b3IocmVuZGVyZXIpIHtcbiAgICAgICAgLy9nYW1lOiBHYW1lO1xuICAgICAgICB0aGlzLmJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpO1xuICAgICAgICB0aGlzLm1lbnUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgdGhpcy5wbGFudF9idXR0b25zID0gW107XG4gICAgICAgIHRoaXMucGxhbnRfaW1hZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTtcbiAgICAgICAgdGhpcy5wbGFudF9uYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaDInKTtcbiAgICAgICAgdGhpcy5wbGFudF9kZXNjcmlwdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcbiAgICAgICAgdGhpcy5wbGFudF9zdGFnZXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpO1xuICAgICAgICB0aGlzLnBsYW50X3RpbWVfdG9fZ3JvdyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7XG4gICAgICAgIHRoaXMucGxhbnRfd2F0ZXJfZnJlcXVlbmN5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKTtcbiAgICAgICAgdGhpcy50YWJiYWJsZV9lbGVtZW50cyA9IFtdO1xuICAgICAgICB0aGlzLmN1cnJlbnRfdGFiX2luZGV4ID0gMDtcbiAgICAgICAgdGhpcy5jb2xsZWN0aW9uX2ltYWdlcyA9IHt9O1xuICAgICAgICB0aGlzLnJlbmRlcmVyID0gcmVuZGVyZXI7XG4gICAgICAgIHRoaXMuYnV0dG9uLmNsYXNzTGlzdC5hZGQoJ2J1dHRvbicpO1xuICAgICAgICB0aGlzLm1lbnUuY2xhc3NMaXN0LmFkZCgnbWVudScpO1xuICAgICAgICBjb25zdCBOQVZfVVAgPSAnQXJyb3dVcCc7XG4gICAgICAgIGNvbnN0IE5BVl9ET1dOID0gJ0Fycm93RG93bic7XG4gICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCAoZSkgPT4ge1xuICAgICAgICAgICAgLy8gS2V5Ym9hcmQgbmF2aWdhdGlvblxuICAgICAgICAgICAgaWYgKGUuY29kZSA9PSBOQVZfVVApIHtcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgdGhpcy5uYXZpZ2F0ZVVwKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChlLmNvZGUgPT0gTkFWX0RPV04pIHtcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgdGhpcy5uYXZpZ2F0ZURvd24oKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIEtleWJvYXJkIG5hdmlnYXRpb25cbiAgICAgKi9cbiAgICBuYXZpZ2F0ZVVwKCkge1xuICAgICAgICBsZXQgcmVmZXJlbmNlX2luZGV4ID0gdGhpcy5jdXJyZW50X3RhYl9pbmRleDtcbiAgICAgICAgY29uc3QgaW5kaWNlc19hYm92ZSA9IHRoaXMuZ2V0SW5kZXhlcygnYWJvdmUnLCByZWZlcmVuY2VfaW5kZXgpO1xuICAgICAgICBpZiAoaW5kaWNlc19hYm92ZS5sZW5ndGggPT0gMCkge1xuICAgICAgICAgICAgcmVmZXJlbmNlX2luZGV4ID0gdGhpcy5nZXRNYXhJbmRleCgpICsgMTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjbG9zZXN0X2luZGV4ID0gdGhpcy5nZXRDbG9zZXRJbmRleChyZWZlcmVuY2VfaW5kZXgsIHRoaXMuZ2V0SW5kZXhlcygnYWJvdmUnLCByZWZlcmVuY2VfaW5kZXgpKTtcbiAgICAgICAgdGhpcy5uYXZpZ2F0ZVRvSW5kZXgoY2xvc2VzdF9pbmRleCk7XG4gICAgfVxuICAgIG5hdmlnYXRlRG93bigpIHtcbiAgICAgICAgbGV0IHJlZmVyZW5jZV9pbmRleCA9IHRoaXMuY3VycmVudF90YWJfaW5kZXg7XG4gICAgICAgIGNvbnN0IGluZGljZXNfYmVsb3cgPSB0aGlzLmdldEluZGV4ZXMoJ2JlbG93JywgcmVmZXJlbmNlX2luZGV4KTtcbiAgICAgICAgaWYgKGluZGljZXNfYmVsb3cubGVuZ3RoID09IDApIHtcbiAgICAgICAgICAgIHJlZmVyZW5jZV9pbmRleCA9IDA7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY2xvc2VzdF9pbmRleCA9IHRoaXMuZ2V0Q2xvc2V0SW5kZXgocmVmZXJlbmNlX2luZGV4LCB0aGlzLmdldEluZGV4ZXMoJ2JlbG93JywgcmVmZXJlbmNlX2luZGV4KSk7XG4gICAgICAgIHRoaXMubmF2aWdhdGVUb0luZGV4KGNsb3Nlc3RfaW5kZXgpO1xuICAgIH1cbiAgICBnZXRNYXhJbmRleCgpIHtcbiAgICAgICAgcmV0dXJuIE1hdGgubWF4KC4uLnRoaXMuZ2V0SW5kZXhlcygnYWxsJykpO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBSZXR1cm5zIGFycmF5IG9mIGluZGljZXMgZm9yIHZpc2libGUgdGFiYmFibGUgZWxlbWVudHNcbiAgICAgKiBAcGFyYW0gZGlyZWN0aW9uXG4gICAgICogQHBhcmFtIHJlZmVyZW5jZV9pbmRleFxuICAgICAqIEByZXR1cm5zXG4gICAgICovXG4gICAgZ2V0SW5kZXhlcyhkaXJlY3Rpb24gPSAnYWxsJywgcmVmZXJlbmNlX2luZGV4ID0gbnVsbCkge1xuICAgICAgICBsZXQgaW5kaWNlc19hbGwgPSBudWxsO1xuICAgICAgICBjb25zdCB2aXNpYmxlX2VsZW1lbnRzID0gdGhpcy5nZXRWaXNpYmxlRWxlbWVudHMoKTtcbiAgICAgICAgaWYgKGRpcmVjdGlvbiA9PSAnYWxsJykge1xuICAgICAgICAgICAgaW5kaWNlc19hbGwgPSB2aXNpYmxlX2VsZW1lbnRzLm1hcCgoZWxlbWVudCkgPT4gZWxlbWVudC50YWJJbmRleCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAodHlwZW9mIHJlZmVyZW5jZV9pbmRleCA9PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgaW5kaWNlc19hbGwgPSB2aXNpYmxlX2VsZW1lbnRzLmZpbHRlcihlbGVtZW50ID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZGlyZWN0aW9uID09ICdiZWxvdycgPyBlbGVtZW50LnRhYkluZGV4ID4gcmVmZXJlbmNlX2luZGV4IDogZWxlbWVudC50YWJJbmRleCA8IHJlZmVyZW5jZV9pbmRleDtcbiAgICAgICAgICAgIH0pLm1hcCgoZWxlbWVudCkgPT4gZWxlbWVudC50YWJJbmRleCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYElmIGRpcmVjdGlvbiBpc24ndCAnYWxsJywgcmVmZXJlbmNlX2luZGV4IG11c3QgYmUgc3BlY2lmaWVkYCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGluZGljZXNfYWxsO1xuICAgIH1cbiAgICBpc0VsZW1lbnRWaXNpYmxlKGVsZW1lbnQpIHtcbiAgICAgICAgcmV0dXJuIGVsZW1lbnQub2Zmc2V0UGFyZW50ICE9IG51bGw7XG4gICAgfVxuICAgIGdldFZpc2libGVFbGVtZW50cygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudGFiYmFibGVfZWxlbWVudHMuZmlsdGVyKChlbGVtKSA9PiB0aGlzLmlzRWxlbWVudFZpc2libGUoZWxlbSkpO1xuICAgIH1cbiAgICBnZXRFbGVtZW50QnlJbmRleChpbmRleCkge1xuICAgICAgICByZXR1cm4gdGhpcy5nZXRWaXNpYmxlRWxlbWVudHMoKS5maW5kKGVsZW0gPT4gZWxlbS50YWJJbmRleCA9PSBpbmRleCk7XG4gICAgfVxuICAgIGdldENsb3NldEluZGV4KHJlZmVyZW5jZV9pbmRleCwgZnJvbSkge1xuICAgICAgICBpZiAoZnJvbS5sZW5ndGggPT0gMSkge1xuICAgICAgICAgICAgcmV0dXJuIGZyb21bMF07XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZyb20ucmVkdWNlKChhLCBiKSA9PiB7XG4gICAgICAgICAgICAvL2NvbnN0IGEgPSBwYXJzZUludChhX3N0cik7XG4gICAgICAgICAgICAvL2NvbnN0IGIgPSBwYXJzZUludChiX3N0cik7XG4gICAgICAgICAgICByZXR1cm4gTWF0aC5hYnMoYiAtIHJlZmVyZW5jZV9pbmRleCkgPCBNYXRoLmFicyhhIC0gcmVmZXJlbmNlX2luZGV4KSA/IGIgOiBhO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgbmF2aWdhdGVUb0luZGV4KGluZGV4KSB7XG4gICAgICAgIGNvbnN0IHRhcmdldF9lbGVtID0gdGhpcy5nZXRFbGVtZW50QnlJbmRleChpbmRleCk7XG4gICAgICAgIHRoaXMuY3VycmVudF90YWJfaW5kZXggPSBpbmRleDtcbiAgICAgICAgdGFyZ2V0X2VsZW0uZm9jdXMoKTtcbiAgICB9XG4gICAgaW5pdEdhbWVVSSgpIHtcbiAgICAgICAgLy8gR2FtZSBVSVxuICAgICAgICAvLyB3YXRlcl9idXR0b24uaW5uZXJIVE1MID0gJ1dhdGVyIFBsYW50J1xuICAgICAgICAvLyB3YXRlcl9idXR0b24uc3R5bGUucG9zaXRpb24gPSAnYWJzb2x1dGUnXG4gICAgICAgIC8vIHdhdGVyX2J1dHRvbi5zdHlsZS50b3AgPSAnMTQwcHgnXG4gICAgICAgIC8vIHdhdGVyX2J1dHRvbi5zdHlsZS5sZWZ0ID0gJzUwJSc7XG4gICAgICAgIC8vIHdhdGVyX2J1dHRvbi5zdHlsZS50cmFuc2Zvcm0gPSAndHJhbnNsYXRlWCgtNTAlKSdcbiAgICAgICAgLy8gd2F0ZXJfYnV0dG9uLnRhYkluZGV4ID0gNDtcbiAgICAgICAgLy9CYWNrIGJ1dHRvblxuICAgICAgICBjb25zdCBiYWNrX2J1dHRvbiA9IHRoaXMuY3JlYXRlTGlua0J1dHRvbignQmFjaycsICdtYWluJywgJ2J1dHRvbi10bCcsIDEpO1xuICAgICAgICB0aGlzLndhdGVyX2J1dHRvbiA9IHRoaXMuY3JlYXRlQnV0dG9uKCdXYXRlciBQbGFudCcsICd3YXRlci1idXR0b24nLCAyKTtcbiAgICAgICAgY29uc3Qgd2F0ZXJfYnV0dG9uID0gdGhpcy53YXRlcl9idXR0b247XG4gICAgICAgIC8vUHJvZ3Jlc3MgbWVzc2FnZVxuICAgICAgICBjb25zdCBwcm9ncmVzc19tZXNzYWdlX2NvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICB0aGlzLnByb2dyZXNzX21lc3NhZ2VfY29udGFpbmVyID0gcHJvZ3Jlc3NfbWVzc2FnZV9jb250YWluZXI7XG4gICAgICAgIHByb2dyZXNzX21lc3NhZ2VfY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoJ3Byb2dyZXNzLW1lc3NhZ2UnKTtcbiAgICAgICAgLy8gcHJvZ3Jlc3NfbWVzc2FnZV9jb250YWluZXIudGFiSW5kZXggPSAwO1xuICAgICAgICBjb25zdCBwcm9ncmVzc19tZXNzYWdlX2JvdHRvbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICBwcm9ncmVzc19tZXNzYWdlX2JvdHRvbS5jbGFzc0xpc3QuYWRkKCdwcm9ncmVzcy1tZXNzYWdlLWJvdHRvbScpO1xuICAgICAgICB0aGlzLnByb2dyZXNzX21lc3NhZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdwJyk7XG4gICAgICAgIGNvbnN0IHByb2dyZXNzX21lc3NhZ2UgPSB0aGlzLnByb2dyZXNzX21lc3NhZ2U7XG4gICAgICAgIHByb2dyZXNzX21lc3NhZ2UuaW5uZXJIVE1MID0gJ1lvdSB3ZXJlIGF3YXkgZm9yIG4gaG91cnMgbiBtaW51dGVzIGFuZCB5b3VyIHBsYW50IGhhcyBncm93biBieSB4ICUnO1xuICAgICAgICBjb25zdCBkaXNtaXNzX2J1dHRvbiA9IHRoaXMuY3JlYXRlQnV0dG9uKCdEaXNtaXNzJywgJ21lbnUtYnV0dG9uJywgMywgKCkgPT4ge1xuICAgICAgICAgICAgcHJvZ3Jlc3NfbWVzc2FnZV9jb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucHJvZ3Jlc3NfbWVzc2FnZV9wbGFudCA9IHRoaXMuY3JlYXRlQnV0dG9uKCdQbGFudCcsICdtZW51LWJ1dHRvbicsIDQpO1xuICAgICAgICB0aGlzLnByb2dyZXNzX21lc3NhZ2VfcGxhbnQuY2xhc3NMaXN0LmFkZCgnc21hbGwtYnV0dG9uJyk7XG4gICAgICAgIHRoaXMucHJvZ3Jlc3NfbWVzc2FnZV9wbGFudC5pbm5lckhUTUwgPSAnUGxhbnQnO1xuICAgICAgICBwcm9ncmVzc19tZXNzYWdlX2NvbnRhaW5lci5hcHBlbmRDaGlsZChwcm9ncmVzc19tZXNzYWdlKTtcbiAgICAgICAgcHJvZ3Jlc3NfbWVzc2FnZV9jb250YWluZXIuYXBwZW5kQ2hpbGQocHJvZ3Jlc3NfbWVzc2FnZV9ib3R0b20pO1xuICAgICAgICBwcm9ncmVzc19tZXNzYWdlX2JvdHRvbS5hcHBlbmRDaGlsZChkaXNtaXNzX2J1dHRvbik7XG4gICAgICAgIHByb2dyZXNzX21lc3NhZ2VfYm90dG9tLmFwcGVuZENoaWxkKHRoaXMucHJvZ3Jlc3NfbWVzc2FnZV9wbGFudCk7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBIYXZlIHRvIHVzZSBtb3VzZWRvd24gaW5zdGVhZCBvZiBjbGljayBoZXJlIGJlY2F1c2Ugb3RoZXJ3aXNlIHRoZSBwcm9ncmVzc1xuICAgICAgICAgKiBtZXNzYWdlIGNvbnRhaW5lciBsb3NlcyBmb2N1cyBiZWZvcmUgdGhlIGNsaWNrIGV2ZW50IGlzIGZpcmVkXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLnByb2dyZXNzX21lc3NhZ2VfcGxhbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgKCkgPT4ge1xuICAgICAgICAgICAgcHJvZ3Jlc3NfbWVzc2FnZV9jb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgICAgIG1haW5fZXZlbnRzLm9uX3JlcXVlc3RfcGxhbnRfbmV3X3BsYW50LmVtaXQoZ2xvYmFscy5yZWNlbnRseV91bmxvY2tlZCk7XG4gICAgICAgIH0pO1xuICAgICAgICAvLyBwcm9ncmVzc19tZXNzYWdlX2NvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCdmb2N1c291dCcsICgpID0+IHtcbiAgICAgICAgLy8gICAgIHByb2dyZXNzX21lc3NhZ2VfY29udGFpbmVyLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSdcbiAgICAgICAgLy8gfSlcbiAgICAgICAgd2F0ZXJfYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgICAgICAgICAgbWFpbl9ldmVudHMub25fcmVxdWVzdF93YXRlcl9wbGFudC5lbWl0KCk7XG4gICAgICAgICAgICAvL3RoaXMuZ2FtZS53YXRlckN1cnJlbnRQbGFudCgpXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnVpLmFwcGVuZENoaWxkKHdhdGVyX2J1dHRvbik7XG4gICAgICAgIHRoaXMucmVuZGVyZXIudWkuYXBwZW5kQ2hpbGQoYmFja19idXR0b24pO1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnVpLmFwcGVuZENoaWxkKHByb2dyZXNzX21lc3NhZ2VfY29udGFpbmVyKTtcbiAgICB9XG4gICAgaW5pdE1haW5NZW51KGlzX25ld19nYW1lKSB7XG4gICAgICAgIC8vTWFpbiBtZW51XG4gICAgICAgIC8vUGxheSBidXR0b25cbiAgICAgICAgdGhpcy5wbGF5X2J1dHRvbiA9IHRoaXMuY3JlYXRlVmlld0J1dHRvbihpc19uZXdfZ2FtZSA/ICdOZXcgR2FtZScgOiAnTXkgUGxhbnQnLCAncGxhbnQnLCAnbWVudS1idXR0b24nLCAxLCAoKSA9PiB7XG4gICAgICAgICAgICBtYWluX2V2ZW50cy5vbl9yZXF1ZXN0X2Zhc3RfZm9yd2FyZC5lbWl0KCk7XG4gICAgICAgICAgICAvL3RoaXMuZ2FtZS5mYXN0Rm9yd2FyZEJ5U2Vjb25kcyh0aGlzLmdhbWUuZ2V0VGltZUF3YXkoKSlcbiAgICAgICAgfSk7XG4gICAgICAgIC8vQ29sbGVjdGlvbiBidXR0b25cbiAgICAgICAgY29uc3QgY29sbGVjdGlvbl9idXR0b24gPSB0aGlzLmNyZWF0ZUxpbmtCdXR0b24oJ0NvbGxlY3Rpb24nLCAnY29sbGVjdGlvbicsICdtZW51LWJ1dHRvbicsIDIpO1xuICAgICAgICAvL0hlbHAgYnV0dG9uXG4gICAgICAgIGNvbnN0IGhlbHBfYnV0dG9uID0gdGhpcy5jcmVhdGVMaW5rQnV0dG9uKCdIZWxwJywgJ2hlbHAnLCAnbWVudS1idXR0b24nLCAzKTtcbiAgICAgICAgLy9PcHRpb25zIGJ1dHRvblxuICAgICAgICBjb25zdCBvcHRpb25zX2J1dHRvbiA9IHRoaXMuY3JlYXRlTGlua0J1dHRvbignT3B0aW9ucycsICdvcHRpb25zJywgJ21lbnUtYnV0dG9uJywgNCk7XG4gICAgICAgIHRoaXMubWFpbl9tZW51ID0gdGhpcy5jcmVhdGVNZW51KCk7XG4gICAgICAgIHRoaXMubWFpbl9tZW51LmFwcGVuZENoaWxkKHRoaXMucGxheV9idXR0b24pO1xuICAgICAgICB0aGlzLm1haW5fbWVudS5hcHBlbmRDaGlsZChjb2xsZWN0aW9uX2J1dHRvbik7XG4gICAgICAgIHRoaXMubWFpbl9tZW51LmFwcGVuZENoaWxkKGhlbHBfYnV0dG9uKTtcbiAgICAgICAgdGhpcy5tYWluX21lbnUuYXBwZW5kQ2hpbGQob3B0aW9uc19idXR0b24pO1xuICAgICAgICB0aGlzLnJlbmRlcmVyLmFkZE1lbnUodGhpcy5tYWluX21lbnUsICdtYWluJyk7XG4gICAgfVxuICAgIGluaXRPcHRpb25zTWVudSgpIHtcbiAgICAgICAgLy9PcHRpb25zIG1lbnVcbiAgICAgICAgY29uc3Qgb3B0aW9uc19tZW51ID0gdGhpcy5jcmVhdGVNZW51KCk7XG4gICAgICAgIGNvbnN0IHBhY2Vfc2VsZWN0b3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgY29uc3QgcGFjZV9zZWxlY3Rvcl9sYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcbiAgICAgICAgY29uc3QgcGFjZV9zZWxlY3Rvcl9kcm9wZG93biA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NlbGVjdCcpO1xuICAgICAgICAvLyBNYWtlIGRyb3Bkb3duIG5hdmlnYXRhYmxlIGJ5IGFycm93IGtleXNcbiAgICAgICAgdGhpcy5hZGRUYWJiYWJsZUVsZW1lbnQocGFjZV9zZWxlY3Rvcl9kcm9wZG93biwgMSk7XG4gICAgICAgIHBhY2Vfc2VsZWN0b3IuY2xhc3NMaXN0LmFkZCgncGFjZS1zZWxlY3RvcicpO1xuICAgICAgICBwYWNlX3NlbGVjdG9yX2xhYmVsLmlubmVySFRNTCA9ICdQYWNlOiAnO1xuICAgICAgICBmb3IgKGNvbnN0IHBhY2Vfa2V5IGluIGNvbnN0YW50cy5wYWNlcykge1xuICAgICAgICAgICAgY29uc3Qgb3B0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJyk7XG4gICAgICAgICAgICBvcHRpb24udmFsdWUgPSBwYWNlX2tleTtcbiAgICAgICAgICAgIG9wdGlvbi5pbm5lckhUTUwgPSBwYWNlX2tleTtcbiAgICAgICAgICAgIGxldCBzaG91bGRfYmVfc2VsZWN0ZWQgPSBwYXJzZUZsb2F0KHBhY2Vfa2V5KSA9PSAxIC8gZ2xvYmFscy5zZWNvbmRzX3Blcl90aWNrO1xuICAgICAgICAgICAgaWYgKHNob3VsZF9iZV9zZWxlY3RlZCkge1xuICAgICAgICAgICAgICAgIG9wdGlvbi5zZWxlY3RlZCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBwYWNlX3NlbGVjdG9yX2Ryb3Bkb3duLmFwcGVuZENoaWxkKG9wdGlvbik7XG4gICAgICAgIH1cbiAgICAgICAgbWFpbl9ldmVudHMuYWZ0ZXJfZGF0YV9yZXNldC5vbigoKSA9PiB7XG4gICAgICAgICAgICBwYWNlX3NlbGVjdG9yX2Ryb3Bkb3duLnZhbHVlID0gXCIxXCI7XG4gICAgICAgIH0pO1xuICAgICAgICBwYWNlX3NlbGVjdG9yLmFwcGVuZENoaWxkKHBhY2Vfc2VsZWN0b3JfbGFiZWwpO1xuICAgICAgICBwYWNlX3NlbGVjdG9yLmFwcGVuZENoaWxkKHBhY2Vfc2VsZWN0b3JfZHJvcGRvd24pO1xuICAgICAgICBjb25zdCBvcHRpb25zX2JhY2sgPSB0aGlzLmNyZWF0ZUxpbmtCdXR0b24oJ0JhY2snLCAnbWFpbicsICdtZW51LWJ1dHRvbicsIDIpO1xuICAgICAgICBjb25zdCByZXNldF9idXR0b24gPSB0aGlzLmNyZWF0ZUJ1dHRvbignUmVzZXQgR2FtZScsICdtZW51LWJ1dHRvbicsIDMpO1xuICAgICAgICBvcHRpb25zX21lbnUuYXBwZW5kQ2hpbGQocGFjZV9zZWxlY3Rvcik7XG4gICAgICAgIG9wdGlvbnNfbWVudS5hcHBlbmRDaGlsZChvcHRpb25zX2JhY2spO1xuICAgICAgICBvcHRpb25zX21lbnUuYXBwZW5kQ2hpbGQocmVzZXRfYnV0dG9uKTtcbiAgICAgICAgLy9PcHRpb25zIG1lbnVcbiAgICAgICAgcGFjZV9zZWxlY3Rvcl9kcm9wZG93bi5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCAoZSkgPT4ge1xuICAgICAgICAgICAgZ2xvYmFscy5zZWNvbmRzX3Blcl90aWNrID0gMSAvIHBhcnNlRmxvYXQoZS50YXJnZXQudmFsdWUpO1xuICAgICAgICAgICAgbWFpbl9ldmVudHMub25fcmVxdWVzdF9kYXRhX3NhdmUuZW1pdCgpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmVzZXRfYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgICAgICAgICAgbWFpbl9ldmVudHMub25fcmVxdWVzdF9kYXRhX3Jlc2V0LmVtaXQoKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuYWRkTWVudShvcHRpb25zX21lbnUsICdvcHRpb25zJyk7XG4gICAgfVxuICAgIGluaXRDb2xsZWN0aW9uTWVudShwbGFudF90ZW1wbGF0ZXMsIHVubG9ja2VkX3BsYW50cywgZ3Jvd25fcGxhbnRzKSB7XG4gICAgICAgIC8vIENvbGxlY3Rpb24gbWVudVxuICAgICAgICBjb25zdCBjb2xsZWN0aW9uX21lbnUgPSB0aGlzLmNyZWF0ZU1lbnUoJ21lbnUtbm9uLWNlbnRlcmVkJyk7XG4gICAgICAgIGNvbnN0IGNvbGxlY3Rpb25fYmFjayA9IHRoaXMuY3JlYXRlTGlua0J1dHRvbignQmFjaycsICdtYWluJywgJ21lbnUtYnV0dG9uJywgMSk7XG4gICAgICAgIGNvbGxlY3Rpb25fbWVudS5hcHBlbmRDaGlsZChjb2xsZWN0aW9uX2JhY2spO1xuICAgICAgICBsZXQgYnV0dG9uX2luZGV4ID0gMTtcbiAgICAgICAgZm9yIChjb25zdCB0ZW1wbGF0ZV9pZCBpbiBwbGFudF90ZW1wbGF0ZXMpIHtcbiAgICAgICAgICAgIGJ1dHRvbl9pbmRleCsrO1xuICAgICAgICAgICAgY29uc3QgcGxhbnRfYnV0dG9uID0gdGhpcy5jcmVhdGVCdXR0b24oJycsICdtZW51LWJ1dHRvbicsIGJ1dHRvbl9pbmRleCk7XG4gICAgICAgICAgICBwbGFudF9idXR0b24uY2xhc3NMaXN0LmFkZCgncGxhbnQtYnV0dG9uJyk7XG4gICAgICAgICAgICAvLyBjb25zdCBwbGFudCA9IGF3YWl0IFBsYW50LmZyb21UZW1wbGF0ZSh0ZW1wbGF0ZV9pZCwgdGVtcGxhdGVfaWQsIHRoaXMuY2FjaGUpXG4gICAgICAgICAgICBjb25zdCBwbGFudF90ZW1wbGF0ZSA9IHBsYW50X3RlbXBsYXRlc1t0ZW1wbGF0ZV9pZF07XG4gICAgICAgICAgICBjb25zdCBpbWdfZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpO1xuICAgICAgICAgICAgaW1nX2VsZW1lbnQuY2xhc3NMaXN0LmFkZCgnY29sbGVjdGlvbi1pbWFnZScpO1xuICAgICAgICAgICAgdGhpcy5jb2xsZWN0aW9uX2ltYWdlc1t0ZW1wbGF0ZV9pZF0gPSBpbWdfZWxlbWVudDtcbiAgICAgICAgICAgIHBsYW50X2J1dHRvbi5hcHBlbmRDaGlsZChpbWdfZWxlbWVudCk7XG4gICAgICAgICAgICBjb25zdCBpc19wbGFudF91bmxvY2tlZCA9IHVubG9ja2VkX3BsYW50cy5pbmNsdWRlcyhwbGFudF90ZW1wbGF0ZS5wbGFudF9pZCk7XG4gICAgICAgICAgICBjb25zdCBpc19wbGFudF9ncm93biA9IGdyb3duX3BsYW50cy5pbmNsdWRlcyhwbGFudF90ZW1wbGF0ZS5wbGFudF9pZCk7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUNvbGxlY3Rpb25JbWFnZShwbGFudF90ZW1wbGF0ZSwgaXNfcGxhbnRfdW5sb2NrZWQsIGlzX3BsYW50X2dyb3duKTtcbiAgICAgICAgICAgIGNvbGxlY3Rpb25fbWVudS5hcHBlbmRDaGlsZChwbGFudF9idXR0b24pO1xuICAgICAgICB9XG4gICAgICAgIG1haW5fZXZlbnRzLmFmdGVyX2RhdGFfcmVzZXQub24oKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZXNldENvbGxlY3Rpb25JbWFnZXMocGxhbnRfdGVtcGxhdGVzKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuYWRkTWVudShjb2xsZWN0aW9uX21lbnUsICdjb2xsZWN0aW9uJyk7XG4gICAgfVxuICAgIGluaXRQbGFudEVudHJ5TWVudSgpIHtcbiAgICAgICAgLy9QbGFudCBFbnRyeVxuICAgICAgICBjb25zdCBwbGFudF9tZW51ID0gdGhpcy5jcmVhdGVNZW51KCk7XG4gICAgICAgIGNvbnN0IHBsYW50X2JhY2sgPSB0aGlzLmNyZWF0ZUxpbmtCdXR0b24oJ0JhY2snLCAnY29sbGVjdGlvbicsICdtZW51LWJ1dHRvbicsIDEpO1xuICAgICAgICB0aGlzLnBsYW50X2ltYWdlLmNsYXNzTGlzdC5hZGQoJ3BsYW50LWVudHJ5LWltYWdlJyk7XG4gICAgICAgIGNvbnN0IHBsYW50X2J1dHRvbiA9IHRoaXMuY3JlYXRlQnV0dG9uKCdQbGFudCcsICdtZW51LWJ1dHRvbicsIDIpO1xuICAgICAgICBjb25zdCBzdGF0cyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3VsJyk7XG4gICAgICAgIHN0YXRzLmFwcGVuZENoaWxkKHRoaXMucGxhbnRfc3RhZ2VzKTtcbiAgICAgICAgc3RhdHMuYXBwZW5kQ2hpbGQodGhpcy5wbGFudF90aW1lX3RvX2dyb3cpO1xuICAgICAgICBzdGF0cy5hcHBlbmRDaGlsZCh0aGlzLnBsYW50X3dhdGVyX2ZyZXF1ZW5jeSk7XG4gICAgICAgIGNvbnN0IGluZm8gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICAgICAgaW5mby5jbGFzc0xpc3QuYWRkKCdwbGFudC1lbnRyeS1pbmZvJyk7XG4gICAgICAgIGluZm8uYXBwZW5kQ2hpbGQodGhpcy5wbGFudF9kZXNjcmlwdGlvbik7XG4gICAgICAgIGluZm8uYXBwZW5kQ2hpbGQoc3RhdHMpO1xuICAgICAgICBwbGFudF9tZW51LmFwcGVuZENoaWxkKHBsYW50X2JhY2spO1xuICAgICAgICBwbGFudF9tZW51LmFwcGVuZENoaWxkKHRoaXMucGxhbnRfaW1hZ2UpO1xuICAgICAgICBwbGFudF9tZW51LmFwcGVuZENoaWxkKHRoaXMucGxhbnRfbmFtZSk7XG4gICAgICAgIHBsYW50X21lbnUuYXBwZW5kQ2hpbGQoaW5mbyk7XG4gICAgICAgIHBsYW50X21lbnUuYXBwZW5kQ2hpbGQocGxhbnRfYnV0dG9uKTtcbiAgICAgICAgcGxhbnRfYnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgICAgICAgICAgbWFpbl9ldmVudHMub25fcmVxdWVzdF9wbGFudF9uZXdfcGxhbnQuZW1pdCh0aGlzLmN1cnJlbnRfcGxhbnRfaW5fbWVudS5wbGFudF9pZCk7XG4gICAgICAgICAgICAvL3RoaXMuZ2FtZS5wbGFudE5ld1BsYW50KHRoaXMuY3VycmVudF9wbGFudF9pbl9tZW51LnBsYW50X2lkKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuYWRkTWVudShwbGFudF9tZW51LCAncGxhbnQnKTtcbiAgICB9XG4gICAgaW5pdEhlbHBNZW51KCkge1xuICAgICAgICBjb25zdCBoZWxwX21lbnUgPSB0aGlzLmNyZWF0ZU1lbnUoJ21lbnUtbm9uLWNlbnRlcmVkJyk7XG4gICAgICAgIGNvbnN0IGJhY2tfYnV0dG9uID0gdGhpcy5jcmVhdGVMaW5rQnV0dG9uKCdCYWNrJywgJ21haW4nLCBudWxsLCAxKTtcbiAgICAgICAgY29uc3QgdGV4dF9lbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpO1xuICAgICAgICB0ZXh0X2VsZW1lbnQuaW5uZXJIVE1MID0gYFdlbGNvbWUgdG8gTXkgUGl4ZWwgUGxhbnQuIFRoaXMgaXMgYSBzbWFsbCByZWxheGluZyBnYW1lIHdoZXJlIHRoZSBzb2xlXG4gICAgICAgIHB1cnBvc2UgaXMgdG8ganVzdCB3YXRlciB5b3VyIHBsYW50IGFuZCB3YXRjaCBpdCBncm93Ljxicj48YnI+XG4gICAgICAgIFxuICAgICAgICBFYWNoIHBsYW50IGhhcyBzZXZlcmFsIHN0YWdlcyBvZiBncm93dGgsIGVhY2ggb2YgdmFyeWluZyBsZW5ndGhzLiA8YnI+PGJyPlxuICAgICAgICBcbiAgICAgICAgQSBwbGFudCBoYXMgYSB3YXRlciBsZXZlbCAtIHdoaWNoIGluZGljYXRlcyBob3cgbXVjaCB3YXRlciB0aGUgcGxhbnQgaGFzLiBUaGUgd2F0ZXJcbiAgICAgICAgbGV2ZWxzIGFyZSBzcGxpdCBpbnRvIHdhdGVyIGxldmVsIHN0YWdlcywgYW5kIHRoZSBsZXNzIHdhdGVyIGEgcGxhbnQgaGFzLCB0aGUgc2xvd2VyIGl0IHdpbGwgZ3Jvdy4gVGhlIHdhdGVyIGxldmVsXG4gICAgICAgIHN0YWdlcyBhcmUgZGl2aWRlZCBieSBkYXJrIHZlcnRpY2FsIGxpbmVzIHRoYXQgeW91IGNhbiBzZWUgb24geW91ciB3YXRlciBsZXZlbCBiYXIuIDxicj48YnI+XG4gICAgICAgIFxuICAgICAgICBXaGVuZXZlciB5b3UgZ3JvdyBhIHBsYW50LCBhIG5ldyBwbGFudCBnZXRzIHVubG9ja2VkLiBFYWNoIG5ld2x5IHVubG9ja2VkIHBsYW50IHRha2VzIGxvbmdlciBhbmQgbG9uZ2VyIHRvIGdyb3cuIDxicj48YnI+XG4gICAgICAgIFxuICAgICAgICBUaGUgQ29sbGVjdGlvbiBpcyBhIHBsYWNlIHdoZXJlIHlvdSBjYW4gdmlldyBhbGwgb2YgeW91ciB1bmxvY2tlZCBwbGFudCB0eXBlcyBhbmQgc29tZSBpbmZvcm1hdGlvbiBhYm91dCB0aGVtLCBzdWNoIGFzIGhvdyBsb25nIHRoZXkgdGFrZSB0byBncm93LCBob3cgbWFueSBzdGFnZXNcbiAgICAgICAgdGhleSBoYXZlLCBhbmQgaG93IGZyZXF1ZW50bHkgdGhleSBoYXZlIHRvIGJlIHdhdGVyZWQuIEN1cnJlbnRseSB0aGVyZSBhcmUgNCBwbGFudCB0eXBlcyBpbiB0aGUgZ2FtZS4gPGJyPjxicj5cbiAgICAgICAgXG4gICAgICAgIEdvb2QgbHVjayB3aXRoIHlvdXIgcGxhbnRzIGFuZCBJIGhvcGUgeW91J2xsIGhhdmUgZnVuIHBsYXlpbmcgdGhpcyBsaXR0bGUgZ2FtZSFcbiAgICAgICAgYDtcbiAgICAgICAgaGVscF9tZW51LmFwcGVuZENoaWxkKGJhY2tfYnV0dG9uKTtcbiAgICAgICAgaGVscF9tZW51LmFwcGVuZENoaWxkKHRleHRfZWxlbWVudCk7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuYWRkTWVudShoZWxwX21lbnUsICdoZWxwJyk7XG4gICAgfVxuICAgIGluaXRVaShwbGFudF90ZW1wbGF0ZXMsIHVubG9ja2VkX3BsYW50cywgZ3Jvd25fcGxhbnRzLCBpc19uZXdfZ2FtZSkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgdGhpcy5pbml0R2FtZVVJKCk7XG4gICAgICAgICAgICB0aGlzLmluaXRNYWluTWVudShpc19uZXdfZ2FtZSk7XG4gICAgICAgICAgICB0aGlzLmluaXRPcHRpb25zTWVudSgpO1xuICAgICAgICAgICAgdGhpcy5pbml0UGxhbnRFbnRyeU1lbnUoKTtcbiAgICAgICAgICAgIHRoaXMuaW5pdENvbGxlY3Rpb25NZW51KHBsYW50X3RlbXBsYXRlcywgdW5sb2NrZWRfcGxhbnRzLCBncm93bl9wbGFudHMpO1xuICAgICAgICAgICAgdGhpcy5pbml0SGVscE1lbnUoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHNldFBsYXlCdXR0b25UZXh0KHN0cikge1xuICAgICAgICB0aGlzLnBsYXlfYnV0dG9uLmlubmVySFRNTCA9IHN0cjtcbiAgICB9XG4gICAgYWRkVGFiYmFibGVFbGVtZW50KGVsZW1lbnQsIGluZGV4KSB7XG4gICAgICAgIGVsZW1lbnQudGFiSW5kZXggPSBpbmRleDtcbiAgICAgICAgdGhpcy50YWJiYWJsZV9lbGVtZW50cy5wdXNoKGVsZW1lbnQpO1xuICAgIH1cbiAgICBjcmVhdGVCdXR0b24odGV4dCwgY2xhc3NfbmFtZSA9IG51bGwsIGluZGV4ID0gbnVsbCwgb25fY2xpY2sgPSBudWxsKSB7XG4gICAgICAgIGNvbnN0IGJ0biA9IHRoaXMuYnV0dG9uLmNsb25lTm9kZSgpO1xuICAgICAgICBidG4uY2xhc3NMaXN0LmFkZChjbGFzc19uYW1lKTtcbiAgICAgICAgYnRuLmlubmVySFRNTCA9IHRleHQ7XG4gICAgICAgIGlmIChpbmRleCkge1xuICAgICAgICAgICAgdGhpcy5hZGRUYWJiYWJsZUVsZW1lbnQoYnRuLCBpbmRleCk7XG4gICAgICAgIH1cbiAgICAgICAgYnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKG9uX2NsaWNrKSB7XG4gICAgICAgICAgICAgICAgb25fY2xpY2soKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBidG47XG4gICAgfVxuICAgIGNyZWF0ZUxpbmtCdXR0b24odGV4dCA9IFwiXCIsIGxpbmtfdG8gPSBcIlwiLCBjbGFzc19uYW1lID0gbnVsbCwgaW5kZXggPSBudWxsLCBvbl9jbGljayA9IG51bGwpIHtcbiAgICAgICAgY29uc3QgYnRuID0gdGhpcy5jcmVhdGVCdXR0b24odGV4dCwgY2xhc3NfbmFtZSwgaW5kZXgpO1xuICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgICAgICAgICBtYWluX2V2ZW50cy5vbl9yZXF1ZXN0X3Nob3dfbWVudS5lbWl0KGxpbmtfdG8pO1xuICAgICAgICAgICAgaWYgKG9uX2NsaWNrKSB7XG4gICAgICAgICAgICAgICAgb25fY2xpY2soKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBidG47XG4gICAgfVxuICAgIGNyZWF0ZVZpZXdCdXR0b24odGV4dCA9IFwiXCIsIGxpbmtfdG8sIGNsYXNzX25hbWUgPSBcIlwiLCBpbmRleCA9IG51bGwsIG9uX2NsaWNrID0gbnVsbCkge1xuICAgICAgICBjb25zdCBidG4gPSB0aGlzLmNyZWF0ZUJ1dHRvbih0ZXh0LCBjbGFzc19uYW1lLCBpbmRleCk7XG4gICAgICAgIGJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcbiAgICAgICAgICAgIG1haW5fZXZlbnRzLm9uX3JlcXVlc3Rfc2V0X3ZpZXcuZW1pdChsaW5rX3RvKTtcbiAgICAgICAgICAgIGlmIChvbl9jbGljaykge1xuICAgICAgICAgICAgICAgIG9uX2NsaWNrKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gYnRuO1xuICAgIH1cbiAgICBjcmVhdGVNZW51KGNsYXNzX25hbWUgPSBudWxsKSB7XG4gICAgICAgIGNvbnN0IG1lbnUgPSB0aGlzLm1lbnUuY2xvbmVOb2RlKCk7XG4gICAgICAgIG1lbnUuY2xhc3NMaXN0LmFkZChjbGFzc19uYW1lKTtcbiAgICAgICAgcmV0dXJuIG1lbnU7XG4gICAgfVxuICAgIHNob3dQbGFudE1lbnUocGxhbnRfdGVtcGxhdGUsIGlzX3BsYW50X2dyb3duKSB7XG4gICAgICAgIHRoaXMucGxhbnRfaW1hZ2Uuc3JjID0gaXNfcGxhbnRfZ3Jvd24gPyBnZXRQbGFudFRlbXBsYXRlRnVsbHlHcm93bkltYWdlVVJMKHBsYW50X3RlbXBsYXRlKSA6IHBsYW50X3RlbXBsYXRlLnN0YWdlc1swXS5pbWFnZV91cmw7XG4gICAgICAgIHRoaXMucGxhbnRfbmFtZS5pbm5lckhUTUwgPSBwbGFudF90ZW1wbGF0ZS5uYW1lO1xuICAgICAgICB0aGlzLnBsYW50X2Rlc2NyaXB0aW9uLmlubmVySFRNTCA9IHBsYW50X3RlbXBsYXRlLmRlc2NyaXB0aW9uO1xuICAgICAgICB0aGlzLnBsYW50X3N0YWdlcy5pbm5lckhUTUwgPSBcIjxiPlN0YWdlczogPC9iPlwiICsgcGxhbnRfdGVtcGxhdGUuc3RhZ2VzLmxlbmd0aDtcbiAgICAgICAgY29uc3QgdGltZV90b19ncm93X3NlY29uZHMgPSB0ZW1wbGF0ZVRpbWVUb0dyb3cocGxhbnRfdGVtcGxhdGUsIGdsb2JhbHMuc2Vjb25kc19wZXJfdGljayk7XG4gICAgICAgIGNvbnN0IHRpbWVfdG9fZ3Jvd19zdHIgPSBodW1hblJlYWRhYmxlVGltZUZyb21TZWNvbmRzKHRpbWVfdG9fZ3Jvd19zZWNvbmRzKTtcbiAgICAgICAgdGhpcy5wbGFudF90aW1lX3RvX2dyb3cuaW5uZXJIVE1MID0gXCI8Yj5UaW1lIHRvIGdyb3cgYXQgbWF4IHdhdGVyIGxldmVsOiA8L2I+XCIgKyB0aW1lX3RvX2dyb3dfc3RyO1xuICAgICAgICBjb25zdCB3YXRlcl9mcmVxdWVuY3lfc2Vjb25kcyA9IHRlbXBsYXRlV2F0ZXJpbmdGcmVxdWVuY3kocGxhbnRfdGVtcGxhdGUsIGdsb2JhbHMuc2Vjb25kc19wZXJfdGljayk7XG4gICAgICAgIGNvbnN0IHdhdGVyX2ZyZXF1ZW5jeV9zdHIgPSBodW1hblJlYWRhYmxlVGltZUZyb21TZWNvbmRzKHdhdGVyX2ZyZXF1ZW5jeV9zZWNvbmRzKTtcbiAgICAgICAgdGhpcy5wbGFudF93YXRlcl9mcmVxdWVuY3kuaW5uZXJIVE1MID0gXCI8Yj5NdXN0IGJlIHdhdGVyZWQgYXQgbGVhc3QgZXZlcnk6IDwvYj5cIiArIHdhdGVyX2ZyZXF1ZW5jeV9zdHI7XG4gICAgICAgIHRoaXMuY3VycmVudF9wbGFudF9pbl9tZW51ID0gcGxhbnRfdGVtcGxhdGU7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuc2hvd01lbnUoJ3BsYW50Jyk7XG4gICAgfVxuICAgIGRpc3BsYXlQcm9ncmVzc01lc3NhZ2UocGxhbnQsIHBsYW50X3RlbXBsYXRlcywgZmYgPSB0cnVlLCBncm93dGhfYmVmb3JlID0gbnVsbCwgZ3Jvd3RoX2FmdGVyID0gbnVsbCwgc2Vjb25kc19lbGFwc2VkID0gbnVsbCkge1xuICAgICAgICBsZXQgc2hvd19wbGFudF9idXR0b24gPSBmYWxzZTtcbiAgICAgICAgbGV0IG1lc3NhZ2UgPSBcIlwiO1xuICAgICAgICBjb25zdCB0aW1lID0gc2Vjb25kc1RvVGltZShzZWNvbmRzX2VsYXBzZWQpO1xuICAgICAgICBsZXQgaGFzX3RpbWUgPSB0aW1lLm0gPiAwO1xuICAgICAgICBpZiAoaGFzX3RpbWUgJiYgZmYpIHtcbiAgICAgICAgICAgIGNvbnN0IGdyb3d0aF9kaWZmZXJlbmNlID0gZ3Jvd3RoX2FmdGVyIC0gZ3Jvd3RoX2JlZm9yZTtcbiAgICAgICAgICAgIGxldCBncm93dGhfcGVyY2VudCA9IGdyb3d0aF9kaWZmZXJlbmNlIC8gcGxhbnQubWF4R3Jvd3RoKCkgKiAxMDA7XG4gICAgICAgICAgICBpZiAocGxhbnQuaXNGdWxseUdyb3duKCkpIHtcbiAgICAgICAgICAgICAgICBncm93dGhfcGVyY2VudCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBtZXNzYWdlID0gdGhpcy5wcm9ncmVzc01lc3NhZ2VUZXh0KHRpbWUsIGdyb3d0aF9wZXJjZW50KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmICghZmYpIHtcbiAgICAgICAgICAgIG1lc3NhZ2UgPSB0aGlzLnByb2dyZXNzTWVzc2FnZVRleHQoeyBoOiAwLCBtOiAwIH0sIHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHVubG9jayA9IGdldFRlbXBsYXRlVW5sb2NrKHBsYW50LnBsYW50X2lkLCBwbGFudF90ZW1wbGF0ZXMpO1xuICAgICAgICBpZiAocGxhbnQuaXNGdWxseUdyb3duKCkgJiYgdW5sb2NrKSB7XG4gICAgICAgICAgICBtZXNzYWdlICs9ICc8YnI+PGI+WW91IGhhdmUgdW5sb2NrZWQgYSBuZXcgcGxhbnQgLSAnICsgdW5sb2NrLm5hbWUgKyAnLiBXb3VsZCB5b3UgbGlrZSB0byBwbGFudCBpdD8nO1xuICAgICAgICAgICAgZ2xvYmFscy5yZWNlbnRseV91bmxvY2tlZCA9IHVubG9jay5wbGFudF9pZDtcbiAgICAgICAgICAgIHNob3dfcGxhbnRfYnV0dG9uID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc2hvd19wbGFudF9idXR0b24pIHtcbiAgICAgICAgICAgIHRoaXMucHJvZ3Jlc3NfbWVzc2FnZV9wbGFudC5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5wcm9ncmVzc19tZXNzYWdlX3BsYW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5wcm9ncmVzc19tZXNzYWdlLmlubmVySFRNTCA9IG1lc3NhZ2U7XG4gICAgICAgIHRoaXMucHJvZ3Jlc3NfbWVzc2FnZV9jb250YWluZXIuc3R5bGUuZGlzcGxheSA9ICdmbGV4JztcbiAgICAgICAgdGhpcy5wcm9ncmVzc19tZXNzYWdlX2NvbnRhaW5lci5mb2N1cygpO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBJZiB5b3Ugd2FudCB0byBpbmRpY2F0ZSB0aGF0IHRoZSBwbGFudCBoYXMgZnVsbHkgZ3Jvd24sIHBhc3MgJ3RydWUnIGZvciBgZ3Jvd3RoX3BlcmNlbnRhZ2VgXG4gICAgICovXG4gICAgcHJvZ3Jlc3NNZXNzYWdlVGV4dCh0aW1lLCBncm93dGhfcGVyY2VudGFnZSkge1xuICAgICAgICBjb25zdCBhd2F5X3N0ciA9IHRpbWUuaCA+IDAgfHwgdGltZS5tID4gMCA/ICdZb3Ugd2VyZSBhd2F5IGZvcicgOiAnJztcbiAgICAgICAgY29uc3QgaHJzX3N0ciA9IHRpbWUuaCA9PSAxID8gJzEgaG91cicgOiB0aW1lLmggPiAwID8gdGltZS5oICsgJyBob3VycycgOiAnJztcbiAgICAgICAgY29uc3QgbWluc19zdHIgPSB0aW1lLm0gPT0gMSA/ICcxIG1pbnV0ZScgOiB0aW1lLm0gPiAwID8gdGltZS5tICsgJyBtaW51dGVzJyA6ICcnO1xuICAgICAgICBjb25zdCBhbmRfc3RyID0gdGltZS5oID4gMCAmJiB0aW1lLm0gPiAwID8gJ2FuZCcgOiAnJztcbiAgICAgICAgY29uc3QgZ3Jvd3RoX3N0ciA9IHR5cGVvZiBncm93dGhfcGVyY2VudGFnZSA9PT0gJ2Jvb2xlYW4nID8gJ2Z1bGx5IGdyb3duJyA6ICdncm93biBieSAnICsgZ3Jvd3RoX3BlcmNlbnRhZ2UudG9GaXhlZCgyKSArICcgJSc7XG4gICAgICAgIHJldHVybiBgJHthd2F5X3N0cn0gJHtocnNfc3RyfSAke2FuZF9zdHJ9ICR7bWluc19zdHJ9ICR7YW5kX3N0cn0geW91ciBwbGFudCBoYXMgJHtncm93dGhfc3RyfWA7XG4gICAgfVxuICAgIGNhbGN1bGF0ZVBvc2l0aW9ucyhwbGFudCkge1xuICAgICAgICB0aGlzLndhdGVyX2J1dHRvbi5zdHlsZS50b3AgPSBwbGFudC5wb3NpdGlvbi55ICogY29uc3RhbnRzLnNjYWxlICsgMjAwICsgJ3B4JztcbiAgICAgICAgdGhpcy53YXRlcl9idXR0b24uc3R5bGUubGVmdCA9IHdpbmRvdy5pbm5lcldpZHRoIC8gMiArICdweCc7XG4gICAgfVxuICAgIHVwZGF0ZUNvbGxlY3Rpb25JbWFnZShwbGFudF90ZW1wbGF0ZSwgaXNfcGxhbnRfdW5sb2NrZWQsIGlzX3BsYW50X2dyb3duKSB7XG4gICAgICAgIGNvbnN0IGltZ19lbGVtZW50ID0gdGhpcy5jb2xsZWN0aW9uX2ltYWdlc1twbGFudF90ZW1wbGF0ZS5wbGFudF9pZF07XG4gICAgICAgIGNvbnN0IHBsYW50X2J1dHRvbiA9IGltZ19lbGVtZW50LmNsb3Nlc3QoJ2J1dHRvbicpO1xuICAgICAgICBpZiAoaXNfcGxhbnRfdW5sb2NrZWQpIHtcbiAgICAgICAgICAgIGxldCBzdGFnZSA9IDA7XG4gICAgICAgICAgICBpZiAoaXNfcGxhbnRfZ3Jvd24pIHtcbiAgICAgICAgICAgICAgICBzdGFnZSA9IGdldFRlbXBsYXRlTWF4U3RhZ2VJbmRleChwbGFudF90ZW1wbGF0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvL2NvbnN0IGltYWdlID0gdGhpcy5jYWNoZS5nZXQoJ2ltYWdlX2Jsb2JzLycgKyBwbGFudF90ZW1wbGF0ZS5wbGFudF9pZCArICcvJyArIG1heF9zdGFnZSlcbiAgICAgICAgICAgIGNvbnN0IGltYWdlX3VybCA9IHBsYW50X3RlbXBsYXRlLnN0YWdlc1tzdGFnZV0uaW1hZ2VfdXJsOyAvL1VSTC5jcmVhdGVPYmplY3RVUkwoaW1hZ2UpO1xuICAgICAgICAgICAgaW1nX2VsZW1lbnQuc3JjID0gaW1hZ2VfdXJsO1xuICAgICAgICAgICAgLy9DaGVjayBpZiB0ZXh0IGhhcyBhbHJlYWR5IGJlZW4gYWRkZWQgdG8gdGhlIGJ1dHRvblxuICAgICAgICAgICAgaWYgKCFwbGFudF9idXR0b24ucXVlcnlTZWxlY3RvcigncCcpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdGV4dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTtcbiAgICAgICAgICAgICAgICB0ZXh0LmlubmVySFRNTCA9IHBsYW50X3RlbXBsYXRlLm5hbWU7XG4gICAgICAgICAgICAgICAgcGxhbnRfYnV0dG9uLmFwcGVuZENoaWxkKHRleHQpO1xuICAgICAgICAgICAgICAgIC8vQWRkaXRpb25hbGx5IHdlIGNhbiBhZGQgdGhlIGV2ZW50IGxpc2V0ZW5lciwgYmVjYXVzZSB0aGlzIGFib3ZlIGlmIHN0YXRlbWVudFxuICAgICAgICAgICAgICAgIC8vd2lsbCBvbmx5IGJlIHRydWUgb25jZSwgd2hlbiB0aGUgcGxhbnQgaXNuJ3QgdW5sb2NrZWQgYW5kIHRoZXJlIGlzIG5vIHRleHRcbiAgICAgICAgICAgICAgICBwbGFudF9idXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2hvd1BsYW50TWVudShwbGFudF90ZW1wbGF0ZSwgaXNfcGxhbnRfZ3Jvd24pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgaW1nX2VsZW1lbnQuc3JjID0gJ2ltYWdlcy9xdWVzdGlvbi1tYXJrLmpwZWcnO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJlc2V0Q29sbGVjdGlvbkltYWdlcyhwbGFudF90ZW1wbGF0ZXMpIHtcbiAgICAgICAgZm9yIChjb25zdCB0ZW1wbGF0ZV9pZCBpbiBwbGFudF90ZW1wbGF0ZXMpIHtcbiAgICAgICAgICAgIGlmICh0ZW1wbGF0ZV9pZCAhPSAnYmFzaWNfcGxhbnQnKSB7XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVDb2xsZWN0aW9uSW1hZ2UocGxhbnRfdGVtcGxhdGVzW3RlbXBsYXRlX2lkXSwgZmFsc2UsIGZhbHNlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbn1cbiIsInZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIGZ1bmN0aW9uIGFkb3B0KHZhbHVlKSB7IHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIFAgPyB2YWx1ZSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUodmFsdWUpOyB9KTsgfVxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IGFkb3B0KHJlc3VsdC52YWx1ZSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuaW1wb3J0IG1haW5fZXZlbnRzIGZyb20gJy4vbWFpbl9ldmVudHMnO1xuaW1wb3J0IFBsYW50IGZyb20gJy4vUGxhbnQnO1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU2F2ZU1hbmFnZXIge1xuICAgIGNvbnN0cnVjdG9yKHN0b3JhZ2UsIGNhY2hlKSB7XG4gICAgICAgIHRoaXMuc3RvcmFnZSA9IHN0b3JhZ2U7XG4gICAgICAgIHRoaXMuY2FjaGUgPSBjYWNoZTtcbiAgICB9XG4gICAgc2F2ZURhdGEoZGF0YSkge1xuICAgICAgICAvL0lmIGN1c3RvbSBkYXRhIG9iamVjdCB3YXMgcGFzc2VkLCBzYXZlIHRoYXRcbiAgICAgICAgLy8gaWYoZGF0YSkge1xuICAgICAgICAvLyAgICAgdGhpcy5zdG9yYWdlLnNldCgnZGF0YScsIGRhdGEpXG4gICAgICAgIC8vICAgICByZXR1cm47XG4gICAgICAgIC8vIH1cbiAgICAgICAgLy9PdGhlcndpc2UgZ2V0IGN1cnJlbnQgcGxhbnRzIGFuZCBzYXZlIHRoZW1cbiAgICAgICAgdGhpcy51cGRhdGVDYWNoZWREYXRhKGRhdGEpO1xuICAgICAgICB0aGlzLnNldERhdGEodGhpcy5kYXRhKTtcbiAgICB9XG4gICAgdXBkYXRlQ2FjaGVkRGF0YShkYXRhKSB7XG4gICAgICAgIGlmIChkYXRhLnNlY29uZHNfcGVyX3RpY2sgIT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLmRhdGEucGFjZSA9IDEgLyBkYXRhLnNlY29uZHNfcGVyX3RpY2s7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRhdGEucGxhbnQgIT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLmRhdGEucGxhbnQgPSBkYXRhLnBsYW50LnRvSlNPTigpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhLm5ld19nYW1lICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMuZGF0YS5uZXdfZ2FtZSA9IGRhdGEubmV3X2dhbWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRhdGEudW5sb2NrZWRfcGxhbnRzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMuZGF0YS51bmxvY2tlZF9wbGFudHMgPSBkYXRhLnVubG9ja2VkX3BsYW50cztcbiAgICAgICAgfVxuICAgICAgICBpZiAoZGF0YS5ncm93bl9wbGFudHMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5kYXRhLmdyb3duX3BsYW50cyA9IGRhdGEuZ3Jvd25fcGxhbnRzO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZGF0YS5sZWF2ZV90aW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgfVxuICAgIHNldENhY2hlZERhdGEoZGF0YSkge1xuICAgICAgICB0aGlzLmRhdGEgPSBkYXRhO1xuICAgIH1cbiAgICBnZXREZWZhdWx0RGF0YSgpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IGJhc2ljX3BsYW50ID0geWllbGQgUGxhbnQuZnJvbVRlbXBsYXRlKDAsICdiYXNpY19wbGFudCcsIHRoaXMuY2FjaGUpO1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBwYWNlOiAxLFxuICAgICAgICAgICAgICAgIG1heF9pZDogMSxcbiAgICAgICAgICAgICAgICBsZWF2ZV90aW1lOiBudWxsLFxuICAgICAgICAgICAgICAgIHVubG9ja2VkX3BsYW50czogW1wiYmFzaWNfcGxhbnRcIl0sXG4gICAgICAgICAgICAgICAgZ3Jvd25fcGxhbnRzOiBbXSxcbiAgICAgICAgICAgICAgICBwbGFudDogYmFzaWNfcGxhbnQudG9KU09OKCksXG4gICAgICAgICAgICAgICAgbmV3X2dhbWU6IHRydWUsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgc2V0RGF0YVRvRGVmYXVsdHMoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBkYXRhID0geWllbGQgdGhpcy5nZXREZWZhdWx0RGF0YSgpO1xuICAgICAgICAgICAgdGhpcy5zZXREYXRhKGRhdGEpO1xuICAgICAgICAgICAgbWFpbl9ldmVudHMuYWZ0ZXJfZGF0YV9yZXNldC5lbWl0KCk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBzZXREYXRhKGRhdGEpIHtcbiAgICAgICAgdGhpcy5zZXRDYWNoZWREYXRhKGRhdGEpO1xuICAgICAgICB0aGlzLnN0b3JhZ2Uuc2V0KCdkYXRhJywgZGF0YSk7XG4gICAgfVxuICAgIHJlc2V0RGF0YSgpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIHlpZWxkIHRoaXMuc2V0RGF0YVRvRGVmYXVsdHMoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGdldERhdGEoKSB7XG4gICAgICAgIGlmICghdGhpcy5zdG9yYWdlLmhhcygnZGF0YScpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCByZXRyaWV2ZSBzYXZlIGRhdGE6IG5vIGRhdGEgaXMgc2V0Jyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuc3RvcmFnZS5nZXQoJ2RhdGEnKTtcbiAgICB9XG4gICAgc2V0RGF0YUlmTnVsbCgpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5zdG9yYWdlLmhhcygnZGF0YScpKSB7XG4gICAgICAgICAgICAgICAgeWllbGQgdGhpcy5zZXREYXRhVG9EZWZhdWx0cygpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGVmYXVsdF9kYXRhID0geWllbGQgdGhpcy5nZXREZWZhdWx0RGF0YSgpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGF0YSA9IE9iamVjdC5hc3NpZ24oT2JqZWN0LmFzc2lnbih7fSwgZGVmYXVsdF9kYXRhKSwgdGhpcy5nZXREYXRhKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgLyoqXG4gICAgICogUmV0dXJucyBob3cgbG9uZyB0aGUgdXNlciB3YXMgYXdheSAobm90IGluLWdhbWUgb3Igd2luZG93IG5vdCBmb2N1c2VkKVxuICAgICAqIEByZXR1cm5zXG4gICAgICovXG4gICAgZ2V0VGltZUF3YXkoKSB7XG4gICAgICAgIGxldCBjdXJyZW50X3RpbWVfbXMgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgICAgbGV0IHRpbWVfZGlmZmVyZW5jZV9tcyA9IGN1cnJlbnRfdGltZV9tcyAtIHRoaXMuZGF0YS5sZWF2ZV90aW1lO1xuICAgICAgICByZXR1cm4gdGhpcy5kYXRhLmxlYXZlX3RpbWUgPyAodGltZV9kaWZmZXJlbmNlX21zKSAvIDEwMDAgOiBudWxsO1xuICAgIH1cbn1cbiIsInZhciBfX2F3YWl0ZXIgPSAodGhpcyAmJiB0aGlzLl9fYXdhaXRlcikgfHwgZnVuY3Rpb24gKHRoaXNBcmcsIF9hcmd1bWVudHMsIFAsIGdlbmVyYXRvcikge1xuICAgIGZ1bmN0aW9uIGFkb3B0KHZhbHVlKSB7IHJldHVybiB2YWx1ZSBpbnN0YW5jZW9mIFAgPyB2YWx1ZSA6IG5ldyBQKGZ1bmN0aW9uIChyZXNvbHZlKSB7IHJlc29sdmUodmFsdWUpOyB9KTsgfVxuICAgIHJldHVybiBuZXcgKFAgfHwgKFAgPSBQcm9taXNlKSkoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBmdW5jdGlvbiBmdWxmaWxsZWQodmFsdWUpIHsgdHJ5IHsgc3RlcChnZW5lcmF0b3IubmV4dCh2YWx1ZSkpOyB9IGNhdGNoIChlKSB7IHJlamVjdChlKTsgfSB9XG4gICAgICAgIGZ1bmN0aW9uIHJlamVjdGVkKHZhbHVlKSB7IHRyeSB7IHN0ZXAoZ2VuZXJhdG9yW1widGhyb3dcIl0odmFsdWUpKTsgfSBjYXRjaCAoZSkgeyByZWplY3QoZSk7IH0gfVxuICAgICAgICBmdW5jdGlvbiBzdGVwKHJlc3VsdCkgeyByZXN1bHQuZG9uZSA/IHJlc29sdmUocmVzdWx0LnZhbHVlKSA6IGFkb3B0KHJlc3VsdC52YWx1ZSkudGhlbihmdWxmaWxsZWQsIHJlamVjdGVkKTsgfVxuICAgICAgICBzdGVwKChnZW5lcmF0b3IgPSBnZW5lcmF0b3IuYXBwbHkodGhpc0FyZywgX2FyZ3VtZW50cyB8fCBbXSkpLm5leHQoKSk7XG4gICAgfSk7XG59O1xuaW1wb3J0IGNvbnN0YW50cyBmcm9tICcuL2NvbnN0JztcbmltcG9ydCBJbWFnZUxvYWRlciBmcm9tICcuL0ltYWdlTG9hZGVyJztcbmltcG9ydCBNeUNhY2hlIGZyb20gJy4vTXlDYWNoZSc7XG5pbXBvcnQgTXlTdG9yYWdlIGZyb20gJy4vTXlTdG9yYWdlJztcbmltcG9ydCBQbGFudCBmcm9tICcuL1BsYW50JztcbmltcG9ydCBSZW5kZXJlciBmcm9tICcuL1JlbmRlcmVyJztcbmltcG9ydCBVSU1hbmFnZXIgZnJvbSAnLi9VSU1hbmFnZXInO1xuaW1wb3J0IHsgZ2V0Vmlld3BvcnRDZW50ZXIgfSBmcm9tICcuL3V0aWwnO1xuaW1wb3J0IFNhdmVNYW5hZ2VyIGZyb20gJy4vU2F2ZU1hbmFnZXInO1xuaW1wb3J0IG1haW5fZXZlbnRzIGZyb20gJy4vbWFpbl9ldmVudHMnO1xuaW1wb3J0IGdsb2JhbHMgZnJvbSAnLi9nbG9iYWxzJztcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEdhbWUge1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLnJlbmRlcmVyID0gbmV3IFJlbmRlcmVyKCdjYW52YXMnLCAndWknLCAnbWVudXMnKTtcbiAgICAgICAgdGhpcy5jYWNoZSA9IG5ldyBNeUNhY2hlKCk7XG4gICAgICAgIHRoaXMuc3RvcmFnZSA9IG5ldyBNeVN0b3JhZ2UoKTtcbiAgICAgICAgdGhpcy5kYXRhID0gbmV3IFNhdmVNYW5hZ2VyKHRoaXMuc3RvcmFnZSwgdGhpcy5jYWNoZSk7XG4gICAgICAgIHRoaXMudWkgPSBuZXcgVUlNYW5hZ2VyKHRoaXMucmVuZGVyZXIpO1xuICAgICAgICB0aGlzLmltYWdlX2xvYWRlciA9IG5ldyBJbWFnZUxvYWRlcih0aGlzLmNhY2hlKTtcbiAgICAgICAgdGhpcy5maXJzdF9pbml0ID0gZmFsc2U7IC8vV2hldGhlciB0aGlzIHRoZSBnYW1lIGhhcyBiZWVuIGluaXRpYWxpemVkIGF0IGxlYXN0IG9uY2VcbiAgICAgICAgdGhpcy5sYXN0X2ZyYW1lX3RpbWUgPSAwO1xuICAgICAgICB0aGlzLmRlbHRhID0gMDtcbiAgICAgICAgdGhpcy5kZWx0YV9zdW0gPSAwO1xuICAgICAgICB0aGlzLnBsYW50X3RlbXBsYXRlcyA9IHt9O1xuICAgICAgICB0aGlzLnBsYW50cyA9IHt9O1xuICAgICAgICB0aGlzLmxvYWRpbmcgPSB0cnVlO1xuICAgICAgICB0aGlzLmN1cnJlbnRfdmlldyA9IG51bGw7XG4gICAgICAgIG1haW5fZXZlbnRzLm9uX3JlcXVlc3RfZGF0YV9yZXNldC5vbih0aGlzLm9uUmVxdWVzdERhdGFSZXNldC5iaW5kKHRoaXMpKTtcbiAgICAgICAgbWFpbl9ldmVudHMub25fcmVxdWVzdF9kYXRhX3NhdmUub24odGhpcy5vblJlcXVlc3REYXRhU2F2ZS5iaW5kKHRoaXMpKTtcbiAgICAgICAgbWFpbl9ldmVudHMub25fcmVxdWVzdF9zaG93X21lbnUub24odGhpcy5vblJlcXVlc3RTaG93TWVudS5iaW5kKHRoaXMpKTtcbiAgICAgICAgbWFpbl9ldmVudHMub25fcmVxdWVzdF9zZXRfdmlldy5vbih0aGlzLm9uUmVxdWVzdFNldFZpZXcuYmluZCh0aGlzKSk7XG4gICAgICAgIG1haW5fZXZlbnRzLm9uX3JlcXVlc3RfZmFzdF9mb3J3YXJkLm9uKHRoaXMub25SZXF1ZXN0RmFzdEZvcndhcmQuYmluZCh0aGlzKSk7XG4gICAgICAgIG1haW5fZXZlbnRzLm9uX3JlcXVlc3RfcGxhbnRfbmV3X3BsYW50Lm9uKHRoaXMub25SZXF1ZXN0UGxhbnROZXdQbGFudC5iaW5kKHRoaXMpKTtcbiAgICAgICAgbWFpbl9ldmVudHMub25fcmVxdWVzdF93YXRlcl9wbGFudC5vbih0aGlzLm9uUmVxdWVzdFdhdGVyUGxhbnQuYmluZCh0aGlzKSk7XG4gICAgICAgIG1haW5fZXZlbnRzLmFmdGVyX2RhdGFfcmVzZXQub24odGhpcy5hZnRlckRhdGFSZXNldC5iaW5kKHRoaXMpKTtcbiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2ZvY3VzJywgKCkgPT4ge1xuICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudF92aWV3ID09ICdwbGFudCcgJiYgIXRoaXMuZGF0YS5kYXRhLm5ld19nYW1lKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mYXN0Rm9yd2FyZEJ5U2Vjb25kcyh0aGlzLmRhdGEuZ2V0VGltZUF3YXkoKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnJlbmRlcmVyLmhpZGVVSSgpO1xuICAgIH1cbiAgICBvblJlcXVlc3REYXRhUmVzZXQoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBjb25zdCBjb25maXJtX3Jlc2V0ID0gY29uZmlybSgnQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIHJlc2V0IGFsbCBkYXRhPyBQbGFudCBkYXRhIGFuZCBjb2xsZWN0aW9uIHdpbGwgYmUgbG9zdCcpO1xuICAgICAgICAgICAgaWYgKCFjb25maXJtX3Jlc2V0KVxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIHlpZWxkIHRoaXMuZGF0YS5yZXNldERhdGEoKTtcbiAgICAgICAgICAgIHlpZWxkIHRoaXMuaW5pdCgpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgYWZ0ZXJEYXRhUmVzZXQoKSB7XG4gICAgICAgIGlmICh0aGlzLnVpLnBsYXlfYnV0dG9uKSB7XG4gICAgICAgICAgICB0aGlzLnVpLnNldFBsYXlCdXR0b25UZXh0KCdOZXcgR2FtZScpO1xuICAgICAgICB9XG4gICAgfVxuICAgIG9uUmVxdWVzdERhdGFTYXZlKCkge1xuICAgICAgICB0aGlzLmRhdGEuc2F2ZURhdGEoe1xuICAgICAgICAgICAgc2Vjb25kc19wZXJfdGljazogZ2xvYmFscy5zZWNvbmRzX3Blcl90aWNrLFxuICAgICAgICAgICAgcGxhbnQ6IHRoaXMucGxhbnRcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIG9uUmVxdWVzdFNob3dNZW51KG1lbnVfaWQpIHtcbiAgICAgICAgdGhpcy5zZXRWaWV3KG51bGwpO1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnNob3dNZW51KG1lbnVfaWQpO1xuICAgIH1cbiAgICBvblJlcXVlc3RTZXRWaWV3KHZpZXdfaWQpIHtcbiAgICAgICAgdGhpcy5zZXRWaWV3KHZpZXdfaWQpO1xuICAgIH1cbiAgICBvblJlcXVlc3RGYXN0Rm9yd2FyZCgpIHtcbiAgICAgICAgdGhpcy5mYXN0Rm9yd2FyZEJ5U2Vjb25kcyh0aGlzLmRhdGEuZ2V0VGltZUF3YXkoKSk7XG4gICAgfVxuICAgIG9uUmVxdWVzdFdhdGVyUGxhbnQoKSB7XG4gICAgICAgIHRoaXMud2F0ZXJDdXJyZW50UGxhbnQoKTtcbiAgICB9XG4gICAgb25SZXF1ZXN0UGxhbnROZXdQbGFudCh0ZW1wbGF0ZV9pZCkge1xuICAgICAgICB0aGlzLnBsYW50TmV3UGxhbnQodGVtcGxhdGVfaWQpO1xuICAgIH1cbiAgICBpbml0KCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgdGhpcy5zZXRMb2FkaW5nKHRydWUpO1xuICAgICAgICAgICAgeWllbGQgdGhpcy5pbml0VGVtcGxhdGVzKCk7XG4gICAgICAgICAgICB5aWVsZCB0aGlzLmluaXRJbWFnZXMoKTtcbiAgICAgICAgICAgIHlpZWxkIHRoaXMuZGF0YS5zZXREYXRhSWZOdWxsKCk7XG4gICAgICAgICAgICB0aGlzLmluaXRUZW1wbGF0ZUltYWdlVVJMcygpO1xuICAgICAgICAgICAgZ2xvYmFscy5zZWNvbmRzX3Blcl90aWNrID0gMSAvIHRoaXMuZGF0YS5kYXRhLnBhY2U7XG4gICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuY2FsY3VsYXRlUG9zaXRpb25zKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHRoaXMuZGF0YS5kYXRhKTtcbiAgICAgICAgICAgIGlmICghdGhpcy5maXJzdF9pbml0KSB7XG4gICAgICAgICAgICAgICAgeWllbGQgdGhpcy51aS5pbml0VWkodGhpcy5wbGFudF90ZW1wbGF0ZXMsIHRoaXMuZGF0YS5kYXRhLnVubG9ja2VkX3BsYW50cywgdGhpcy5kYXRhLmRhdGEuZ3Jvd25fcGxhbnRzLCB0aGlzLmRhdGEuZGF0YS5uZXdfZ2FtZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5maXJzdF9pbml0ID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHlpZWxkIHRoaXMuaW5pdFBsYW50cygpO1xuICAgICAgICAgICAgdGhpcy5jYWxjdWxhdGVQb3NpdGlvbnMoKTtcbiAgICAgICAgICAgIHRoaXMuc2V0TG9hZGluZyhmYWxzZSk7XG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnNob3dNZW51KCdtYWluJyk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBpbml0SW1hZ2VzKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgZm9yIChjb25zdCB0ZW1wbGF0ZV9pZCBpbiB0aGlzLnBsYW50X3RlbXBsYXRlcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRlbXBsYXRlID0gdGhpcy5wbGFudF90ZW1wbGF0ZXNbdGVtcGxhdGVfaWRdO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGVtcGxhdGUuc3RhZ2VzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHlpZWxkIHRoaXMuaW1hZ2VfbG9hZGVyLmxvYWRUZW1wbGF0ZUltYWdlSWZOdWxsKHRlbXBsYXRlLnBsYW50X2lkLCBpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBpbml0UGxhbnRzKCkge1xuICAgICAgICByZXR1cm4gX19hd2FpdGVyKHRoaXMsIHZvaWQgMCwgdm9pZCAwLCBmdW5jdGlvbiogKCkge1xuICAgICAgICAgICAgY29uc3QgcGxhbnQgPSB5aWVsZCBQbGFudC5mcm9tSlNPTih0aGlzLmRhdGEuZGF0YS5wbGFudCwgdGhpcy5jYWNoZSk7XG4gICAgICAgICAgICB0aGlzLnNldFBsYW50KHBsYW50KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGluaXRUZW1wbGF0ZXMoKSB7XG4gICAgICAgIHJldHVybiBfX2F3YWl0ZXIodGhpcywgdm9pZCAwLCB2b2lkIDAsIGZ1bmN0aW9uKiAoKSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IHRlbXBsYXRlX2lkIG9mIGNvbnN0YW50cy5wbGFudF90ZW1wbGF0ZV9pZHMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCByZXMgPSB5aWVsZCBmZXRjaCgncGxhbnRfdGVtcGxhdGVzLycgKyB0ZW1wbGF0ZV9pZCArICcuanNvbicpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGpzb24gPSB5aWVsZCByZXMuanNvbigpO1xuICAgICAgICAgICAgICAgIHRoaXMucGxhbnRfdGVtcGxhdGVzW3RlbXBsYXRlX2lkXSA9IGpzb247XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBpbml0VGVtcGxhdGVJbWFnZVVSTHMoKSB7XG4gICAgICAgIGZvciAoY29uc3QgdGVtcGxhdGVfaWQgaW4gdGhpcy5wbGFudF90ZW1wbGF0ZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IHRlbXBsYXRlID0gdGhpcy5wbGFudF90ZW1wbGF0ZXNbdGVtcGxhdGVfaWRdO1xuICAgICAgICAgICAgZm9yIChjb25zdCBpIGluIHRlbXBsYXRlLnN0YWdlcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGltYWdlID0gdGhpcy5jYWNoZS5nZXQoJ2ltYWdlX2Jsb2JzLycgKyB0ZW1wbGF0ZS5wbGFudF9pZCArICcvJyArIGkpO1xuICAgICAgICAgICAgICAgIHRlbXBsYXRlLnN0YWdlc1tpXS5pbWFnZV91cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGltYWdlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICBvblBsYW50RnVsbHlHcm93bihwbGFudCkge1xuICAgICAgICB0aGlzLnVpLmRpc3BsYXlQcm9ncmVzc01lc3NhZ2UodGhpcy5wbGFudCwgdGhpcy5wbGFudF90ZW1wbGF0ZXMsIGZhbHNlKTtcbiAgICAgICAgdGhpcy5kYXRhLnNhdmVEYXRhKHtcbiAgICAgICAgICAgIHBsYW50OiB0aGlzLnBsYW50LFxuICAgICAgICAgICAgdW5sb2NrZWRfcGxhbnRzOiBbLi4udGhpcy5kYXRhLmRhdGEudW5sb2NrZWRfcGxhbnRzLCBwbGFudC51bmxvY2tzXSxcbiAgICAgICAgICAgIGdyb3duX3BsYW50czogWy4uLnRoaXMuZGF0YS5kYXRhLmdyb3duX3BsYW50cywgcGxhbnQucGxhbnRfaWRdXG4gICAgICAgIH0pO1xuICAgICAgICBpZiAocGxhbnQudW5sb2Nrcykge1xuICAgICAgICAgICAgY29uc3QgdW5sb2NrZWRfdGVtcGxhdGUgPSB0aGlzLnBsYW50X3RlbXBsYXRlc1twbGFudC51bmxvY2tzXTtcbiAgICAgICAgICAgIHRoaXMudWkudXBkYXRlQ29sbGVjdGlvbkltYWdlKHVubG9ja2VkX3RlbXBsYXRlLCB0cnVlLCBmYWxzZSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy51aS51cGRhdGVDb2xsZWN0aW9uSW1hZ2UodGhpcy5wbGFudF90ZW1wbGF0ZXNbcGxhbnQucGxhbnRfaWRdLCB0cnVlLCB0cnVlKTtcbiAgICB9XG4gICAgZmFzdEZvcndhcmRCeVNlY29uZHMoc2Vjb25kcykge1xuICAgICAgICBpZiAodGhpcy5kYXRhLmRhdGEubmV3X2dhbWUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXNlY29uZHMpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBncm93dGhfYmVmb3JlID0gdGhpcy5wbGFudC5ncm93dGg7XG4gICAgICAgIGNvbnN0IHRpY2tzID0gdGhpcy5nZXRUaWNrc0J5U2Vjb25kcyhzZWNvbmRzKTtcbiAgICAgICAgdGhpcy5wbGFudC5mYXN0Rm9yd2FyZCh0aWNrcyk7XG4gICAgICAgIGNvbnN0IGdyb3d0aF9hZnRlciA9IHRoaXMucGxhbnQuZ3Jvd3RoO1xuICAgICAgICB0aGlzLnVpLmRpc3BsYXlQcm9ncmVzc01lc3NhZ2UodGhpcy5wbGFudCwgdGhpcy5wbGFudF90ZW1wbGF0ZXMsIHRydWUsIGdyb3d0aF9iZWZvcmUsIGdyb3d0aF9hZnRlciwgc2Vjb25kcyk7XG4gICAgfVxuICAgIGdldFRpY2tzQnlTZWNvbmRzKHNlY29uZHMpIHtcbiAgICAgICAgcmV0dXJuIHNlY29uZHMgLyBnbG9iYWxzLnNlY29uZHNfcGVyX3RpY2s7XG4gICAgfVxuICAgIHNldFZpZXcodmlld19uYW1lKSB7XG4gICAgICAgIHRoaXMuY3VycmVudF92aWV3ID0gdmlld19uYW1lO1xuICAgICAgICBpZiAodmlld19uYW1lKSB7XG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLmhpZGVNZW51KCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHZpZXdfbmFtZSA9PSAncGxhbnQnKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5kYXRhLmRhdGEubmV3X2dhbWUgPT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZGF0YS5zYXZlRGF0YSh7XG4gICAgICAgICAgICAgICAgICAgIG5ld19nYW1lOiBmYWxzZVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRoaXMudWkuc2V0UGxheUJ1dHRvblRleHQoJ015IFBsYW50Jyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgY2FsY3VsYXRlUG9zaXRpb25zKCkge1xuICAgICAgICB0aGlzLnBsYW50LnNldFBvc2l0aW9uKGdldFZpZXdwb3J0Q2VudGVyKCkpO1xuICAgICAgICB0aGlzLnVpLmNhbGN1bGF0ZVBvc2l0aW9ucyh0aGlzLnBsYW50KTtcbiAgICB9XG4gICAgc2V0TG9hZGluZyhsb2FkaW5nKSB7XG4gICAgICAgIHRoaXMubG9hZGluZyA9IGxvYWRpbmc7XG4gICAgICAgIGlmICh0aGlzLmxvYWRpbmcpIHtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyZXIudWkuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgICAgIGlmICh0aGlzLnJlbmRlcmVyLm1lbnUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyLmN1cnJlbnRNZW51KCkuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsb2FkaW5nJykuc3R5bGUuZGlzcGxheSA9ICdmbGV4JztcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnJlbmRlcmVyLm1lbnUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyLmN1cnJlbnRNZW51KCkuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcmVyLnVpLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xvYWRpbmcnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgICAgICB9XG4gICAgfVxuICAgIHN0YXJ0KCkge1xuICAgICAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMuZ2FtZUxvb3AuYmluZCh0aGlzKSk7XG4gICAgfVxuICAgIHRpY2soKSB7XG4gICAgICAgIHRoaXMuZGF0YS5zYXZlRGF0YSh7XG4gICAgICAgICAgICBwbGFudDogdGhpcy5wbGFudFxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5wbGFudC50aWNrKCk7XG4gICAgfVxuICAgIGRyYXcoKSB7XG4gICAgICAgIHRoaXMucmVuZGVyZXIuY2xlYXIoKTtcbiAgICAgICAgaWYgKCF0aGlzLmxvYWRpbmcgJiYgIXRoaXMucmVuZGVyZXIubWVudSAmJiB0aGlzLmN1cnJlbnRfdmlldyA9PSAncGxhbnQnKSB7XG4gICAgICAgICAgICB0aGlzLnJlbmRlcmVyLmRyYXdQbGFudCh0aGlzLnBsYW50KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB3YXRlckN1cnJlbnRQbGFudCgpIHtcbiAgICAgICAgdGhpcy5wbGFudC53YXRlcl9sZXZlbC50b3AoKTtcbiAgICAgICAgdGhpcy5wbGFudC51cGRhdGVXYXRlckxldmVsQmFyKCk7XG4gICAgfVxuICAgIGdhbWVMb29wKCkge1xuICAgICAgICB0aGlzLmNhbGN1bGF0ZURlbHRhU3VtKCk7XG4gICAgICAgIGlmICh0aGlzLmRlbHRhX3N1bSA+IGdsb2JhbHMuc2Vjb25kc19wZXJfdGljayAmJiAhdGhpcy5sb2FkaW5nICYmIHRoaXMuY3VycmVudF92aWV3ID09ICdwbGFudCcpIHtcbiAgICAgICAgICAgIHRoaXMudGljaygpO1xuICAgICAgICAgICAgdGhpcy5kZWx0YV9zdW0gPSAwO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZHJhdygpO1xuICAgICAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMuZ2FtZUxvb3AuYmluZCh0aGlzKSk7XG4gICAgfVxuICAgIGNhbGN1bGF0ZURlbHRhU3VtKCkge1xuICAgICAgICBjb25zdCBjdXJyZW50X3RpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTtcbiAgICAgICAgdGhpcy5kZWx0YSA9IChjdXJyZW50X3RpbWUgLSB0aGlzLmxhc3RfZnJhbWVfdGltZSkgLyAxMDAwO1xuICAgICAgICB0aGlzLmxhc3RfZnJhbWVfdGltZSA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgICAgICB0aGlzLmRlbHRhX3N1bSArPSB0aGlzLmRlbHRhO1xuICAgIH1cbiAgICAvLyBjcmVhdGVQbGFudChwbGFudDogUGxhbnQpIHtcbiAgICAvLyAgICAgdGhpcy5wbGFudHNbcGxhbnQuaWRdID0gcGxhbnQ7XG4gICAgLy8gfVxuICAgIHBsYW50TmV3UGxhbnQodGVtcGxhdGVfaWQpIHtcbiAgICAgICAgcmV0dXJuIF9fYXdhaXRlcih0aGlzLCB2b2lkIDAsIHZvaWQgMCwgZnVuY3Rpb24qICgpIHtcbiAgICAgICAgICAgIGNvbnN0IHBsYW50ID0geWllbGQgUGxhbnQuZnJvbVRlbXBsYXRlKCdteV9wbGFudCcsIHRlbXBsYXRlX2lkLCB0aGlzLmNhY2hlKTtcbiAgICAgICAgICAgIHRoaXMuc2V0UGxhbnQocGxhbnQpO1xuICAgICAgICAgICAgdGhpcy5zZXRWaWV3KCdwbGFudCcpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgc2V0UGxhbnQocGxhbnQpIHtcbiAgICAgICAgdGhpcy5wbGFudCA9IHBsYW50O1xuICAgICAgICB0aGlzLnBsYW50Lm9uRnVsbHlHcm93bih0aGlzLm9uUGxhbnRGdWxseUdyb3duLmJpbmQodGhpcykpO1xuICAgIH1cbiAgICB1bmxvY2tBbGwoKSB7XG4gICAgICAgIHRoaXMuZGF0YS5zYXZlRGF0YSh7XG4gICAgICAgICAgICB1bmxvY2tlZF9wbGFudHM6IFsuLi5jb25zdGFudHMucGxhbnRfdGVtcGxhdGVfaWRzXVxuICAgICAgICB9KTtcbiAgICAgICAgYWxlcnQoJ0FsbCBwbGFudHMgaGF2ZSBiZWVuIHVubG9ja2VkLCBwbGVhc2UgcmVmcmVzaCB0aGUgcGFnZScpO1xuICAgIH1cbn1cbiIsImltcG9ydCBHYW1lIGZyb20gJy4vR2FtZSc7XG5jb25zdCBnYW1lID0gbmV3IEdhbWUoKTtcbmdhbWUuaW5pdCgpLnRoZW4oKCkgPT4ge1xuICAgIGdhbWUuc3RhcnQoKTtcbn0pO1xud2luZG93LmdhbWUgPSBnYW1lO1xuIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9\n//# sourceURL=webpack-internal:///680\n")}},__webpack_require__={r:g=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(g,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(g,"__esModule",{value:!0})}},__webpack_exports__={};__webpack_modules__[680](0,__webpack_exports__,__webpack_require__);var __webpack_export_target__=this;for(var i in __webpack_exports__)__webpack_export_target__[i]=__webpack_exports__[i];__webpack_exports__.__esModule&&Object.defineProperty(__webpack_export_target__,"__esModule",{value:!0})})();